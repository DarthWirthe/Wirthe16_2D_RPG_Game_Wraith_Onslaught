local a=require("term")local b=require("event")local c=require("G_image")local d=require("G_thread")local f=require("unicode")local g=require("computer")local h=require("keyboard")local i=require("filesystem")local j=require("serialization")local k=require("G_doubleBuffering")local l=require("component")local m=l.gpu;local n,o,p,q,r,s=table.insert,table.remove,math.floor,math.ceil,math.min,math.max;local t,u=m.maxResolution()local v={_function={},_config={debugMode=true,unitDrawingDistance=85,startWeapon={[1]=7,[2]=124},reservedItemId=200,maxSkillLevel=7},_parameter={lootItemImprovedChance=25,physicalDamageReductionMul=30,magicalDamageReductionMul=30,intRegenMultiplier=0.22,survRegenMultiplier=0.21,healthPotionEffectID=1,manaPotionEffectID=2,inventorySize=20,keys={left1=203,left2=30,right1=205,right2=32,openInventory=48,closeInventory=48,interact=18,jump=57,spawn=24,followerAction=37,hp=20,mp=21}},_data={windowThread=nil,stopDrawing=false,inGame=true,paused=false,itemIcons,maxItemID,potralUnitId=43,itemInfo={},text={directory="/games/testgame/",logFile="log.txt",screen1="Загрузка...",warning=""},pauseMenuList={"Продолжить игру","Инвентарь","Умения персонажа","Характеристика","Текущие задания","Сохранить","Загрузить","Выйти из игры"},skillType={[1]="Атака",[2]="Пассивный",[3]="Бафф",[4]="Специальный"},armorType={"helmet","pendant","armor","robe","pants","weapon","footwear","ring"},itemStatsNames={["hp+"]={"Здоровье"},["mp+"]={"Мана"},["sur+"]={"Выносливость"},["str+"]={"Сила"},["int+"]={"Магия"},["agi+"]={"Ловкость"},["pdm+"]={"Физическая атака"},["mdm+"]={"Магическая атака"},["pdf+"]={"Физическая защита"},["mdf+"]={"Магическая защита"},["chc+"]={"Вероятность нанесения критического удара","%"},["hp%"]={"Максимальное здоровье","%"},["mp%"]={"Максимальная мана","%"}},itemReqNames={["lvl"]="Требуемый уровень: ",["strg"]="Требуемая сила: ",["int"]="Требуемая магия: ",["agi"]="Требуемая ловкость: "},itemSubtypes={[2]={[1]="Накидка",[2]="Кольцо",[3]="Кулон",[4]="Шлем",[5]="Броня",[6]="Поножи",[7]="Сапоги",[8]="Капюшон",[9]="Мантия",[10]="Магические поножи",[11]="Магические сапоги"},[3]={[1]="Меч",[2]="Копьё",[3]="Короткая секира",[4]="Магический жезл"}},armorTypeIds={["helmet"]={4,8},["armor"]={5,9},["pants"]={6,10},["footwear"]={7,11},["pendant"]={3},["robe"]={1},["ring"]={2}},emptyArmorPic={[1]={"helmet","image/gigd1.pic"},[2]={"armor","image/gigd2.pic"},[3]={"pants","image/gigd3.pic"},[4]={"footwear","image/gigd4.pic"},[5]={"weapon","image/gigd5.pic"},[6]={"pendant","image/gigd6.pic"},[7]={"robe","image/gigd7.pic"},[8]={"ring","image/gigd8.pic"}},armorPhysicalDefenceMultiple={[1]=30.6,[2]=8.3,[3]=19.5,[4]=38.2,[5]=40.4,[6]=38.7,[7]=37.3,[8]=14.2,[9]=23.8,[10]=21.1,[11]=11.4},armorMagicalDefenceMultiple={[1]=32.8,[2]=24.7,[3]=27.5,[4]=15.4,[5]=26.3,[6]=23.8,[7]=11.5,[8]=37.9,[9]=39.9,[10]=38.6,[11]=36.9},messageTable1={"",""},messageTable1timer=0},_player={id=1,gudId=1,class=1,name="",statsPoints={vSur=0,vStr=0,vAgi=0,vInt=0,vPdm=0,vMdm=0},screenPosition=75,pckTarget=nil,pickingUp=false,maxPckTime=0,pckTime=0,imageChanged=false,moving=false,critChance=1,healthReg=0,manaReg=0,regenMultiplier=0,coins=0,actSkills={1,2,3,4,0,0,0,0},skills={},quests={},updStats={["sur+"]=0,["str+"]=0,["int+"]=0,["agi+"]=0,["hp+"]=0,["mp+"]=0,["vPdm1"]=0,["pdm+"]=0,["mdm+"]=0,["vMdm1"]=0,["vPdm2"]=0,["vMdm2"]=0,["pdf+"]=0,["mdf+"]=0,["chc+"]=0,["hp%"]=0,["mp%"]=0,["pwd%"]=0,["mwd%"]=0,["weaponDistance"]=0}},_gui={blank={},mainMenu={},pauseMenu={x=1,y=1,w=30,h=50,buttonX=156,buttonY=2,buttonFunction={},action={}},NPCDialog={currentDialog=nil,text=""},playerSkills={window={x=20,y=5,w=120,h=40,title="Умения"},targ=0,text1={},text2={},text3={},action={}},playerStats={window={x=50,y=12,w=60,h=25,title="Персонаж"},x1=53,y1=26,info={},selectedPoints={0,0,0,0,0},action={}},questsList={window={x=30,y=12,w=100,h=30,title="Задания"},targetQuest=0,action={}},skillsTopPanel={x=115,y=1,w=38,h=5,action={},t={{c=0x614251,t="/2"},{c=0x0000FF,t="*3"},{c=0x008500,t="@4"},{c=0x8600A0,t="&5"},{c=0xEE0000,t="!6"},{c=0xFF00FF,t="^7"},{c=0x0000EE,t="%8"}}}}}v._gui.mainMenu={w=25,h=20,bx=2,bh=3,action={},imgx=4,imgy=2,obj={},mode=0,[1]={w=50,h=20,class=1,obj={[1]={type=1,x=30,y=14,w=15,h=3,bcolor=0x838383,fcolor=0xcccccc,txt="Продолжить",action=function()if f.len(v._gui.mainMenu[1].obj[4].txt)>=5 then if v._gui.mainMenu[1].class==1 then v._player.gudId=1;v._player.class=1 elseif v._gui.mainMenu[1].class==2 then v._player.gudId=122;v._player.class=2 end;v._player.name=v._gui.mainMenu[1].obj[4].txt;v._function.initGame()end end},[2]={type=1,x=5,y=14,w=15,h=3,bcolor=0x838383,fcolor=0xcccccc,txt="Назад",action=function()v._gui.mainMenu.mode=0 end},[3]={type=2,x=5,y=5,w=40,h=1,bcolor=0x838383,fcolor=0xcccccc,txt="Имя содержит 6 - 18 символов:"},[4]={type=2,x=5,y=6,w=40,h=1,bcolor=0x222222,fcolor=0xffffff,txt=""},[5]={type=1,x=5,y=10,w=15,h=3,bcolor=0x555555,ccolor=0x22cc55,fcolor=0xcccccc,clicked=1,txt="Воин",action=function()v._gui.mainMenu[1].obj[5].clicked=1;v._gui.mainMenu[1].obj[6].clicked=0;v._gui.mainMenu[1].class=1 end},[6]={type=1,x=30,y=10,w=15,h=3,bcolor=0x555555,ccolor=0x22cc55,fcolor=0xcccccc,clicked=0,txt="Маг",action=function()v._gui.mainMenu[1].obj[6].clicked=1;v._gui.mainMenu[1].obj[5].clicked=0;v._gui.mainMenu[1].class=2 end},[7]={type=2,x=5,y=8,w=40,h=1,bcolor=0x838383,fcolor=0xcccccc,txt="Выберите класс:"}}},[2]={w=80,h=30,buff={},targ=nil,obj={[1]={type=1,x=10,y=25,w=20,h=3,bcolor=0x838383,fcolor=0xcccccc,txt="Назад",action=function()v._gui.mainMenu.mode=0 end},[2]={type=1,x=50,y=25,w=20,h=3,bcolor=0x838383,fcolor=0xcccccc,txt="Загрузить",action=function()if v._gui.mainMenu[2].targ then v._function.loadGame(v._data.text.directory.."saves",v._gui.mainMenu[2].buff[v._gui.mainMenu[2].targ])v._gui.mainMenu.obj={}end end}}}}local w="Загрузка..."local x=false;local y=0x222222;local z={white=0xffffff,blue=0x00aaff,magenta=0x996dbf,golden=0xffff00,orange=0xffb420,green=0xff9200}local A,B=1,1;local C=0;local D={}local E;local F,G,H,I,J,K,L,M;local N;local O={}local P={}local Q={}local R={}local S={}local T={[1]={["basehp"]=45,["basemp"]=28,["levelhpmul"]=28,["levelmpmul"]=7,["surhpmul"]=15,["intmpmul"]=6,["skills"]={{1,0,1},{2,0,1},{3,0,1},{4,0,1},{5,0,0},{6,0,0},{7,0,0},{8,0,0},{9,0,0},{10,0,0}}},[2]={["basehp"]=30,["basemp"]=42,["levelhpmul"]=18,["levelmpmul"]=24,["surhpmul"]=12,["intmpmul"]=15,["skills"]={{1,0,1},{11,0,1},{12,0,1},{13,0,1},{14,0,0},{15,0,0},{17,0,0},{18,0,0},{16,0,0}}}}v._function.watds={[1]=10,[2]=12,[3]=10,[4]=3}local U={[1]=0.9,[2]=1,[3]=1.2,[4]=1}local V=_G.error;v._function.version={1,2,8,2}local W,X,Y=0,0;local Z={"Разрешение экрана только 160х50","DoubleBuffering lib — автор IgorTimofeev","Image lib, Сolor lib — автор IgorTimofeev","Thread lib — автор Zer0Galaxy"}local function _()for a0=1,#Z do k.drawText(2,48-#Z+a0,0xA7A7A7,Z[a0])end end;local function a1()local a2,a3,a4=20,1,0.001;local a5=c.load(v._data.text.directory.."image/slg.pic")for a0=1,a2 do k.drawRectangle(1,1,t,u,y,0," ")k.drawText(2,2,0xA7A7A7,v._data.text.screen1)a2,a3=80-p(a5[1]/2),25-p(a5[2]/2)if a0==19 then a2=a2-1;a3=a3+1 end;if a0==24 then a2=a2+1;a3=a3-1 end;k.drawImage(a2,a3,a5)_()k.drawChanges()os.sleep(a4)end;k.drawText(2,2,0xA7A7A7,v._data.text.screen1)local a6=q(g.totalMemory()/1048576*10)/10;if t<160 or u<50 then x=true;v._data.text.warning='Текущее разрешение экрана не соответствует требуемому.'end;if a6>0 and a6<1.8 then x=true;v._data.text.warning=v._data.text.warning..' оперативной памяти ('..a6 ..' МБ) недостаточно для нормальной работы программы.'end end;function v._function.RAMInfo()return tostring(p((g.totalMemory()-g.freeMemory())/1024)).." KB/"..tostring(q(g.totalMemory()/1048576*10)/10).." MB"end;local function a7(a8)local a9=io.open(a8,'r')local aa={}for ab in a9:lines()do if ab:sub(-1)=="\r"then ab=ab:sub(1,-2)end;n(aa,ab)end;a9:close()return aa end;function v._function.getVersion()return"Версия "..v._function.version[1].."."..v._function.version[2].."."..v._function.version[3].." Обновление "..v._function.version[4]end;local function ac(a8,ad)local a9=io.open(a8,'a')a9:write((ad or"").."\n")a9:close()end;function v._function.logtxt(text)ac(v._data.text.directory..v._data.text.logFile,text)end;_G.error=function(text)v._data.inGame=false;d.killAll()local a9=io.open(v._data.text.directory..v._data.text.logFile,'a')if type(text)==table then for ae=1,#text do a9:write((tostring(text[ae])or"").."\n")end else a9:write((tostring(text)or"").."\n")end;a9:close()os.sleep(1)m.setBackground(0x222222)m.setForeground(0xffffff)a.clear()a.setCursor(1,2)io.write("Текст ошибки сохранён в файл log.txt\n")io.write("Ошибка:\n")if type(text)==table then for ae=1,#text do io.write(tostring(text[ae]).."\n")end else io.write(tostring(text).."\n")end;_G.error=V;V=nil;m.setForeground(0xffffff)io.write("Для продолжения нажмите любую клавишу...")while true do local af=table.pack(b.pull())if af[1]=="key_down"then g.shutdown(true)break end end end;function v._function.dofile(a8)local a9=io.open(a8)local ag=a9:read("*all")a9:close()local ah,ai=pcall(load(ag))if not ah then v._function.logtxt(tostring(ai))end;return ah end;function v._function.assert(...)local aj=true;local ak=table.pack(...)for a0=1,#ak/2,2 do if type(ak[a0-1])~=ak[a0]then aj=false;v._function.logtxt(text)end end;return aj end;function v._function.initResources()local al=1;v._data.itemIcons=a7(v._data.text.directory.."data/itempic.data")F,G,H,I,J,K,L,M=dofile(v._data.text.directory.."data/elements.data")N=dofile(v._data.text.directory.."data/levels.data")N.current=1;for a0=1,#N do N[a0].draw=load("local buffer=require('G_doubleBuffering');return function() "..N[a0].draw.." end")()if not S[a0]then S[a0]={}end end;for a0=1,#F do if F[a0]["name"]==""then F[a0]["name"]="Без названия"end;if F[a0]["loot"]and not F[a0]["loot"]["exp"]then F[a0]["loot"]["exp"]=F[a0]["lvl"]*5 end;if a0%603==0 then g.pullSignal(0)end end;for a0=1,#G do if G[a0]["props"]and type(G[a0]["props"])=="table"and G[a0]["props"]["dds"]then G[a0]["name"]=string.rep("♦",#G[a0]["props"]["dds"])..G[a0]["name"]end;if G[a0]["name"]==""then G[a0]["name"]="Без названия"end;if G[a0]["type"]==2 then if G[a0]["nmlt"]then al=tonumber(G[a0]["nmlt"])end;if G[a0]["props"]["pdef"]==nil then G[a0]["props"]["pdef"]=q(9+G[a0]["lvl"]*v._data.armorPhysicalDefenceMultiple[G[a0]["subtype"]]*al*s(G[a0]["lvl"]^1.2/4,1))end;if G[a0]["props"]["mdef"]==nil then G[a0]["props"]["mdef"]=q(9+G[a0]["lvl"]*v._data.armorMagicalDefenceMultiple[G[a0]["subtype"]]*al*s(G[a0]["lvl"]^1.2/4,1))end end;al=1;if a0%603==0 then g.pullSignal(0)end end;local am=T[v._player.class]["skills"]for a0=1,#am do v._player.skills[a0]={}for an=1,#am[a0]do v._player.skills[a0][an]=am[a0][an]end end;for a0=1,#H do H[a0]["givingQuest"]=nil;H[a0]["comp"]=0 end;v._data.maxItemID=#G end;local function ao(ap,aq,ar,as,at,au)if ap>=ar and ap<=at and aq>=as and aq<=au then return true end;return false end;function v._function.random(av,aw,ax)local ay=10^(ax or 0)return v._function.roundUpNumber(math.random(av*ay,aw*ay))/ay end;function v._function.getBrailleChar(av,av,az,aA,aB,aC,aD,aE)return f.char(10240+128*aE+64*aD+32*aC+16*aA+8*av+4*aB+2*az+av)end;function v._function.unicodeFrame(ap,aq,aF,ag,aG)k.drawText(ap,aq,aG,"┌")k.drawText(ap+1,aq,aG,string.rep("─",aF-2))k.drawText(ap+aF-1,aq,aG,"┐")for a0=1,ag-2 do k.drawText(ap,aq+a0,aG,"│")k.drawText(ap+aF-1,aq+a0,aG,"│")end;k.drawText(ap,aq+ag-1,aG,"└")k.drawText(ap+1,aq+ag-1,aG,string.rep("─",aF-2))k.drawText(ap+aF-1,aq+ag-1,aG,"┘")end;function v._function.textWrap(text,aH)if type(text)=="string"then text={text}end;local aI,aj,aJ,aK={}for ae=1,#text do for aL in text[ae]:gmatch("[^\n]+")do aj=""for aM in aL:gmatch("[^%s]+")do aJ=aj..aM;aK=f.len(aJ)if aK>aH then if f.len(aM)>aH then n(aI,f.sub(aJ,1,aH))for ae=aH+1,aK,aH do n(aI,f.sub(aJ,ae,ae+aH-1))end;aj=aI[#aI].." "aI[#aI]=nil else aj=aj:gsub("%s+$","")n(aI,aj)aj=aM.." "end else aj=aJ.." "end end;aj=aj:gsub("%s+$","")n(aI,aj)end end;return aI end;function v._function.getDistance(aN,ap,aq)local ar,as=Q[aN]["x"],Q[aN]["y"]if ar+Q[aN]["width"]<ap then ar=ar+Q[aN]["width"]end;return p(math.sqrt((ar-ap)^2+(as-(aq or 1))^2)*10)/10 end;function v._function.getDistanceToId(aN,aO)local aP=0;local ar,at=Q[aN]["x"],Q[aO]["x"]if ar+Q[aN]["width"]<at then aP=at-ar-Q[aN]["width"]elseif ar>at+Q[aO]["width"]then aP=ar-at-Q[aO]["width"]end;return aP end;local aQ=false;local aR=0;local aS=1;local aT,aU=A,B;local function aV(ap,aW)v._data.windowThread="screen_save"aT,aU=A,B;aQ=true;aR=aW;aS=ap end;local function aX(ap)local aY,aZ=A,B;A=ap;B=ap;v._player.screenPosition=75-v._function.getDistance(1,ap)end;local function a_(aY,aZ)v._player.screenPosition=75;A,B=aY,aZ;aQ=false;v._data.windowThread=nil end;local function b0()if aQ and aS~=nil then if aR-1>0 then aX(aS)else aR=0;a_(aT,aU)end end end;local function b1(b2,b3)Q[b2]["spos"]=b3 end;local function b4(b5)Q[v._player.id]["image"]=b5 end;function v._function.moveToward(b2,ap,b6,b7)b6=b6 or math.huge;if math.abs(Q[b2]["x"]-ap)>=b7 then if v._function.getDistance(b2,ap)<b6 and ap<Q[b2]["x"]then Q[b2]["x"]=Q[b2]["x"]-b7;b1(b2,1)elseif v._function.getDistance(b2,ap)<b6 and ap>Q[b2]["x"]then Q[b2]["x"]=Q[b2]["x"]+b7;b1(b2,2)end else Q[b2]["x"]=Q[b2]["mx"]end end;function v._function.playerAutoMove(ap,b6,b7)local b8;if v._function.getDistance(v._player.id,ap)>=b7 and v._function.getDistance(v._player.id,ap)<b6 and ap<Q[v._player.id]["x"]then b1(v._player.id,1)C=-b7 elseif v._function.getDistance(v._player.id,ap)>=b7 and v._function.getDistance(v._player.id,ap)<b6 and ap>Q[v._player.id]["x"]then b1(v._player.id,2)C=b7 elseif v._function.getDistance(v._player.id,ap)<b7 then C=0;v._player.moving=false;Q[v._player.id]["x"]=ap;Q[v._player.id]["mx"]=ap;A=ap;B=ap;Q[v._player.id]["image"]=0 end end;function v._function.roundUpNumber(b9)local ba;if b9-p(b9)<0.5 then ba=p(b9)else ba=q(b9)end;return ba end;function v._function.getPlayerAtdsBySkill(bb)return(E or 8)+I[v._player.skills[v._player.actSkills[bb]][1]]["distance"]end;local function bc(b2,bd)local be=bd;local bf=F[Q[b2]["id"]]["quests"]local bg=true;local bh,bi,bj="Новое задание","Я выполню это задание","Не сейчас"if type(bf)=="table"and v._gui.NPCDialog.currentDialog["im"]~=nil then for an=1,#bd do if bd[an]["action"]=="dialog"then bg=false;break end end;if bg then n(be,1,{["dq"]=0,["text"]="Задания",["action"]="dialog",["do"]={["text"]="Выберите любые доступные задания"}})end;for bk=1,#v._player.quests do if v._player.quests[bk][3]and Q[Q[v._player.id]["target"]]["id"]==H[v._player.quests[bk][1]]["qr"]then n(be[1]["do"],{["text"]=H[v._player.quests[bk][1]]["name"],["action"]="cmpquest",["do"]=v._player.quests[bk][1]})end end;for a0=1,#bf do if H[bf[a0]]["comp"]==0 and H[bf[a0]]["minlvl"]<=Q[v._player.id]["lvl"]then n(be[1]["do"],{["q"]=bf[a0],["text"]=H[bf[a0]]["name"],["action"]="qdialog",["do"]={["text"]=H[bf[a0]]["gtext"]or bh,{["text"]=H[bf[a0]]["atext"]or bi,["action"]="getquest",["do"]=bf[a0]},{["text"]=H[bf[a0]]["rtext"]or bj,["action"]="close",["do"]=nil}}})end end;n(be[1]["do"],{["text"]="До встречи",["action"]="close",["do"]=nil})end;return be end;function v._function.showMessage1(bl)n(v._data.messageTable1,bl)v._data.messageTable1timer=10 end;local bm,bn={""},0;function v._function.showMapName(bl)n(bm,bl)bn=5 end;local bo=""function v._function.textmsg3(bl)bo=bl end;local bp,bq={"","",""},0;function v._function.textmsg4(bl)n(bp,bl)if#bp>3 then o(bp,1)end;bq=5 end;local br,bs={},0;function v._function.textmsg5(bl)bs=20;n(br,bl)end;local bt={}local function bu(bv)if bv then return"true"end;return"false"end;v._function.console={}function v._function.console.wError(e)if type(e)=="string"then n(bt,"!/"..e)end end;local function bw(bx)for e=1,#D do if D[e][1]==F[bx]["image"]then return D[e][2]end end;n(O,#O+1,c.load(v._data.text.directory.."sprpic/"..F[bx]["image"]..".pic"))n(D,{F[bx]["image"],#O})return#O end;function v._function.updateUnitStats(by)local function bz(bA)return 36+(bA-1)*34.3+((bA-1)^2-1)/2*math.max((bA-1)/10,1)*(0.85+1/bA^(1/bA))end;local b2,bB=Q[by]["id"],Q[by]["lvl"]local bC,bD;if not F[b2]["dtype"]then bC,bD=1,1 elseif F[b2]["dtype"]==1 then bC=1+0.01*50/math.sqrt(bB)bD=1-0.01*50/math.sqrt(bB)elseif F[b2]["dtype"]==2 then bC=1-0.01*50/math.sqrt(bB)bD=1+0.01*50/math.sqrt(bB)end;Q[by]["pdef"]=q((bB*17.84+(bB-1)^2.2)*(bC+(F[b2]["pdefmul"]or 0)))Q[by]["mdef"]=q((bB*16.55+(bB-1)^2.2)*(bD+(F[b2]["mdefmul"]or 0)))Q[by]["ptk"]={q((1+bB^1.22)*(1+1/bB^(1/bB))*bC),q((3+bB^1.34)*(1+1/bB^(1/bB))*bC)}Q[by]["mtk"]={q((1+bB^1.18)*(1+1/bB^(1/bB))*bD),q((3+bB^1.35)*(1+1/bB^(1/bB))*bD)}Q[by]["mhp"]=F[b2]["mhp"]or q(bz(bB)*(F[b2]["hpmul"]or 1))end;function v._function.defaultUnitStats(a0)Q[a0]["pdef"]=F[Q[a0]["id"]]["pdef_con"]or Q[a0]["pdef"]or 0;Q[a0]["mdef"]=F[Q[a0]["id"]]["mdef_con"]or Q[a0]["mdef"]or 0;if F[Q[a0]["id"]]["ptk_con"]then Q[a0]["ptk"]=F[Q[a0]["id"]]["ptk_con"]else Q[a0]["ptk"]=Q[a0]["ptk"]or{0,0}end;if F[Q[a0]["id"]]["mtk_con"]then Q[a0]["mtk"]=F[Q[a0]["id"]]["mtk_con"]else Q[a0]["mtk"]=Q[a0]["mtk"]or{0,0}end end;function v._function.addUnit(b2,ap,aq)Q[#Q+1]={}local bE=#Q;Q[bE]["sx"]=ap;Q[bE]["mx"]=ap;Q[bE]["x"]=ap;Q[bE]["y"]=aq;Q[bE]["id"]=F[b2]["id"]Q[bE]["lvl"]=F[b2]["lvl"]Q[bE]["spos"]=2;Q[bE]["image"]=bw(b2)Q[bE]["width"]=O[Q[bE]["image"]][1]Q[bE]["height"]=O[Q[bE]["image"]][2]Q[bE]["pdef"]=0;Q[bE]["mdef"]=0;Q[bE]["resptime"]=0;Q[bE]["living"]=true;Q[bE]["cmove"]=true;Q[bE]["ctck"]=true;Q[bE]["rtype"]=F[b2]["rtype"]Q[bE]["target"]=nil;Q[bE]["tlinfo"]={}Q[bE]["effects"]={}if(b2~=1 and F[Q[bE]["id"]]["rtype"]==4 or F[Q[bE]["id"]]["rtype"]==1)and bE~=v._player.id then local bF=Q[bE]["id"]v._function.updateUnitStats(bE)if not F[bF]["pdef"]then F[bF]["pdef_con"]=Q[bE]["pdef"]or 0 else F[bF]["pdef_con"]=F[bF]["pdef"]end;if not F[bF]["mdef"]then F[bF]["mdef_con"]=Q[bE]["mdef"]or 0 else F[bF]["mdef_con"]=F[bF]["mdef"]end;if not F[bF]["ptk"]then F[bF]["ptk_con"]=Q[bE]["ptk"]or 0 else F[bF]["ptk_con"]=F[bF]["ptk"]end;if not F[bF]["mtk"]then F[bF]["mtk_con"]=Q[bE]["mtk"]or 0 else F[bF]["mtk_con"]=F[bF]["mtk"]end;if not F[bF]["mhp"]then F[bF]["mhp_con"]=Q[bE]["mhp"]or 0 else F[bF]["mhp_con"]=F[bF]["mhp"]end end;v._function.defaultUnitStats(bE)Q[bE]["chp"]=Q[bE]["mhp"]return bE end;local function bG()for a0=1,#v._player.quests do if H[v._player.quests[a0][1]]["type"]==2 then v._player.quests[a0][3]=false;if type(H[v._player.quests[a0][1]]["targ"][1])=="number"then v._player.quests[a0][2]=v._function.checkItemInBag(H[v._player.quests[a0][1]]["targ"][1])if v._player.quests[a0][2]>=H[v._player.quests[a0][1]]["targ"][2]then v._player.quests[a0][3]=true end else local bH=0;for ae=1,#H[v._player.quests[a0][1]]["targ"]do v._player.quests[a0][2][ae]=v._function.checkItemInBag(H[v._player.quests[a0][1]]["targ"][ae][1])if v._player.quests[a0][2][ae]>=H[v._player.quests[a0][1]]["targ"][ae][2]then bH=bH+1 end end;if bH==#H[v._player.quests[a0][1]]["targ"]then v._player.quests[a0][3]=true end end end end end;function v._function.checkInventoryisFull()local bI=true;for a0=1,#v._player.inventory["bag"]do if v._player.inventory["bag"][a0][2]==0 then bI=false end end;return bI end;function v._function.checkInventorySpace()local bJ=0;for a0=1,#v._player.inventory["bag"]do if v._player.inventory["bag"][a0][1]==0 then bJ=bJ+1 end end;return bJ end;local bK;function v._function.addItem(bL,b9,bM)local bN=0;local bO=0;for a0=1,#v._player.inventory["bag"]do if v._player.inventory["bag"][a0][2]==0 then v._player.inventory["bag"][a0][1]=0;if v._player.inventory["bag"][a0][1]>=v._config.reservedItemId then G[v._player.inventory["bag"][a0][1]]=nil end;P[a0]=nil end end;if G[bL]and not G[bL]["stack"]then for a0=1,#v._player.inventory["bag"]do if v._player.inventory["bag"][a0][1]==0 then bN=1;v._player.inventory["bag"][a0][1]=bL;v._player.inventory["bag"][a0][2]=b9;if v._data.windowThread=="inventory"then P[a0]=c.load(v._data.text.directory.."itempic/"..v._data.itemIcons[G[v._player.inventory["bag"][a0][1]]["icon"]]..".pic")end;bO=a0;break end end else for ae=1,#v._player.inventory["bag"]do if v._player.inventory["bag"][ae][1]==bL then v._player.inventory["bag"][ae][2]=v._player.inventory["bag"][ae][2]+b9;bN=1;bO=ae;break end end;if bN==0 then for ae=1,#v._player.inventory["bag"]do if v._player.inventory["bag"][ae][1]==0 or v._player.inventory["bag"][ae][2]==0 then v._player.inventory["bag"][ae][1]=bL;v._player.inventory["bag"][ae][2]=b9;bN=1;if v._data.windowThread=="inventory"then P[ae]=c.load(v._data.text.directory.."itempic/"..v._data.itemIcons[G[v._player.inventory["bag"][ae][1]]["icon"]]..".pic")end;bO=ae;break end end end end;if bN==0 and v._function.checkInventoryisFull()then bK={bL,b9}v._function.showMessage1("Инвентарь переполнен!")else if bM then v._function.showMessage1("Получен предмет \""..G[bL]["name"].."\" "..b9 .." шт.")end;bG()v._gui.qPanel.update()end;for a0=1,#v._player.inventory["bag"]do if v._player.inventory["bag"][a0][1]~=0 and G[v._player.inventory["bag"][a0][1]]and not G[v._player.inventory["bag"][a0][1]]["stack"]and v._player.inventory["bag"][a0][2]>1 then v._player.inventory["bag"][a0][2]=1 end end;return bO end;local function bP(bQ,bR)bR=bR or 1;if v._player.inventory["bag"][bQ][2]>1 then v._player.inventory["bag"][bQ][2]=v._player.inventory["bag"][bQ][2]-bR else v._player.inventory["bag"][bQ]={0,0,{}}end;bG()end;function v._function.removeItem(bS,bR)bR=bR or 1;local b9=0;local ae=bR;for a0=1,#v._player.inventory["bag"]do if v._player.inventory["bag"][a0][1]==bS then b9=b9+v._player.inventory["bag"][a0][2]end end;if b9>=bR then for a0=1,#v._player.inventory["bag"]do if v._player.inventory["bag"][a0][1]==bS then if v._player.inventory["bag"][a0][2]<ae then bP(a0,v._player.inventory["bag"][a0][2])ae=ae-v._player.inventory["bag"][a0][2]else bP(a0,bR)break end end end else return true end end;local function bT(bU)local bE=bU;local bV,bW,bv;for a0=1,#bE do bV=v._function.random(1,#bE)bW=v._function.random(1,#bE)bv=bE[bV]bE[bV]=bE[bW]bE[bW]=bv end;return bE end;local function bX(bY)local bZ,b_=-1,0;while true do if not G[v._config.reservedItemId+b_]then bZ=v._config.reservedItemId+b_;break end;b_=b_+1 end;if G[bY]["type"]==2 or G[bY]["type"]==3 then G[bZ]={}for c0,c1 in pairs(G[bY])do G[bZ][c0]=G[bY][c0]end;G[bZ]["props"]={["dds"]={}}for c0,c1 in pairs(G[bY]["props"])do G[bZ]["props"][c0]=G[bY]["props"][c0]end;local bB=G[bY]["lvl"]local c2={[1]={"hp+",["min"]=4+bB^2,["max"]=5+bB^2*3,[3]=10+bB*2,[2]=80+bB*2},[2]={"sur+",["min"]=q(bB/2),["max"]=bB,[3]=40+bB*2,[2]=50+bB*2},[3]={"str+",["min"]=q(bB/2),["max"]=bB,[3]=40+bB*2,[2]=50+bB*2},[4]={"int+",["min"]=q(bB/2),["max"]=bB,[3]=40+bB*2,[2]=50+bB*2},[5]={"agi+",["min"]=q(bB/2),["max"]=bB,[3]=30+bB*2,[2]=30+bB*2},[6]={"pdm+",["min"]=2+bB*6+bB-3,["max"]=2+bB^1.2*8+bB-3,[3]=60+bB*2,[2]=0,["sub"]={1,2,3}},[7]={"mdm+",["min"]=2+bB*6+bB-3,["max"]=2+bB^1.2*8+bB-3,[3]=60+bB*2,[2]=0,["sub"]={4}},[8]={"pdf+",["min"]=5+(bB-1)^2*3,["max"]=5+(bB-1)^2*5,[3]=0,[2]=30+bB*2},[9]={"mdf+",["min"]=5+(bB-1)^2*3,["max"]=5+(bB-1)^2*5,[3]=0,[2]=30+bB*2},[10]={"mp+",["min"]=4+bB^2,["max"]=5+bB^2*2,[3]=2+bB*2,[2]=20+bB*2},[11]={"chc+",["min"]=1,["max"]=2,[3]=10,[2]=5},[12]={"hp%",["min"]=5,["max"]=5,[3]=0,[2]=bB-1},[13]={"mp%",["min"]=5,["max"]=5,[3]=0,[2]=bB-1},[14]={"hp%",["min"]=10,["max"]=10,[3]=0,[2]=s(bB-2,0)},[15]={"mp%",["min"]=10,["max"]=10,[3]=0,[2]=s(bB-2,0)}}local c3,c4,c5={100,45,7.5,1,0.15},1,{}local c6,c7,c8;for a0=1,5 do if v._function.random(1,10^6)/10^4<=c3[6-a0]then c4=6-a0;break end end;while#c5<r(c4,G[bY]["lvl"])do c6=false;c7=v._function.random(1,#c2)if v._function.random(1,10^5)<=c2[c7][G[bY]["type"]]*10^3 then c8=p(v._function.random(c2[c7]["min"]*10,c2[c7]["max"]*10)/10)if c2[c7]["sub"]then for c9=1,#c2[c7]["sub"]do if G[bY]["subtype"]==c2[c7]["sub"][c9]then c6=true end end elseif c8>=1 then c6=true end;if c6 then n(c5,{c2[c7][1],p(c8)})end end end;for ca=1,#c5-1 do if G[bZ]["type"]==3 and not G[bZ]["cchg"]then if G[bZ]["props"]["phisat"]then G[bZ]["props"]["phisat"][1]=p(G[bZ]["props"]["phisat"][1]*1.1)G[bZ]["props"]["phisat"][2]=p(G[bZ]["props"]["phisat"][2]*1.1)end;if G[bZ]["props"]["magat"]then G[bZ]["props"]["magat"][1]=p(G[bZ]["props"]["magat"][1]*1.1)G[bZ]["props"]["magat"][2]=p(G[bZ]["props"]["magat"][2]*1.1)end elseif G[bZ]["type"]==2 and not G[bZ]["cchg"]then if G[bZ]["props"]["pdef"]then G[bZ]["props"]["pdef"]=p(G[bZ]["props"]["pdef"]*1.23)end;if G[bZ]["props"]["mdef"]then G[bZ]["props"]["mdef"]=p(G[bZ]["props"]["mdef"]*1.23)end end end;if not G[bY]["ncolor"]then if#c5>0 and#c5<3 then G[bZ]["ncolor"]=z.blue elseif#c5==3 then G[bZ]["ncolor"]=z.magenta elseif#c5==4 then G[bZ]["ncolor"]=z.orange elseif#c5>=5 then G[bZ]["ncolor"]=z.green end end;G[bZ]["props"]["dds"]=c5;G[bZ]["name"]=string.rep("♦",r(#c5,5))..G[bZ]["name"]G[bZ]["cost"]=G[bY]["cost"]+q(G[bY]["cost"]/2*r(#G[bZ]["props"]["dds"],5))G[bZ]["oid"]=bY;G[bZ]["id"]=bZ;if#c5==0 or G[bY]["cchg"]then G[bZ]=nil;return bY else v._data.maxItemID=bZ end else return bY end;return bZ end;function v._function.addUnitEffect(cb,cc,bA,cd)local ce=true;if cb and cc and bA and cc>=1 and cc<=#K then for cf=1,#Q[cb]["effects"]do if Q[cb]["effects"][cf][1]==cc then Q[cb]["effects"][cf][2]=K[cc]["dur"][bA]ce=false;break end end;if ce then n(Q[cb]["effects"],{cc,K[cc]["dur"][bA],bA,cd})end else v._function.logtxt("addUnitEffect: ошибка данных")end end;function v._function.addUnitHitInfo(cg,text)n(Q[cg]["tlinfo"],text)end;function v._function.checkItemInBag(bL)local ch=0;for a0=1,#v._player.inventory["bag"]do if v._player.inventory["bag"][a0][1]==bL then ch=ch+v._player.inventory["bag"][a0][2]end end;return ch,bL end;function v._function.getArmorType(b2)if G[b2]["type"]==2 then for c0,ci in pairs(v._data.armorTypeIds)do for an=1,#ci do if G[b2]["subtype"]==v._data.armorTypeIds[c0][an]then return c0 end end end end end;function v._function.getItemRequirement(b2)local cj=true;if G[b2]["required"]then for c0,ci in pairs(G[b2]["required"])do if G[b2]["required"][c0]>Q[v._player.id][c0]then cj=false end end else return true end;return cj end;function v._function.setAllValuesInArrayTo(ck,c8)local cm={}for c0,c1 in pairs(ck)do cm[c0]=c8 end;return cm end;local cn={["helmet"]="Голова",["pendant"]="Украшение",["armor"]="Броня",["pants"]="Штаны",["footwear"]="Обувь",["robe"]="Накидка",["ring"]="Кольцо",["weapon"]="Оружие"}function v._function.getWitemTypeName(co)return cn[co]or""end;function v._function.UpdatePlayerStats()v._player.updStats=v._function.setAllValuesInArrayTo(v._player.updStats,0)local cp,cq;for c0,c1 in pairs(v._player.inventory["weared"])do if v._player.inventory["weared"][c0][1]~=0 and G[v._player.inventory["weared"][c0][1]]["props"]["dds"]then cp=G[v._player.inventory["weared"][c0][1]]["props"]["dds"]for e=1,#cp do v._player.updStats[cp[e][1]]=v._player.updStats[cp[e][1]]+cp[e][2]end end;if v._player.inventory["weared"][c0][1]~=0 and G[v._player.inventory["weared"][c0][1]]["type"]==2 then v._player.updStats["pdf+"]=v._player.updStats["pdf+"]+G[v._player.inventory["weared"][c0][1]]["props"]["pdef"]v._player.updStats["mdf+"]=v._player.updStats["mdf+"]+G[v._player.inventory["weared"][c0][1]]["props"]["mdef"]end end;local cr=false;local cs;for a0=1,#v._player.skills do cs=v._player.skills[a0][3]if I[v._player.skills[a0][1]]["type"]==2 and I[v._player.skills[a0][1]]["action"].weaponreq then for aF=1,#I[v._player.skills[a0][1]]["action"].weaponreq do if v._player.inventory["weared"]["weapon"][1]~=0 and G[v._player.inventory["weared"]["weapon"][1]]["subtype"]==I[v._player.skills[a0][1]]["action"].weaponreq then cr=true end end else cr=true end;if cs>0 and I[v._player.skills[a0][1]]["type"]==2 and v._player.updStats[I[v._player.skills[a0][1]]["action"].etype]~=nil and cr==true then v._player.updStats[I[v._player.skills[a0][1]]["action"].etype]=v._player.updStats[I[v._player.skills[a0][1]]["action"].etype]+I[v._player.skills[a0][1]]["value"][cs]end end;cq=1+p((Q[v._player.id]["strg"]+v._player.updStats["str+"])/10)cq=cq+p((Q[v._player.id]["int"]+v._player.updStats["int+"])/10)cq=cq+p((Q[v._player.id]["agi"]+v._player.updStats["agi+"])/5)v._player.updStats["vPdm1"]=v._player.updStats["vPdm1"]+v._player.updStats["pdm+"]v._player.updStats["vPdm2"]=v._player.updStats["vPdm2"]+v._player.updStats["pdm+"]v._player.updStats["vMdm1"]=v._player.updStats["vMdm1"]+v._player.updStats["mdm+"]v._player.updStats["vMdm2"]=v._player.updStats["vMdm2"]+v._player.updStats["mdm+"]if v._player.inventory["weared"]["weapon"][1]>0 then if G[v._player.inventory["weared"]["weapon"][1]]["props"]["phisat"]then v._player.updStats["vPdm1"]=v._player.updStats["vPdm1"]+G[v._player.inventory["weared"]["weapon"][1]]["props"]["phisat"][1]*(1+v._player.updStats["pwd%"]*0.01)v._player.updStats["vPdm2"]=v._player.updStats["vPdm2"]+G[v._player.inventory["weared"]["weapon"][1]]["props"]["phisat"][2]*(1+v._player.updStats["pwd%"]*0.01)end;if G[v._player.inventory["weared"]["weapon"][1]]["props"]["magat"]then v._player.updStats["vMdm1"]=v._player.updStats["vMdm1"]+G[v._player.inventory["weared"]["weapon"][1]]["props"]["magat"][1]*(1+v._player.updStats["mwd%"]*0.01)v._player.updStats["vMdm2"]=v._player.updStats["vMdm2"]+G[v._player.inventory["weared"]["weapon"][1]]["props"]["magat"][2]*(1+v._player.updStats["mwd%"]*0.01)end;v._player.updStats["weaponDistance"]=v._function.watds[G[v._player.inventory["weared"]["weapon"][1]]["subtype"]]I[1]["reloading"]=U[G[v._player.inventory["weared"]["weapon"][1]]["subtype"]]or 1 end;v._player.statsPoints.vSur=v._player.updStats["sur+"]v._player.statsPoints.vStr=v._player.updStats["str+"]v._player.statsPoints.vInt=v._player.updStats["int+"]v._player.statsPoints.vAgi=v._player.updStats["agi+"]v._player.statsPoints.vPdm1=v._player.updStats["vPdm2"]v._player.statsPoints.vMdm1=v._player.updStats["vMdm1"]v._player.statsPoints.vPdm2=v._player.updStats["vPdm2"]v._player.statsPoints.vMdm2=v._player.updStats["vMdm2"]Q[v._player.id]["mhp"]=q((T[v._player.class]["basehp"]+(Q[v._player.id]["surv"]+v._player.updStats["sur+"])*T[v._player.class]["surhpmul"]+(Q[v._player.id]["lvl"]-1)*T[v._player.class]["levelhpmul"]+v._player.updStats["hp+"])*(1+v._player.updStats["hp%"]/100))Q[v._player.id]["mmp"]=q((T[v._player.class]["basemp"]+(Q[v._player.id]["int"]+v._player.updStats["int+"])*T[v._player.class]["intmpmul"]+(Q[v._player.id]["lvl"]-1)*T[v._player.class]["levelmpmul"]+v._player.updStats["mp+"])*(1+v._player.updStats["mp%"]/100))local ct=1+(4*(Q[v._player.id]["strg"]+v._player.updStats["str+"])+Q[v._player.id]["agi"]+v._player.updStats["agi+"])/100;local cu=1+(4*(Q[v._player.id]["int"]+v._player.updStats["int+"])+Q[v._player.id]["agi"]+v._player.updStats["agi+"])/100;Q[v._player.id]["ptk"]={p(1+ct*(Q[v._player.id]["lvl"]+v._player.updStats["vPdm1"])),q(1+ct*(Q[v._player.id]["lvl"]+v._player.updStats["vPdm2"]))}Q[v._player.id]["mtk"]={p(1+cu*(Q[v._player.id]["lvl"]+v._player.updStats["vMdm1"])),q(1+cu*(Q[v._player.id]["lvl"]+v._player.updStats["vMdm2"]))}Q[v._player.id]["pdef"]=p(30+((Q[v._player.id]["surv"]+v._player.updStats["sur+"])/2+(Q[v._player.id]["strg"]+v._player.updStats["str+"])/4)*(Q[v._player.id]["lvl"]+v._player.updStats["pdf+"]/2))Q[v._player.id]["armorpdef"]=v._player.updStats["pdf+"]Q[v._player.id]["mdef"]=p(30+((Q[v._player.id]["surv"]+v._player.updStats["sur+"])/2+(Q[v._player.id]["int"]+v._player.updStats["int+"])/4)*(Q[v._player.id]["lvl"]+v._player.updStats["mdf+"]/2))Q[v._player.id]["armormdef"]=v._player.updStats["mdf+"]Q[v._player.id]["cmove"]=true;Q[v._player.id]["ctck"]=true;v._player.critChance=v._player.updStats["chc+"]+cq;E=v._player.updStats["weaponDistance"]v._player.manaReg=s(0,0.75+(Q[v._player.id]["lvl"]-1)*v._parameter.intRegenMultiplier+Q[v._player.id]["int"]*0.1)*v._player.regenMultiplier;v._player.healthReg=s(0,0.75+(Q[v._player.id]["lvl"]-1)*v._parameter.survRegenMultiplier+Q[v._player.id]["surv"]*0.1)*v._player.regenMultiplier end;function v._function.maxXP()local cv=0;for e=1,Q[v._player.id]["lvl"]do if e<=15 then cv=p(cv+cv*2/e+50*e^(1/e))elseif e>15 and e<30 then cv=p(cv+cv*3/e+52*e^(1/e))elseif e>=30 then cv=p(cv+cv*4/e+54*e^(1/e))end end;Q[v._player.id]["mxp"]=s(cv,1)end;local function cw(c8)local cx,aH,ae=c8 or 0,99,0;while ae<=aH do v._function.maxXP()if cx<=Q[v._player.id]["mxp"]-Q[v._player.id]["cxp"]then Q[v._player.id]["cxp"]=Q[v._player.id]["cxp"]+cx;break else cx=cx-(Q[v._player.id]["mxp"]-Q[v._player.id]["cxp"])Q[v._player.id]["cxp"]=0;Q[v._player.id]["levelpoints"]=Q[v._player.id]["levelpoints"]+2;Q[v._player.id]["lvl"]=Q[v._player.id]["lvl"]+1;v._function.showMessage1("Получен уровень "..Q[v._player.id]["lvl"])v._function.UpdatePlayerStats()Q[v._player.id]["chp"]=Q[v._player.id]["mhp"]Q[v._player.id]["cmp"]=Q[v._player.id]["mmp"]ae=ae+1 end end;if v._data.windowThread==nil and c8~=nil and c8>0 then v._function.textmsg4("Опыт +"..c8)end end;function v._function.addCoins(c8)v._player.coins=s(v._player.coins+c8,0)if v._data.windowThread==nil and c8~=nil and c8>0 then v._function.textmsg4("Монеты +"..c8 .."("..v._player.coins..")")end end;function v._function.addHealth(b2,c8)if Q[b2]["chp"]+c8<Q[b2]["mhp"]then Q[b2]["chp"]=Q[b2]["chp"]+c8 else Q[b2]["chp"]=Q[b2]["mhp"]end end;function v._function.getQuest(cy)n(v._player.quests,{cy,0,false})if type(H[cy]["targ"])=="table"then v._player.quests[#v._player.quests][2]={}for a0=1,#H[cy]["targ"]do v._player.quests[#v._player.quests][2][a0]=0 end end;v._gui.qPanel.update()end;function v._function.levelLoadingScreen()local cz="(C) 2016-2022 Wirthe16"k.drawRectangle(1,1,160,50,y,0," ")k.drawText(2,2,0xA7A7A7,v._data.text.screen1)k.drawText(2,4,0xA7A7A7,N[N.current].name)k.drawText(158-f.len(v._function.getVersion()),48,0xA1A1A1,v._function.getVersion())k.drawText(158-f.len(cz),49,0xB1B1B1,cz)_()k.drawChanges()if x then k.drawText(2,p(u/2),0xD80000,"Предупреждение:"..v._data.text.warning)k.drawText(2,p(u/2)+1,0xD80000,"Продолжить загрузку? Y/N")k.drawChanges()while true do local af=table.pack(b.pull())if af[1]=="key_up"then if af[4]==21 then break elseif af[4]==49 or af[4]==28 then error("Отмена")end end end end;k.drawChanges()end;local function cA()local bR=0;for a0=1,#S do bR=bR+#S[a0]end;return bR end;local function cB()local function cC(b2)local cD=true;if Q[b2]["id"]==v._player.id or Q[b2]["id"]==v._data.potralUnitId then cD=false end;if Q[v._player.id]["followers"]then for a0=1,#Q[v._player.id]["followers"]do if b2==Q[v._player.id]["followers"][a0][2]then cD=false;break end end end;return cD end;S[N.current]={}for a0=1,#Q do if Q[a0]and cC(a0)and Q[a0]["living"]~=true then n(S[N.current],{Q[a0]["id"],v._function.roundUpNumber(Q[a0]["x"]),v._function.roundUpNumber(Q[a0]["y"]),Q[a0]["resptime"],a0})end end end;local function cE(a0,an)local ar,at,aq=5,p(a0*150/an),40;m.fill(ar,aq,at,1,'█')end;function v._function.loadWorld(b2,cF)local cG={}cB()v._data.stopDrawing=true;v._data.paused=true;v._data.windowThread=nil;Q[v._player.id]["target"]=nil;v._gui.NPCDialog.currentDialog=nil;N.current=b2;D={}v._function.levelLoadingScreen()m.setForeground(0xAAAAAA)m.fill(5,39,150,1,'─')m.fill(5,41,150,1,'─')m.setForeground(0xCCCCCC)local an=Q[v._player.id]if Q[v._player.id]and Q[v._player.id]["followers"]and#Q[v._player.id]["followers"]>0 then for a0=1,#Q[v._player.id]["followers"]do cG[a0]=Q[Q[v._player.id]["followers"][a0][2]]end end;Q={}Q[v._player.id]=an;Q[v._player.id]["x"],Q[v._player.id]["mx"],A,B=1,1,1,1;Q[v._player.id]["cmove"]=true;Q[v._player.id]["ctck"]=true;O={[-4]=c.load(v._data.text.directory.."sprpic/"..F[v._player.gudId]["aimage"][4]),[-3]=c.load(v._data.text.directory.."sprpic/"..F[v._player.gudId]["aimage"][3]),[-2]=c.load(v._data.text.directory.."sprpic/"..F[v._player.gudId]["aimage"][2]),[-1]=c.load(v._data.text.directory.."sprpic/"..F[v._player.gudId]["aimage"][1]),[0]=c.load(v._data.text.directory.."sprpic/"..F[v._player.gudId]["image"]..".pic")}local cH=0;local cI=1;local cJ=cF or N[b2].spawnList;for a0=1,#cJ do cH=cJ[a0][2]if F[cJ[a0][1]]["nres"]~=false then if cJ[a0][4]==nil then v._function.addUnit(cJ[a0][1],cH,cJ[a0][3])for an=1,#S[b2]do if S[b2][an][5]==#Q then if S[b2][an][4]>0 then Q[#Q]["living"]=false;Q[#Q]["resptime"]=S[b2][an][4]end end end else for ae=1,cJ[a0][4]do v._function.addUnit(cJ[a0][1],cH+ae*cJ[a0][5]-cJ[a0][5],cJ[a0][3])for an=1,#S[b2]do if S[b2][an][5]==#Q then if S[b2][an][4]>0 then Q[#Q]["living"]=false;Q[#Q]["resptime"]=S[b2][an][4]end end end end end;if a0%603==0 then g.pullSignal(0)end end;cE(a0,#cJ)end;S[N.current]={}local cK;if#cG>0 then for a0=1,#cG do cK=#Q+1;n(Q,cK,cG[a0])Q[cK]["x"]=Q[v._player.id]["x"]Q[cK]["mx"]=Q[v._player.id]["x"]Q[cK]["image"]=bw(Q[cK]["id"])Q[v._player.id]["followers"][a0]={Q[cK]["id"],cK}end end;cG=nil;v._data.paused=false;v._data.stopDrawing=false;v._function.showMapName(N[b2].name)end;function v._function.teleport(ap,cL)if cL and cL~=N[N.current]then cB()v._function.loadWorld(cL)if#Q[v._player.id]["followers"]>0 then for a0=1,#Q[v._player.id]["followers"]do Q[Q[v._player.id]["followers"][a0][2]]["x"]=ap;Q[Q[v._player.id]["followers"][a0][2]]["mx"]=ap;Q[Q[v._player.id]["followers"][a0][2]]["target"]=nil end end end;A,B,Q[v._player.id]["x"],Q[v._player.id]["mx"]=ap or 1,ap or 1,ap or 1,ap or 1 end;function v._function.saveGame(cM,cN)if not i.exists(cM)then i.makeDirectory(cM)end;cB()local cO={}for a0=1,600 do if G[v._config.reservedItemId-1+a0]then n(cO,G[v._config.reservedItemId-1+a0])end end;for ae=1,#Q do if Q[ae]then for a0=1,#Q[v._player.id]["followers"]do if ae==Q[v._player.id]["followers"][a0][2]then v._function.keepFollower(ae)end end end end;Q[v._player.id]["chp"]=p(Q[v._player.id]["chp"])local a0=io.open(cM.."/"..cN,"w")a0:write(F[Q[v._player.id]["id"]]["name"].."\n")a0:write(j.serialize(Q[v._player.id]),"\n")a0:write(j.serialize(v._player),"\n")a0:write(j.serialize({N.current}),"\n")a0:write(j.serialize(cO),"\n")a0:write(j.serialize(Q),"\n")cO={}for ae=1,#H do if H[ae]["comp"]>0 then n(cO,{ae,H[ae]["comp"]})end end;a0:write(j.serialize(cO),"\n")cO=S;a0:write(j.serialize(cO),"\n")cO={}for ae=1,#F do if F[ae]["nres"]==false then n(cO,ae)end end;a0:write(j.serialize(cO))a0:close()end;function v._function.loadGame(cM,cN)local cO,cP;if i.exists(cM.."/"..cN)then v._data.paused=true;v._data.stopDrawing=true;bK=nil;v._data.messageTable1={}for c0,c1 in pairs(O)do v._function.unloadImage(O[c0])end;O={}v._function.cleanIconImageBuffer()for ae=1,#H do H[ae]["comp"]=0 end;for ae=1,600 do if G[v._config.reservedItemId+ae]then G[v._config.reservedItemId+ae]=nil end end;cO=a7(cM.."/"..cN)v._player=j.unserialize(cO[3])cP=j.unserialize(cO[4])N.current=cP[1]Q=j.unserialize(cO[6])F[Q[v._player.id]["id"]]["name"]=cO[1]Q[v._player.id]=j.unserialize(cO[2])b4(0)local cQ=Q[v._player.id]["x"]cP=j.unserialize(cO[5])for a0=1,#cP do G[cP[a0]["id"]]=cP[a0]if G[#G]["oid"]then G[#G]["name"]=G[G[#G]["oid"]]["name"]if G[#G]["props"]and type(G[#G]["props"])=="table"and G[#G]["props"]["dds"]then for cR=1,#G[#G]["props"]["dds"]do G[#G]["name"]="♦"..G[#G]["name"]end end;v._data.maxItemID=s(v._config.reservedItemId-1+a0,v._config.reservedItemId)end end;cP=j.unserialize(cO[7])for a0=1,#cP do H[cP[a0][1]]["comp"]=cP[a0][2]end;cP=j.unserialize(cO[9])for a0=1,#cP do F[cP[a0]]["nres"]=false end;for a0=1,#N do S[a0]={}end;cP=j.unserialize(cO[8])for an=1,#cP do S[an]=cP[an]end;v._function.loadWorld(N.current)v._function.teleport(cQ)targetQuest=0 end end;function v._function.pbar(ap,aq,cS,cT,cU,cV,text,cW,cX)local cY,aG=r(q(cT*cS/100),cS),1;if not cX then k.drawRectangle(ap,aq,cS,1,cV,0," ")k.drawRectangle(ap,aq,cY,1,cU,0," ")if text then k.drawText(ap,aq,cW,text)end elseif cX==1 then k.drawRectangle(ap,aq,cS-1,1,cV,0," ")k.drawText(ap+cS-1,aq,cV,"◤")if cY<cS/4 or cY>cS*0.75 then aG=1 else aG=0 end;k.drawRectangle(ap,aq,cY-aG,1,cU,0," ")if cY<cS/4 or cY>cS*0.75 then k.drawText(ap+cY-1,aq,cU,"◤")end end end;function v._function.checkNPCHasQuest(b2)local cZ=false;local c_=F[b2]["quests"]if b2>0 and c_ then for a0=1,#c_ do if H[c_[a0]]and H[c_[a0]]["comp"]==0 and Q[v._player.id]["lvl"]>=H[c_[a0]]["minlvl"]then cZ=true;break end end end;return cZ end;function v._function.checkNPCCompletedQuest(b2)local d0=false;for a0=1,#v._player.quests do if H[v._player.quests[a0][1]]["qr"]==b2 and v._player.quests[a0][3]==true then d0=true;break end end;return d0 end;local function d1(d2,...)local ak={...}for ae=1,#ak do if type(ak[ae])=="string"then if Q[d2]["rtype"]==d2 then return true end end end;return false end;function v._function.drawAllCGDUnits()local d3,d4,d5,d6,d7,d8,d9,da,db;local dc,dd=8,24;for a0=1,#Q do if a0~=v._player.id and Q[a0]and Q[a0]["living"]and v._function.getDistanceToId(v._player.id,a0)<=v._config.unitDrawingDistance then da=Q[a0]["width"]/2;d4,d5=p(Q[a0]["x"]),p(Q[a0]["y"])d6,d7=d4+75-A,49-d5-Q[a0]["height"]if Q[a0]["image"]~=nil then if Q[a0]["spos"]==2 then k.drawImage(d6,d7,O[Q[a0]["image"]],true)else k.drawImage(d6,d7,c.flipHorizontally(O[Q[a0]["image"]]),true)end else k.drawText(d6,d7,0xcc2222,"ERROR")end;if a0==Q[v._player.id]["target"]and Q[a0]["rtype"]==4 then v._function.pbar(d6+p(da-dc/2),d7-2,dc,q(Q[a0]["chp"])*100/Q[a0]["mhp"],0xFF0000,0x444444," ",0xffffff)k.drawText(p(d6+da-dc/2+p(dc/2-f.len(tostring(q(Q[a0]["chp"])))/2)),d7-2,0xffffff,tostring(q(Q[a0]["chp"])))d8=tostring(F[Q[Q[v._player.id]["target"]]["id"]]["name"])if f.len(d8)>=dd then d8=f.sub(d8,1,dd).."…"end;k.drawText(p(d6+da-dd/2+dd/2-f.len(d8)/2),d7-3,0xffffff,d8)elseif v._player.pickingUp and v._player.pckTarget==a0 and Q[a0]["rtype"]==5 then d9=q((v._player.maxPckTime-v._player.pckTime)*100/v._player.maxPckTime)v._function.pbar(d6+p(da-dc/2),d7-2,dc,d9,0x009945,0x444444,d9 .."% ",0xffffff)elseif Q[a0]["rtype"]==2 then if v._function.checkNPCCompletedQuest(Q[a0]["id"])==true then d3=0x009922 elseif v._function.checkNPCHasQuest(Q[a0]["id"])==true then d3=0xDCBC12 end;if d3 then k.drawText(d6+p(da)-2,d7-5,d3,"▔██▔")k.drawText(d6+p(da)-1,d7-4,d3,"◤◥")d3=nil end end;if Q[a0]["tlinfo"]and#Q[a0]["tlinfo"]>0 then db=""for de=1,2 do if Q[a0]["tlinfo"][de]then db=Q[a0]["tlinfo"][de]if f.len(tostring(Q[a0]["tlinfo"][de]))>=dd then db=f.sub(Q[a0]["tlinfo"][de][1],1,dd).."…"end;k.drawText(p(d6+da-dd/2+p(dd/2-f.len(db)/2)),d7-de-3,0xffffff,db)end end end end end end;function v._gui.blank.draw(df,dg)local ap,aq,aF,ag,dg=df.x,df.y,df.w,df.h,dg or df.title;local dh=f.len(dg)k.drawRectangle(ap,aq,aF,ag,0xABABAB,0," ")k.drawRectangle(ap,aq,aF,1,0x525252,0," ")k.drawText(ap+p(aF/2-dh/2),aq,0xffffff,dg)if aF>50 then k.drawText(ap+aF-8,aq,0xffffff,"Закрыть")else k.drawText(ap+aF-1,aq,0xffffff,"X")end end;v._gui.pauseMenu.buttonFunction={[1]=function()v._data.windowThread=nil;v._data.paused=false end,[2]=function()v._gui.inventory.open()end,[3]=function()v._data.windowThread="skillsWindow"v._gui.playerSkills.updateDescription()end,[4]=function()v._data.windowThread="pstats"v._function.UpdatePlayerStats()v._gui.playerStats.updateContent()end,[5]=function()v._data.windowThread="quests"end,[6]=function()v._function.saveGame(v._data.text.directory.."saves",F[Q[v._player.id]["id"]]["name"])end,[7]=function()v._gui.mainMenu.open(2)end,[8]=function()v._gui.mainMenu.open(0)end}function v._gui.pauseMenu.draw()local ap,aq=v._gui.pauseMenu.x,v._gui.pauseMenu.y;k.drawRectangle(ap,aq,v._gui.pauseMenu.w,v._gui.pauseMenu.h,0x9D9D9D,0," ")k.drawText(13,2,0xffffff,"Пауза")for a0=1,#v._data.pauseMenuList do k.drawRectangle(1,1+a0*4,v._gui.pauseMenu.w,3,0x838383,0," ")k.set(1,3+a0*4,0x959595,0x000000," ")k.drawText(s(p(v._gui.pauseMenu.w/2-f.len(v._data.pauseMenuList[a0])/2),0),2+a0*4,0xffffff,v._data.pauseMenuList[a0])end end;v._gui.pauseMenu.action["touch"]=function(af)for a0=1,#v._data.pauseMenuList do if af[5]==0 and ao(af[3],af[4],v._gui.pauseMenu.x,4+a0*4-3,v._gui.pauseMenu.x+v._gui.pauseMenu.w-1,3+a0*4)then v._gui.pauseMenu.buttonFunction[a0]()af[3],af[4]=0,0;break end end end;function v._function.drawEffInfo(ap,aq,b2)k.drawRectangle(ap,aq,s(f.len(K[b2]["name"]),f.len(K[b2]["descr"])),2,0xA1A1A1,0," ")k.drawText(ap,aq,0xEDEDED,K[b2]["name"])k.drawText(ap,aq+1,0xCECECE,K[b2]["descr"])end;local di=false;v._gui.playerInfoPanel={x=1,y=1,w=25,h=5,effectDescription=0,edx=1,edy=1,action={}}local function dj(ap,aq,cd)for a0=1,#cd do for ag=1,2 do for aF=1,3 do k.set(ap+a0*4-4+aF,aq+5+ag,K[cd[a0][1]]["i"][2*(3*(ag-1)+aF)-1],0xffffff,K[cd[a0][1]]["i"][2*(3*(ag-1)+aF)])end end end end;function v._gui.playerInfoPanel.draw()local ap,aq,da=v._gui.playerInfoPanel.x,v._gui.playerInfoPanel.y,v._gui.playerInfoPanel.w/2;k.drawRectangle(ap,aq,v._gui.playerInfoPanel.w+2,1,0x8C8C8C,0," ")local dk=tostring(Q[v._player.id]["cxp"]).."/"..tostring(Q[v._player.id]["mxp"])local dl,dm=math.modf(Q[v._player.id]["cxp"]*100/Q[v._player.id]["mxp"])dm=v._function.roundUpNumber(dm*10)k.drawText(ap+1,aq,0xffffff,"Уровень "..Q[v._player.id]["lvl"])local dn=p(Q[v._player.id]["chp"]).."/"..p(Q[v._player.id]["mhp"])local dp=p(Q[v._player.id]["cmp"]).."/"..p(Q[v._player.id]["mmp"])local dq=dl.."."..dm.."%"v._function.pbar(ap,aq+1,v._gui.playerInfoPanel.w+2,p(Q[v._player.id]["chp"]*100/Q[v._player.id]["mhp"]),0xFF0000,0x5B5B5B," ",0xffffff,1)k.drawText(s(p(da-#dn/2),0),aq+1,0xffffff,dn)v._function.pbar(ap,aq+2,v._gui.playerInfoPanel.w+1,p(Q[v._player.id]["cmp"]*100/Q[v._player.id]["mmp"]),0x0000FF,0x5B5B5B," ",0xffffff,1)k.drawText(s(p(da-#dp/2),0),aq+2,0xffffff,dp)v._function.pbar(ap,aq+3,v._gui.playerInfoPanel.w,dl,0xFFFF00,0x5B5B5B," ",0x333333,1)k.drawText(s(p(da-#dq/2),0),aq+3,0x333333,dq)if di then k.drawText(ap+24-#dk,aq+3,0x4F4F4F,dk)end;dj(ap,aq,Q[v._player.id]["effects"])if v._gui.playerInfoPanel.effectDescription~=0 and Q[v._player.id]["effects"][v._gui.playerInfoPanel.effectDescription]then v._function.drawEffInfo(v._gui.playerInfoPanel.edx,v._gui.playerInfoPanel.edy,Q[v._player.id]["effects"][v._gui.playerInfoPanel.effectDescription][1])end end;v._gui.playerInfoPanel.action["touch"]=function(af)local ci=false;for a0=1,#Q[v._player.id]["effects"]do if af[5]==0 and ao(af[3],af[4],v._gui.playerInfoPanel.x+a0*4-4,v._gui.playerInfoPanel.y+v._gui.playerInfoPanel.h+1,v._gui.playerInfoPanel.x-1+a0*4,v._gui.playerInfoPanel.y+v._gui.playerInfoPanel.h+2)then v._gui.playerInfoPanel.effectDescription=a0;v._gui.playerInfoPanel.edx=af[3]v._gui.playerInfoPanel.edy=af[4]+1;ci=true;break end end;if ci==false then v._gui.playerInfoPanel.effectDescription=0 end end;v._gui.targetInfoPanel={x=60,y=2,w=35,h=4,effectDescription=0,edx=1,edy=1,showTargetInfo=false,action={}}function v._gui.targetInfoPanel.showInfo(ap,aq)local dr=""if type(F[Q[Q[v._player.id]["target"]]["id"]]["wtype"])=="number"then dr=L[F[Q[Q[v._player.id]["target"]]["id"]]["wtype"]]end;local ds={F[Q[Q[v._player.id]["target"]]["id"]]["name"],"Тип: "..dr,"Респ: "..tostring(F[Q[Q[v._player.id]["target"]]["id"]]["vresp"]).." секунд","ID: "..tostring(Q[Q[v._player.id]["target"]]["id"]),"Физ.атака: "..Q[Q[v._player.id]["target"]]["ptk"][1].."-"..Q[Q[v._player.id]["target"]]["ptk"][2],"Маг.атака: "..Q[Q[v._player.id]["target"]]["mtk"][1].."-"..Q[Q[v._player.id]["target"]]["mtk"][2],"Физ.защита: "..tostring(Q[Q[v._player.id]["target"]]["pdef"].." ("..tostring(p(100*Q[Q[v._player.id]["target"]]["pdef"]/(Q[Q[v._player.id]["target"]]["pdef"]+Q[v._player.id]["lvl"]*30))).."%)"),"Маг.защита: "..tostring(Q[Q[v._player.id]["target"]]["mdef"].." ("..tostring(p(100*Q[Q[v._player.id]["target"]]["mdef"]/(Q[Q[v._player.id]["target"]]["mdef"]+Q[v._player.id]["lvl"]*30))).."%)"),"Цель: "..tostring(Q[Q[v._player.id]["target"]]["target"])}k.drawRectangle(ap,aq,27,11,0x6B6B6B,0," ")v._function.unicodeFrame(ap,aq,27,11,0x808080)for a0=1,#ds do k.drawText(ap+1,aq+a0,0xffffff,f.sub(tostring(ds[a0]),1,25))end;ds=nil end;function v._gui.targetInfoPanel.draw()local dt=false;local d8,du,dv;local ap,aq,da=v._gui.targetInfoPanel.x,v._gui.targetInfoPanel.y,v._gui.targetInfoPanel.w/2;k.drawRectangle(ap,aq,v._gui.targetInfoPanel.w,v._gui.targetInfoPanel.h-1,0x9B9B9B,0," ")k.drawRectangle(ap+1,aq+3,v._gui.targetInfoPanel.w-2,1,0x9B9B9B,0," ")k.drawText(ap,aq+3,0x9B9B9B,"◥")k.drawText(ap+v._gui.targetInfoPanel.w-1,aq+3,0x9B9B9B,"◤")local dw=Q[Q[v._player.id]["target"]]["rtype"]if dw==4 or dw==1 or dw==6 then local dx,dy=Q[Q[v._player.id]["target"]]["chp"],Q[Q[v._player.id]["target"]]["mhp"]local dz,dA,dB=0xffffff,Q[Q[v._player.id]["target"]]["lvl"],Q[v._player.id]["lvl"]if dA>=dB+2 and dA<=dB+4 then dz=0xFFDB80 elseif dA>=dB+5 and dA<=dB+7 then dz=0xFF9200 elseif dA>=dB+8 then dz=0xFF1000 elseif dA<=dB-2 and dA>=dB-5 then dz=0xBEBEBE elseif dA<=dB-6 then dz=0x00823A end;local dC={[1]="Физ.",[2]="Маг."}if dw==4 then local dD;if F[Q[Q[v._player.id]["target"]]["id"]]["dtype"]==nil then dD="Обычный"else dD=dC[F[Q[Q[v._player.id]["target"]]["id"]]["dtype"]]end;k.drawText(ap+v._gui.targetInfoPanel.w-f.len(dD)-1,aq+3,0xffffff,dD)end;d8,du=F[Q[Q[v._player.id]["target"]]["id"]]["name"],tostring(Q[Q[v._player.id]["target"]]["lvl"]).." уровень"local cT=q(dx*100/dy)v._function.unicodeFrame(ap,aq,v._gui.targetInfoPanel.w,3,0xA2A2A2)v._function.pbar(ap,aq+1,v._gui.targetInfoPanel.w,cT,0xFF0000,0x5B5B5B," ",0xffffff)k.drawText(ap+s(p(da-f.len(du)/2),0),aq+1,0xffffff,du)k.drawText(ap+s(p(da-f.len(d8)/2),0),aq+2,dz,d8)dt=true elseif dw==2 then du,d8=L[F[Q[Q[v._player.id]["target"]]["id"]]["wtype"]],F[Q[Q[v._player.id]["target"]]["id"]]["name"]k.drawText(ap,aq,0x727272,"НИП")dv="Нажмите 'E' чтобы открыть диалог"k.drawText(ap+s(p(da-f.len(d8)/2),0),aq+1,0xffffff,d8)k.drawText(ap+s(p(da-f.len(du)/2),0),aq+2,0xC8C8C8,du)k.drawText(ap+s(p(da-f.len(dv)/2),0),aq+3,0x727272,dv)dt=false elseif dw==5 then k.drawText(ap,aq,0x727272,"Ресурс")dv="Нажмите 'E' чтобы собрать"k.drawText(ap+s(p(da-f.len(F[Q[Q[v._player.id]["target"]]["id"]]["name"])/2),0),aq+1,0xffffff,F[Q[Q[v._player.id]["target"]]["id"]]["name"])k.drawText(ap+s(p(da-f.len(dv)/2),0),aq+2,0x727272,dv)dt=false elseif dw==3 then dv="Нажмите 'E' чтобы использовать"k.drawText(ap+s(p(da-f.len(F[Q[Q[v._player.id]["target"]]["id"]]["name"])/2),0),aq+1,0xffffff,F[Q[Q[v._player.id]["target"]]["id"]]["name"])k.drawText(ap+s(p(da-f.len(dv)/2),0),aq+2,0x727272,dv)dt=false end;if dt then k.drawText(ap+1,aq+3,0xffffff,"О персонаже")end;dj(ap,aq-1,Q[Q[v._player.id]["target"]]["effects"])if v._gui.targetInfoPanel.showTargetInfo then v._gui.targetInfoPanel.showInfo(ap+1,aq+4)end;if v._gui.targetInfoPanel.effectDescription~=0 and Q[Q[v._player.id]["target"]]["effects"][v._gui.targetInfoPanel.effectDescription]then v._function.drawEffInfo(v._gui.targetInfoPanel.edx,v._gui.targetInfoPanel.edy,Q[Q[v._player.id]["target"]]["effects"][v._gui.targetInfoPanel.effectDescription][1])end end;v._gui.targetInfoPanel.action["touch"]=function(af)local ci=false;if Q[v._player.id]["target"]then for a0=1,#Q[Q[v._player.id]["target"]]["effects"]do if af[5]==0 and ao(af[3],af[4],v._gui.targetInfoPanel.x+a0*4-4,v._gui.targetInfoPanel.y+v._gui.targetInfoPanel.h+1,v._gui.targetInfoPanel.x+a0*4-1,v._gui.targetInfoPanel.y+v._gui.targetInfoPanel.h+2)then v._gui.targetInfoPanel.effectDescription=a0;v._gui.targetInfoPanel.edx=af[3]v._gui.targetInfoPanel.edy=af[4]+1;ci=true;break end end end;if ci==false then v._gui.targetInfoPanel.effectDescription=0 end;if v._data.windowThread==nil and af[5]==0 and Q[v._player.id]["target"]then if ao(af[3],af[4],v._gui.targetInfoPanel.x,v._gui.targetInfoPanel.y+v._gui.targetInfoPanel.h-1,v._gui.targetInfoPanel.x+v._gui.targetInfoPanel.w-1,v._gui.targetInfoPanel.y+v._gui.targetInfoPanel.h-1)then if F[Q[Q[v._player.id]["target"]]["id"]]["rtype"]~=5 and F[Q[Q[v._player.id]["target"]]["id"]]["rtype"]~=2 then v._gui.targetInfoPanel.showTargetInfo=true end else v._gui.targetInfoPanel.showTargetInfo=false end end end;local dE,dF=0,{}function v._gui.skillsTopPanel.draw()local ap,aq,aF,ag=v._gui.skillsTopPanel.x,v._gui.skillsTopPanel.y,v._gui.skillsTopPanel.w,v._gui.skillsTopPanel.h;k.drawRectangle(ap,aq,aF,ag,0x9B9B9B,0," ")v._function.unicodeFrame(ap,aq,aF,ag,0x6B6B6B)for a0=1,#v._gui.skillsTopPanel.t do k.drawRectangle(ap+3+a0*5-5,aq+1,2,1,v._gui.skillsTopPanel.t[a0].c,0," ")k.drawText(ap+3+a0*5-5,aq+1,0xffffff,v._gui.skillsTopPanel.t[a0].t)if v._player.actSkills[a0+1]>0 then k.drawText(ap+3+a0*5-5,aq+2,0xffffff,tostring(q(v._player.skills[v._player.actSkills[a0+1]][2]/10)))end end;if dE>0 then k.drawText(ap+2,aq+3,0xC1C1C1,dF[#dF])end end;v._gui.followerInfo={x=1,y=9,w=20,h=3,action={}}function v._gui.followerInfo.draw()if Q[v._player.id]["followers"]and#Q[v._player.id]["followers"]>0 then local ap,aq=v._gui.followerInfo.x,v._gui.followerInfo.y;k.drawRectangle(ap,aq,v._gui.followerInfo.w,1+#Q[v._player.id]["followers"]*3,0x9B9B9B,0," ")for a0=1,#Q[v._player.id]["followers"]do k.drawText(ap,aq+a0*3-3,0xffffff,F[Q[v._player.id]["followers"][a0][1]]["name"].." ур."..Q[Q[v._player.id]["followers"][a0][2]]["lvl"])v._function.pbar(ap,aq+a0*3-2,v._gui.followerInfo.w,q(Q[Q[v._player.id]["followers"][a0][2]]["chp"]*100/Q[Q[v._player.id]["followers"][a0][2]]["mhp"]),0xFF0000,0x5B5B5B,q(Q[Q[v._player.id]["followers"][a0][2]]["chp"]).."/"..q(Q[Q[v._player.id]["followers"][a0][2]]["mhp"]),0xffffff)v._function.pbar(ap,aq+a0*3-1,v._gui.followerInfo.w,q(Q[Q[v._player.id]["followers"][a0][2]]["cxp"]*100/Q[Q[v._player.id]["followers"][a0][2]]["mxp"]),0xFFFF00,0x5B5B5B,q(Q[Q[v._player.id]["followers"][a0][2]]["cxp"]).."/"..q(Q[Q[v._player.id]["followers"][a0][2]]["mxp"]),0x222222)end end end;v._gui.followerInfo.action["touch"]=function(af)if Q[v._player.id]["followers"]and#Q[v._player.id]["followers"]>0 then local ap,aq=v._gui.followerInfo.x,v._gui.followerInfo.y;for a0=1,#Q[v._player.id]["followers"]do if af[5]==0 and ao(af[3],af[4],ap,aq+a0*3-3,ap+v._gui.followerInfo.w-1,aq+a0*3)then Q[v._player.id]["target"]=Q[v._player.id]["followers"][a0][2]break end end end end;v._gui.NPCDialog={window={x=12,y=10,w=50,h=24,title=""},action={}}function v._gui.NPCDialog.init()v._gui.NPCDialog.text=v._function.textWrap(v._gui.NPCDialog.currentDialog["text"],v._gui.NPCDialog.window.w-4)end;function v._gui.NPCDialog.start(dG)v._player.moving=false;C=0;b4(0)v._data.paused=true;v._data.windowThread="dialog"v._function.dialogsdata,v._function.gddnum=io.open(v._data.text.directory.."data/dialogs.data",'r'),1;for dH in v._function.dialogsdata:lines()do if v._function.gddnum==F[Q[dG]["id"]]["dialog"]then v._gui.NPCDialog.currentDialog=load("return "..dH)()break end;v._function.gddnum=v._function.gddnum+1 end;v._function.dialogsdata:close()v._function.dialogsdata=nil;v._gui.NPCDialog.currentDialog["im"]=0;v._gui.NPCDialog.currentDialog=bc(dG,v._gui.NPCDialog.currentDialog)v._gui.NPCDialog.init()end;local function dI(dJ,bk)if H[bk]["minlvl"]>Q[dJ]["lvl"]or H[bk]["comp"]>0 then return false end;return true end;function v._gui.NPCDialog.draw(ap,aq)local ap,aq,aF,ag=v._gui.NPCDialog.window.x,v._gui.NPCDialog.window.y,v._gui.NPCDialog.window.w,v._gui.NPCDialog.window.h;local dK,dL,dM=false,false;v._gui.blank.draw(v._gui.NPCDialog.window,F[Q[Q[v._player.id]["target"]]["id"]]["name"])k.drawRectangle(ap+1,aq+14,aF-2,9,0x7A7A7A,0," ")k.drawRectangle(ap+1,aq+1,aF-2,12,0x7A7A7A,0," ")for a0=#v._gui.NPCDialog.currentDialog,1,-1 do if not v._gui.NPCDialog.currentDialog[a0]then o(v._gui.NPCDialog.currentDialog,a0)end end;for a0=1,#v._gui.NPCDialog.currentDialog do dK=false;if v._gui.NPCDialog.currentDialog[#v._gui.NPCDialog.currentDialog-a0+1]~=nil then if v._gui.NPCDialog.currentDialog[#v._gui.NPCDialog.currentDialog-a0+1]["action"]=="qdialog"then for dN=1,#v._player.quests do if v._player.quests[dN][1]==v._gui.NPCDialog.currentDialog[#v._gui.NPCDialog.currentDialog-a0+1]["q"]and v._player.quests[dN][3]==false then dK=true;break end end end;if v._gui.NPCDialog.currentDialog[#v._gui.NPCDialog.currentDialog-a0+1]~=nil and v._gui.NPCDialog.currentDialog[#v._gui.NPCDialog.currentDialog-a0+1]["action"]=="qdialog"then if dK or not dI(v._player.id,v._gui.NPCDialog.currentDialog[#v._gui.NPCDialog.currentDialog-a0+1]["q"])then o(v._gui.NPCDialog.currentDialog,#v._gui.NPCDialog.currentDialog-a0+1)end elseif v._gui.NPCDialog.currentDialog[#v._gui.NPCDialog.currentDialog-a0+1]["action"]=="setWorld"and Q[v._player.id]["lvl"]<v._gui.NPCDialog.currentDialog[#v._gui.NPCDialog.currentDialog-a0+1]["reqlvl"]then v._gui.NPCDialog.currentDialog[#v._gui.NPCDialog.currentDialog-a0+1]["text"]=f.sub(v._gui.NPCDialog.currentDialog[#v._gui.NPCDialog.currentDialog-a0+1]["text"],1,f.len(v._gui.NPCDialog.currentDialog[#v._gui.NPCDialog.currentDialog-a0+1]["text"])-#tostring(v._gui.NPCDialog.currentDialog[#v._gui.NPCDialog.currentDialog-a0+1]["reqlvl"])-2)v._gui.NPCDialog.currentDialog[#v._gui.NPCDialog.currentDialog-a0+1]["text"]=v._gui.NPCDialog.currentDialog[#v._gui.NPCDialog.currentDialog-a0+1]["text"].." "..v._gui.NPCDialog.currentDialog[#v._gui.NPCDialog.currentDialog-a0+1]["reqlvl"].."+"end end end;for a0=1,#v._gui.NPCDialog.text do k.drawText(ap+2,aq+1+a0,0xffffff,v._gui.NPCDialog.text[a0])end;for a0=1,#v._gui.NPCDialog.currentDialog do dM=0xffffff;dK,dL=false,false;for dN=1,#v._player.quests do if v._gui.NPCDialog.currentDialog[a0]and v._gui.NPCDialog.currentDialog[a0]["action"]=="qdialog"then if v._player.quests[dN][1]==v._gui.NPCDialog.currentDialog[a0]["q"]and not v._player.quests[dN][3]then dK=true end elseif v._gui.NPCDialog.currentDialog[a0]and v._gui.NPCDialog.currentDialog[a0]["action"]=="cmpquest"then dL=true end end;if dK then dM=0x555555 elseif dL then dM=0x1AB235 end;if v._gui.NPCDialog.currentDialog[a0]then k.drawText(ap+2,aq+14+a0,dM,v._gui.NPCDialog.currentDialog[a0]["text"])end end end;v._gui.NPCDialog.action["touch"]=function(af)local ap,aq,aF,ag=v._gui.NPCDialog.window.x,v._gui.NPCDialog.window.y,v._gui.NPCDialog.window.w,v._gui.NPCDialog.window.h;local dO;local dP=false;local dQ=ap+aF-1;v._gui.NPCDialog.init()for a0=1,#v._gui.NPCDialog.currentDialog do if af[5]==0 and ao(af[3],af[4],ap+2,aq+14+a0,ap+aF-2,aq+14+a0)then if v._gui.NPCDialog.currentDialog[a0]["action"]=="close"then dP=true elseif v._gui.NPCDialog.currentDialog[a0]["action"]=="trade"then v._function.tradew.loaded=loadfile(v._data.text.directory.."data/trading.data")(v._gui.NPCDialog.currentDialog[a0]["do"])v._function.tradew.sect=1;v._data.windowThread="tradeWindow"v._gui.NPCDialog.text=""elseif v._gui.NPCDialog.currentDialog[a0]["action"]=="craft"then v._function.craftw.loaded=loadfile(v._data.text.directory.."data/crafting.data")(v._gui.NPCDialog.currentDialog[a0]["do"])v._function.craftw.sect=1;v._data.windowThread="craftWindow"v._gui.NPCDialog.text=""elseif v._gui.NPCDialog.currentDialog[a0]["action"]=="dialog"then v._gui.NPCDialog.currentDialog=v._gui.NPCDialog.currentDialog[a0]["do"]v._gui.NPCDialog.init()elseif v._gui.NPCDialog.currentDialog[a0]["action"]=="qdialog"and dI(v._player.id,v._gui.NPCDialog.currentDialog[a0]["q"])then v._gui.NPCDialog.currentDialog=v._gui.NPCDialog.currentDialog[a0]["do"]v._gui.NPCDialog.init()elseif v._gui.NPCDialog.currentDialog[a0]["action"]=="getquest"and H[v._gui.NPCDialog.currentDialog[a0]["do"]]["comp"]==0 and Q[v._player.id]["lvl"]>=H[v._gui.NPCDialog.currentDialog[a0]["do"]]["minlvl"]then v._function.getQuest(v._gui.NPCDialog.currentDialog[a0]["do"])H[v._gui.NPCDialog.currentDialog[a0]["do"]]["givingQuest"]=Q[Q[v._player.id]["target"]]["id"]H[v._gui.NPCDialog.currentDialog[a0]["do"]]["comp"]=1;dP=true elseif v._gui.NPCDialog.currentDialog[a0]["action"]=="cmpquest"then for cm=1,#v._player.quests do if v._player.quests[cm][1]==v._gui.NPCDialog.currentDialog[a0]["do"]and v._player.quests[cm][3]then if H[v._gui.NPCDialog.currentDialog[a0]["do"]]["type"]==2 then for dN=1,#H[v._gui.NPCDialog.currentDialog[a0]["do"]]["targ"]do v._function.removeItem(H[v._gui.NPCDialog.currentDialog[a0]["do"]]["targ"][dN][1],H[v._gui.NPCDialog.currentDialog[a0]["do"]]["targ"][dN][2])end end;if H[v._gui.NPCDialog.currentDialog[a0]["do"]]["qreward"]then if type(H[v._gui.NPCDialog.currentDialog[a0]["do"]]["qreward"]["item"])=="table"then if#H[v._gui.NPCDialog.currentDialog[a0]["do"]]["qreward"]["item"]<=v._function.checkInventorySpace()then v._function.getQuestReward(v._gui.NPCDialog.currentDialog[a0]["do"])dO=true elseif#H[v._gui.NPCDialog.currentDialog[a0]["do"]]["qreward"]["item"]>v._function.checkInventorySpace()then v._function.showMessage1("Необходимо "..#H[v._gui.NPCDialog.currentDialog[a0]["do"]]["qreward"]["item"].." ячеек в инвентаре")dO=false end elseif H[v._gui.NPCDialog.currentDialog[a0]["do"]]["qreward"]["item"]==nil then dO=true;v._function.getQuestReward(v._gui.NPCDialog.currentDialog[a0]["do"])end end;if dO then if not H[v._gui.NPCDialog.currentDialog[a0]["do"]]["afterCompleted"]then o(v._player.quests,cm)if v._data.windowThread~="rewardChoice"then dP=true end;v._gui.NPCDialog.currentDialog=nil;break elseif H[v._gui.NPCDialog.currentDialog[a0]["do"]]["afterCompleted"]then if H[v._gui.NPCDialog.currentDialog[a0]["do"]]["afterCompleted"]=="setquest"then v._function.getQuest(H[v._gui.NPCDialog.currentDialog[a0]["do"]]["value"])v._function.showMessage1("Задание '"..H[H[v._gui.NPCDialog.currentDialog[a0]["do"]]["value"]]["name"].."' получено")H[H[v._gui.NPCDialog.currentDialog[a0]["do"]]["value"]]["givingQuest"]=Q[Q[v._player.id]["target"]]["id"]H[H[v._gui.NPCDialog.currentDialog[a0]["do"]]["value"]]["comp"]=1;o(v._player.quests,cm)dP=true;break end end;v._gui.qPanel.update()end;if H[v._gui.NPCDialog.currentDialog[a0]["do"]]["repeat"]==true then H[v._gui.NPCDialog.currentDialog[a0]["do"]]["comp"]=0 else H[v._gui.NPCDialog.currentDialog[a0]["do"]]["comp"]=2 end end end elseif v._gui.NPCDialog.currentDialog[a0]["action"]=="setWorld"and Q[v._player.id]["lvl"]>=v._gui.NPCDialog.currentDialog[a0]["reqlvl"]then v._function.teleport(v._gui.NPCDialog.currentDialog[a0]["do"][2]or 1,v._gui.NPCDialog.currentDialog[a0]["do"][1]or 1)end end end;if ao(af[3],af[4],dQ,aq,dQ,aq)then dP=true end;if dP then v._gui.NPCDialog.text=""v._data.windowThread=nil;v._gui.NPCDialog.currentDialog=nil;v._data.paused=false end end;v._gui.rewardChoice={x=0,y=15,w=0,h=18,button1={x=0,y=13,w=16,h=3,c=0x838383,t="Выбрать"},buffer={items={},images={},targ=nil},action={}}function v._gui.rewardChoice.draw()v._gui.rewardChoice.w=5+#v._gui.rewardChoice.buffer.items*23;v._gui.rewardChoice.x=p(t/2-v._gui.rewardChoice.w/2)local ap,aq=v._gui.rewardChoice.x,v._gui.rewardChoice.y;local dg,ccolor,ar,as="Выбор награды"k.drawRectangle(ap,aq,v._gui.rewardChoice.w,v._gui.rewardChoice.h,0x9B9B9B,0," ")k.drawRectangle(ap,aq,v._gui.rewardChoice.w,1,0x525252,0," ")k.drawText(ap+p(v._gui.rewardChoice.w/2-f.len(dg)/2),aq,0xffffff,dg)for a0=1,#v._gui.rewardChoice.buffer.items do ar=ap+4;as=aq+2;ccolor=0x4A4A4A;if a0==v._gui.rewardChoice.buffer.targ then ccolor=0x009922 end;for an=1,22 do k.drawText(ar+a0*23-25+an,as-1,ccolor,"▄")k.drawText(ar+a0*23-25+an,as+10,ccolor,"▀")end;k.drawRectangle(ar+a0*23-24,as,22,10,ccolor,0," ")k.drawImage(ar+a0*23-23,as,v._gui.rewardChoice.buffer.images[a0])end;ccolor=0x4A4A4A;if v._gui.rewardChoice.buffer.targ then v._function.drawItemDescription(ap+v._gui.rewardChoice.w,aq)ccolor=v._gui.rewardChoice.button1.c end;v._gui.rewardChoice.button1.x=ap+p(v._gui.rewardChoice.w/2-v._gui.rewardChoice.button1.w/2)k.drawRectangle(v._gui.rewardChoice.button1.x,aq+v._gui.rewardChoice.button1.y,v._gui.rewardChoice.button1.w,v._gui.rewardChoice.button1.h,ccolor,0," ")k.drawText(v._gui.rewardChoice.button1.x+p(v._gui.rewardChoice.button1.w/2-f.len(v._gui.rewardChoice.button1.t)/2),aq+v._gui.rewardChoice.button1.y+1,0xFFFFFF,v._gui.rewardChoice.button1.t)end;v._gui.rewardChoice.action["touch"]=function(af)for a0=1,#v._gui.rewardChoice.buffer.items do if af[5]==0 and ao(af[3],af[4],v._gui.rewardChoice.x+4+a0*23-23,v._gui.rewardChoice.y+2,v._gui.rewardChoice.x+4+a0*23-2,v._gui.rewardChoice.y+11)then v._gui.rewardChoice.buffer.targ=a0;v._function.getItemInfo(v._gui.rewardChoice.buffer.items[v._gui.rewardChoice.buffer.targ][1],v._gui.rewardChoice.buffer.items[v._gui.rewardChoice.buffer.targ][2])break end end;if af[5]==0 and ao(af[3],af[4],v._gui.rewardChoice.button1.x,v._gui.rewardChoice.y+v._gui.rewardChoice.button1.y,v._gui.rewardChoice.button1.x+v._gui.rewardChoice.button1.w-1,v._gui.rewardChoice.y+v._gui.rewardChoice.button1.y+v._gui.rewardChoice.button1.h-1)and v._gui.rewardChoice.buffer.targ then v._function.addItem(v._gui.rewardChoice.buffer.items[v._gui.rewardChoice.buffer.targ][1],v._gui.rewardChoice.buffer.items[v._gui.rewardChoice.buffer.targ][2],true)v._data.windowThread=nil;v._data.paused=false;v._gui.rewardChoice.buffer.items={}v._gui.rewardChoice.buffer.images={}v._gui.rewardChoice.buffer.targ=nil end end;local dR=0;local dS,dT=0,false;local dU,dV=1,1;function v._function.getItemInfo(b2,bR)local dW;bR=bR or 1;local function dX(cm,aG)n(v._data.itemInfo,{tostring(cm),aG})end;if G[b2]then local dY,dZ=G[b2]["type"],G[b2]["subtype"]local ccolor;v._data.itemInfo={}dX(G[b2]["name"],G[b2]["ncolor"]or 0xffffff)if dY==2 or dY==3 then dX(v._data.itemSubtypes[dY][dZ],0xBCBCBC)dX("Уровень "..tostring(G[b2]["lvl"]),0xffffff)end;if dY==1 then if dZ==1 then dX("Уровень материала "..tostring(G[b2]["lvl"]),0xffffff)elseif dZ==2 then dX("Предмет для задания. Нельзя выбросить иили продать.",0xffffff)end elseif dY==2 then if G[b2]["props"]["pdef"]~=0 then dX("Защита +"..tostring(G[b2]["props"]["pdef"]),0xEFEFEF)end;if G[b2]["props"]["mdef"]~=0 then dX("Магическая защита +"..tostring(G[b2]["props"]["mdef"]),0xEFEFEF)end elseif dY==3 then dX("Скорость атаки: "..tostring(q(1/U[G[b2]["subtype"]]*10)/10).." уд./сек.",0xEFEFEF)dX("Дальность атаки: "..v._function.watds[G[b2]["subtype"]],0xEFEFEF)if G[b2]["props"]["phisat"]and G[b2]["props"]["phisat"]~=0 then dX("Физическая атака "..G[b2]["props"]["phisat"][1].."-"..G[b2]["props"]["phisat"][2],0xffffff)end;if G[b2]["props"]["magat"]and G[b2]["props"]["magat"]~=0 then dX("Магическая атака "..G[b2]["props"]["magat"][1].."-"..G[b2]["props"]["magat"][2],0xffffff)end elseif dY==5 then dX("Нажмите ПКМ чтобы открыть.",0xffffff)elseif dY==7 then dX("Восстанавливает "..tostring(G[b2]["props"]["ics"]).."% здоровья, если оно ниже "..tostring(G[b2]["props"]["r"]).."%",0xEFEFEF)elseif dY==8 then dX("Нажмите ПКМ чтобы добавить в союзники",0xffffff)elseif dY==9 then dX("Нажмите ПКМ чтобы получить "..tostring(G[b2]["props"][1]).." ед. опыта.",0xffffff)end;if dY==2 or dY==3 or dY==4 then if dY==4 and G[b2]["subtype"]==1 then dX("Восстановить "..tostring(K[1]["val"][G[b2]["lvl"]]).." ед. здоровья за 10 секунд.",0xEFEFEF)elseif dY==4 and G[b2]["subtype"]==2 then dX("Восстановить "..tostring(K[2]["val"][G[b2]["lvl"]]).." ед. маны за 10 секунд.",0xEFEFEF)end;if G[b2]["required"]then for c0,ci in pairs(G[b2]["required"])do ccolor=0xFFFFFF;if G[b2]["required"][c0]>Q[v._player.id][c0]then ccolor=0xFF0000 end;dX(v._data.itemReqNames[c0]..ci,ccolor)end end;if dY==2 or dY==3 then local dW;if G[b2]["props"]["dds"]~=nil then for e=1,#G[b2]["props"]["dds"]do dW=""if G[b2]["props"]["dds"][e]and G[b2]["props"]["dds"][e][2]>0 then if#v._data.itemStatsNames[G[b2]["props"]["dds"][e][1]]>=2 then dW=v._data.itemStatsNames[G[b2]["props"]["dds"][e][1]][2]end;dX(v._data.itemStatsNames[G[b2]["props"]["dds"][e][1]][1].." + "..G[b2]["props"]["dds"][e][2]..dW,z.blue)end end end end end;local d_;if G[b2]["description"]and G[b2]["description"]~=""then d_=v._function.textWrap(G[b2]["description"],30)for a0=1,#d_ do dX(d_[a0],0xBCBCBC)end end;dW=""if bR>1 then dW=" ("..tostring(G[b2]["cost"]*bR)..")"end;dX("Цена "..tostring(G[b2]["cost"])..dW,0xffffff)end end;function v._function.drawItemDescription(ap,aq)local cd=v._data.itemInfo;if not cd then cd={{"Неправильный предмет",0xFF0000}}end;local aF,ag=0,#cd;for a0=1,#cd do if f.len(cd[a0][1])>aF then aF=f.len(cd[a0][1])end end;k.drawRectangle(r(ap-1,159-aF),r(aq-1,49-ag),aF+2,ag+2,0x6B6B6B,0," ")v._function.unicodeFrame(r(ap-1,159-aF),r(aq-1,49-ag),aF+2,ag+2,0x808080)for a0=1,#cd do k.drawText(r(ap,160-aF),r(aq+a0-1,50-ag+a0-1),cd[a0][2],cd[a0][1])end end;function v._function.unloadImage(e0)e0[3]=nil;e0[4]=nil;e0[5]=nil;e0[6]=nil end;function v._function.cleanIconImageBuffer()for c0,c1 in pairs(P)do v._function.unloadImage(P[c0])end;P={}end;v._gui.inventory={x=1,y=1,w=160,h=50,ax=117,ay=3,b1={x=2,y=47,w=14},target=0,action={}}function v._gui.inventory.open()v._data.windowThread="inventory"P[0]={}for e1=1,#v._data.emptyArmorPic do if v._function.mCheck()then P[0][v._data.emptyArmorPic[e1][1]]=c.load(v._data.text.directory..v._data.emptyArmorPic[e1][2])end end;for a0=1,#v._player.inventory["bag"]do if v._player.inventory["bag"][a0][1]~=0 and v._player.inventory["bag"][a0][2]~=0 and G[v._player.inventory["bag"][a0][1]]and v._function.mCheck()then P[a0]=c.load(v._data.text.directory.."itempic/"..v._data.itemIcons[G[v._player.inventory["bag"][a0][1]]["icon"]]..".pic")end end;for a0=1,#v._data.armorType do if v._player.inventory["weared"][v._data.armorType[a0]][1]~=0 and v._function.mCheck()then P[v._data.armorType[a0]]=c.load(v._data.text.directory.."itempic/"..v._data.itemIcons[G[v._player.inventory["weared"][v._data.armorType[a0]][1]]["icon"]]..".pic")end end end;function v._gui.inventory.close()end;function v._gui.inventory.draw()local ap,aq,aF,ag=v._gui.inventory.x,v._gui.inventory.y,v._gui.inventory.w,v._gui.inventory.h;local e2,e3=v._gui.inventory.ax,v._gui.inventory.ay;local e4,e5,e6;local dY;local e7="Выбросить предмет(ы)"k.drawRectangle(ap,aq,aF,ag,0x9B9B9B,0," ")k.drawRectangle(ap,aq,aF,1,0x525252,0," ")k.drawRectangle(ap,aq+ag-1,aF,1,0x525252,0," ")k.drawRectangle(ap,aq+1,aF-2,ag-5,0x4A4A4A,0," ")k.drawText(ap+1,aq,0xC4C420,"●•. Монеты: "..tostring(v._player.coins))k.drawText(ap+75,aq,0xffffff,"Инвентарь")k.drawText(ap+152,aq,0xffffff,"Закрыть")k.drawText(ap+1,aq+47,0x444444,bo)for as=1,4 do for ar=1,5 do e4,e5,e6=(as-1)*5+ar,ap+1+ar*21-21,aq+2+as*11-11;if v._player.inventory["bag"][e4][1]~=0 and v._player.inventory["bag"][e4][2]~=0 then if P[e4]then if G[v._player.inventory["bag"][e4][1]]then k.drawImage(e5,e6,P[e4])if v._player.inventory["bag"][e4][2]>1 then k.drawRectangle(e5,e6+9,#tostring(v._player.inventory["bag"][e4][2]),1,0x4A4A4A,0," ")k.drawText(e5,e6+9,0xffffff,tostring(v._player.inventory["bag"][e4][2]))end else k.drawImage(e5,e6,c.load(v._data.text.directory.."image/itemnotex.pic"))end else k.drawRectangle(e5,e6,20,10,0x00,0," ")end else k.drawRectangle(e5,e6,20,10,0x767676,0," ")end end end;for as=1,4 do for ar=1,2 do e4,e5,e6=(as-1)*2+ar,e2+ar*21-21,e3+as*11-11;dY=v._data.armorType[e4]if v._player.inventory["weared"][dY][1]~=0 then if P[dY]then if G[v._player.inventory["weared"][dY][1]]then k.drawImage(e5,e6,P[dY])else k.drawImage(e5,e6,c.load(v._data.text.directory.."image/itemnotex.pic"))end else k.drawRectangle(e5,e6,20,10,0x00,0," ")end else if P[0][dY]then k.drawImage(e5,e6,P[0][dY])else k.drawRectangle(e5,e6,20,10,0x00,0," ")end end end end;if dT and dS~=0 then k.drawRectangle(v._gui.inventory.b1.x,v._gui.inventory.b1.y,f.len(e7),1,0x3c539e,0," ")k.drawText(v._gui.inventory.b1.x,v._gui.inventory.b1.y,0xFEFEFE,e7)v._function.drawItemDescription(dU,dV)end end;v._gui.inventory.action["touch"]=function(af)local ap,aq,aF,ag=v._gui.inventory.x,v._gui.inventory.y,v._gui.inventory.w,v._gui.inventory.h;local e2,e3=v._gui.inventory.ax,v._gui.inventory.ay;local e4,e8,e9;local dY;if ao(af[3],af[4],ap+aF-8,aq,ap+aF-1,aq)then v._data.windowThread="pause"v._function.cleanIconImageBuffer()end;if dT and v._gui.inventory.target~=0 and ao(af[3],af[4],v._gui.inventory.b1.x,v._gui.inventory.b1.y,v._gui.inventory.b1.x+v._gui.inventory.b1.w,v._gui.inventory.b1.y)then if v._player.inventory["bag"][v._gui.inventory.target][1]>=v._config.reservedItemId then G[v._player.inventory["bag"][v._gui.inventory.target][1]]=nil end;v._player.inventory["bag"][v._gui.inventory.target]={0,0,{}}v._function.unloadImage(P[v._gui.inventory.target])P[v._gui.inventory.target]=nil;dT,v._gui.inventory.target=false,0 end;local ea=true;local cp,eb,e5,e6;for a0=1,4 do for ae=1,5 do e5,e6=2+ae*21-21,3+a0*11-11;e4=(a0-1)*5+ae;if v._player.inventory["bag"][e4][1]~=0 and v._player.inventory["bag"][e4][2]~=0 then if ao(af[3],af[4],e5,e6,e5+19,e6+9)then e8=G[v._player.inventory["bag"][e4][1]]if af[5]==0 then dS=v._player.inventory["bag"][e4][1]v._gui.inventory.target=e4;dR=v._player.inventory["bag"][e4][2]v._function.getItemInfo(v._player.inventory["bag"][e4][1])dT=true;dU,dV=af[3],af[4]ea=false;break elseif af[5]==1 and G[v._player.inventory["bag"][e4][1]]then if e8["type"]==2 and v._function.getItemRequirement(v._player.inventory["bag"][e4][1])then e9=v._function.getArmorType(v._player.inventory["bag"][e4][1])if v._player.inventory["weared"][e9][1]==0 then v._player.inventory["weared"][e9]=v._player.inventory["bag"][e4]P[e9]=P[e4]v._player.inventory["bag"][e4]={0,0,{}}P[e4]=nil else cp=v._player.inventory["weared"][e9]eb=P[e9]v._player.inventory["weared"][e9]=v._player.inventory["bag"][e4]P[e9]=P[e4]P[e4]=eb;v._player.inventory["bag"][e4]=cp;eb=nil end elseif e8["type"]==3 and v._function.getItemRequirement(v._player.inventory["bag"][e4][1])then if v._player.inventory["weared"]["weapon"][1]==0 then v._player.inventory["weared"]["weapon"]=v._player.inventory["bag"][e4]P["weapon"]=P[e4]v._player.inventory["bag"][e4]={0,0,{}}P[e4]=nil else cp=v._player.inventory["weared"]["weapon"]eb=P["weapon"]v._player.inventory["weared"]["weapon"]=v._player.inventory["bag"][e4]P["weapon"]=P[e4]P[e4]=eb;v._player.inventory["bag"][e4]=cp;eb=nil end elseif e8["type"]==5 then for cm=1,#e8["props"]do if 10^3-e8["props"][cm][3]*10<=v._function.random(1,10^3)then v._function.addItem(e8["props"][cm][1],e8["props"][cm][2],true)break end end;v._function.textmsg3("Использован предмет "..e8["name"])bP(e4,1)elseif e8["type"]==6 then Q[v._player.id]["x"],A,B=1,1,1;v._function.textmsg3("Использован предмет "..e8["name"])bP(e4,1)elseif e8["type"]==4 and Q[v._player.id]["lvl"]>=e8["required"]["lvl"]then if e8["subtype"]==1 then v._function.addUnitEffect(v._player.id,1,e8["lvl"])bP(e4,1)elseif e8["subtype"]==2 then v._function.addUnitEffect(v._player.id,2,e8["lvl"])bP(e4,1)end;v._function.textmsg3("Использован предмет "..e8["name"])elseif e8["type"]==8 then n(Q[v._player.id]["petcage"],{["id"]=e8["subtype"],["lvl"]=F[e8["subtype"]]["lvl"],["cxp"]=0,["chp"]=1})bP(e4,1)elseif e8["type"]==9 then cw(e8["props"][1])bP(e4,1)end;cp=nil;break end end end;e4=nil end end;for a0=1,4 do for ae=1,2 do e4,e5,e6=(a0-1)*2+ae,e2+ae*21-21,e3+a0*11-11;dY=v._data.armorType[e4]if v._player.inventory["weared"][dY][1]~=0 then if ao(af[3],af[4],e5,e6,e5+19,e6+9)then if af[5]==0 then dS=v._player.inventory["weared"][dY][1]dR=1;dT=true;v._function.getItemInfo(v._player.inventory["weared"][dY][1])dU,dV=af[3],af[4]ea=false;break elseif af[5]==1 then for an=1,#v._player.inventory["bag"]do if v._player.inventory["bag"][an][1]==0 then v._player.inventory["bag"][an]=v._player.inventory["weared"][dY]P[an]=P[dY]v._player.inventory["weared"][dY]={0,0,{}}P[dY]=nil;break end end end end else if ao(af[3],af[4],e5,e6,e5+19,e6+9)then if af[5]==0 then dS=1;dT=true;v._data.itemInfo={{v._function.getWitemTypeName(dY),0xFFFFFF}}dU,dV=af[3],af[4]ea=false end end end;e4=nil end end;if ea then v._gui.inventory.target=0;dR=0;dT=false;dU,dV=1,1 end;v._function.UpdatePlayerStats()end;function v._function.genitiveWordEnding(ec,ed)local ee,ef,eg=tonumber(string.sub(tostring(ed),-1,-1)),tonumber(string.sub(tostring(ed),-2,-2)),""if ee==1 then eg="а"elseif ee>=2 and ee<=4 then eg="ы"elseif ee>=5 and ee<=9 then eg=""end;if ef==1 or ee==0 then eg=""end;return ec..eg end;v._function.tradew={action={},loaded={},titem=0,titemcount=1,sect=1,tScrl=1,torg=1,asmt={},x=1,y=1,w=160,h=50,cWidth=50,cHeight=15}v._function.tradew.twx=p(80-v._function.tradew.cWidth/2)v._function.tradew.twy=p(25-v._function.tradew.cHeight/2)function v._function.tradew.draw()local ap,aq=v._function.tradew.x,v._function.tradew.y;k.drawRectangle(ap,aq,v._function.tradew.w,v._function.tradew.h,0x9B9B9B,0," ")k.drawRectangle(ap,aq,v._function.tradew.w,1,0x525252,0," ")k.drawRectangle(ap,aq+1,v._function.tradew.w,3,0x747474,0," ")local eh;local cm="Торговля"k.drawText(s(80-f.len(cm)/2,0),aq,0xffffff,cm)k.drawText(ap+v._function.tradew.w-9,aq,0xffffff,"Закрыть")k.drawText(ap+1,aq,0xffffff,"Монеты "..v._player.coins)eh={"Перейти к продаже","Перейти к покупке"}k.drawRectangle(ap+118,aq+1,f.len(eh[v._function.tradew.torg])+2,3,0x8a8a8a,0," ")k.drawText(ap+119,aq+2,0xffffff,eh[v._function.tradew.torg])if v._function.tradew.torg==1 then k.drawText(ap+1,aq+3,0xC2C2C2,"Наименование")k.drawText(ap+65,aq+3,0xC2C2C2,"Цена за единицу")for a0=1,#v._function.tradew.loaded do if v._function.tradew.sect==a0 then eh=0x525252 else eh=0x606060 end;k.drawRectangle(ap+1+a0*26-26,aq+1,25,1,eh,0," ")k.drawText(ap+1+a0*26-26,aq+1,0xCCCCCC,f.sub(v._function.tradew.loaded[a0]["s_name"],1,25))end;for a0=1,r(#v._function.tradew.loaded[v._function.tradew.sect],24)do if a0+4*v._function.tradew.tScrl-4==v._function.tradew.titem then k.drawRectangle(ap+1,aq+4+a0*2-2,160,3,0x818181,0," ")end end;for a0=1,r(#v._function.tradew.loaded[v._function.tradew.sect]+1,24)do k.drawText(ap+1,aq+4+a0*2-2,0xffffff,"═")k.drawText(ap+2,aq+4+a0*2-2,0xffffff,string.rep("─",157))end;for a0=1,r(#v._function.tradew.loaded[v._function.tradew.sect],24)do k.drawText(ap+1,aq+4+a0*2-1,0xffffff,G[v._function.tradew.loaded[v._function.tradew.sect][a0+4*v._function.tradew.tScrl-4]["item"]]["name"])k.drawText(ap+65,aq+4+a0*2-1,0xffffff,tostring(v._function.tradew.loaded[v._function.tradew.sect][a0+4*v._function.tradew.tScrl-4]["cost"])..v._function.genitiveWordEnding(" монет",v._function.tradew.loaded[v._function.tradew.sect][a0+4*v._function.tradew.tScrl-4]["cost"]))end;local ei="Купить"if v._function.tradew.titem>0 then local ej,ek,el=0xCCCCCC,v._function.tradew.twx,v._function.tradew.twy;k.drawRectangle(ek,el,v._function.tradew.cWidth,v._function.tradew.cHeight,0x828282,0," ")v._function.unicodeFrame(ek,el,v._function.tradew.cWidth,v._function.tradew.cHeight,0x4c4c4c)k.drawRectangle(ek-23,el,22,12,0x828282,0," ")k.drawImage(ek-22,el+1,P[1])k.drawText(ek+v._function.tradew.cWidth-2,el,0x4c4c4c,"X")k.drawText(ek+v._function.tradew.cWidth/2-f.len(G[v._function.tradew.loaded[v._function.tradew.sect][v._function.tradew.titem]["item"]]["name"])/2,el+1,ej,G[v._function.tradew.loaded[v._function.tradew.sect][v._function.tradew.titem]["item"]]["name"])k.drawText(ek+1,el+2,ej,"Покупка предмета")k.drawText(ek+1,el+3,ej,"Количество:")k.drawRectangle(ek+13,el+3,#tostring(v._function.tradew.titemcount)+4,1,0x616161,0," ")k.drawText(ek+13,el+3,ej,"+ "..v._function.tradew.titemcount.." -")k.drawText(ek+1,el+4,ej,"Цена: "..v._function.tradew.loaded[v._function.tradew.sect][v._function.tradew.titem]["cost"]..v._function.genitiveWordEnding(" монет",v._function.tradew.loaded[v._function.tradew.sect][v._function.tradew.titem]["cost"]))local em=ej;if v._function.tradew.titemcount*v._function.tradew.loaded[v._function.tradew.sect][v._function.tradew.titem]["cost"]>v._player.coins then em=0xb71202 end;k.drawText(ek+1,el+5,em,"Стоимость: "..tostring(v._function.tradew.titemcount*v._function.tradew.loaded[v._function.tradew.sect][v._function.tradew.titem]["cost"])..v._function.genitiveWordEnding(" монет",v._function.tradew.titemcount*v._function.tradew.loaded[v._function.tradew.sect][v._function.tradew.titem]["cost"]))k.drawRectangle(ek,el+v._function.tradew.cHeight,v._function.tradew.cWidth,3,0x0054cb5,0," ")k.drawText(ek+v._function.tradew.cWidth/2-f.len(ei)/2,el+v._function.tradew.cHeight+1,ej,ei)v._function.drawItemDescription(ek+v._function.tradew.cWidth+2,el+1)end elseif v._function.tradew.torg==2 then k.drawText(ap+2,aq+3,0xC2C2C2,"#")k.drawText(ap+5,aq+3,0xC2C2C2,"Наименование")k.drawText(ap+50,aq+3,0xC2C2C2,"Количество")k.drawText(ap+70,aq+3,0xC2C2C2,"Цена за единицу")v._function.tradew.asmt={}for a0=1,#v._player.inventory["bag"]do if v._player.inventory["bag"][a0][1]~=0 and v._player.inventory["bag"][a0][2]~=0 then n(v._function.tradew.asmt,v._player.inventory["bag"][a0])end end;for a0=1,25 do k.drawRectangle(ap+1,aq+5+a0*2-2,85,1,0x8C8C8C,0," ")end;for a0=1,#v._function.tradew.asmt do k.drawText(ap+2,aq+4+a0,0xDDDDDD,tostring(a0))k.drawText(ap+5,aq+4+a0,G[v._function.tradew.asmt[a0][1]]["ncolor"]or 0xffffff,"► "..G[v._function.tradew.asmt[a0][1]]["name"])k.drawText(ap+50,aq+4+a0,0xDDDDDD,tostring(v._function.tradew.asmt[a0][2]))k.drawText(ap+70,aq+4+a0,0xDDDDDD,G[v._function.tradew.asmt[a0][1]]["cost"]..v._function.genitiveWordEnding(" монет",G[v._function.tradew.asmt[a0][1]]["cost"]))end;if v._function.tradew.titem>0 then local en="Продать предмет"k.drawRectangle(90,6,22,12,0x828282,0," ")k.drawImage(91,7,P[1])v._function.drawItemDescription(91,20)k.drawText(118,6,0xffffff,"Количество")k.drawRectangle(118,7,10,3,0x828282,0," ")k.drawText(119,8,0xffffff,"┼")k.drawText(126,8,0xffffff,"—")k.drawText(121,9,0xffffff,"Макс.")k.drawRectangle(121,8,4,1,0x717171,0," ")k.drawText(121,8,0xffffff,tostring(v._function.tradew.titemcount))k.drawRectangle(130,7,f.len(en)+2,3,0x00447C,0," ")k.drawText(131,8,0xffffff,en)end end end;v._function.tradew.action["touch"]=function(af)if af[5]==0 and ao(af[3],af[4],v._function.tradew.x+v._function.tradew.w-8,v._function.tradew.y,v._function.tradew.x+v._function.tradew.w-1,v._function.tradew.y)then v._function.tradew.titem=0;v._function.tradew.titemcount=1;v._function.tradew.sect=1;v._function.tradew.tScrl=1;v._function.tradew.torg=1;v._function.tradew.asmt={}v._data.windowThread=nil;v._gui.NPCDialog.currentDialog=nil;v._data.paused=false;v._data.itemInfo=nil end;if af[5]==0 and v._function.tradew.torg==1 and v._function.tradew.titem==0 and ao(af[3],af[4],119,2,136,4)then v._function.tradew.torg=2;v._function.tradew.titem=0 elseif af[5]==0 and v._function.tradew.torg==2 and ao(af[3],af[4],119,2,136,4)then v._function.tradew.torg=1;v._function.tradew.titem=0;v._function.tradew.titemcount=1;v._function.cleanIconImageBuffer()end;if v._function.tradew.torg==2 then for a0=1,#v._function.tradew.asmt do if af[5]==0 and ao(af[3],af[4],2,5+a0,85,5+a0)then P[1]=c.load(v._data.text.directory.."itempic/"..v._data.itemIcons[G[v._function.tradew.asmt[a0][1]]["icon"]]..".pic")v._function.getItemInfo(v._function.tradew.asmt[a0][1])v._function.tradew.titem=a0;v._function.tradew.titemcount=1 end end;if v._function.tradew.titem>0 then if af[5]==0 then if ao(af[3],af[4],119,8,119,8)and v._function.tradew.titemcount<v._function.tradew.asmt[v._function.tradew.titem][2]then v._function.tradew.titemcount=v._function.tradew.titemcount+1 elseif ao(af[3],af[4],126,8,126,8)and v._function.tradew.titemcount>1 then v._function.tradew.titemcount=v._function.tradew.titemcount-1 elseif ao(af[3],af[4],121,9,125,9)then v._function.tradew.titemcount=v._function.tradew.asmt[v._function.tradew.titem][2]end;if ao(af[3],af[4],130,7,145,9)then v._function.removeItem(v._function.tradew.asmt[v._function.tradew.titem][1],v._function.tradew.titemcount)v._function.addCoins(G[v._function.tradew.asmt[v._function.tradew.titem][1]]["cost"]*v._function.tradew.titemcount)v._function.cleanIconImageBuffer()v._function.tradew.titem=0;v._function.tradew.titemcount=1 end end end elseif v._function.tradew.torg==1 and v._function.tradew.titem==0 then for aG=1,#v._function.tradew.loaded do if af[5]==0 and ao(af[3],af[4],2+aG*26-26,2,2+aG*25,2)then v._function.tradew.sect=aG;break end end;for aG=1,r(#v._function.tradew.loaded[v._function.tradew.sect],24)do if ao(af[3],af[4],2,5+aG*2-2,160,5+aG*2)then v._function.tradew.titem=aG+4*v._function.tradew.tScrl-4;v._function.getItemInfo(v._function.tradew.loaded[v._function.tradew.sect][v._function.tradew.titem]["item"])P={[1]=c.load(v._data.text.directory.."itempic/"..v._data.itemIcons[G[v._function.tradew.loaded[v._function.tradew.sect][v._function.tradew.titem]["item"]]["icon"]]..".pic")}break end end elseif v._function.tradew.torg==1 and v._function.tradew.titem>0 then if af[5]==0 and G[v._function.tradew.loaded[v._function.tradew.sect][v._function.tradew.titem]["item"]]["stack"]and v._function.tradew.titemcount<100 and ao(af[3],af[4],v._function.tradew.twx+13,v._function.tradew.twy+3,v._function.tradew.twx+13,v._function.tradew.twy+3)then v._function.tradew.titemcount=v._function.tradew.titemcount+1 elseif af[5]==0 and v._function.tradew.titemcount>1 and ao(af[3],af[4],v._function.tradew.twx+16+#tostring(v._function.tradew.titemcount),v._function.tradew.twy+3,v._function.tradew.twx+16+#tostring(v._function.tradew.titemcount),v._function.tradew.twy+3)then v._function.tradew.titemcount=v._function.tradew.titemcount-1 end;if ao(af[3],af[4],v._function.tradew.twx,v._function.tradew.twy+v._function.tradew.cHeight,v._function.tradew.twx+v._function.tradew.cWidth,v._function.tradew.twy+v._function.tradew.cHeight+3)and v._player.coins>=v._function.tradew.titemcount*v._function.tradew.loaded[v._function.tradew.sect][v._function.tradew.titem]["cost"]then v._player.coins=v._player.coins-v._function.tradew.titemcount*v._function.tradew.loaded[v._function.tradew.sect][v._function.tradew.titem]["cost"]v._function.addItem(v._function.tradew.loaded[v._function.tradew.sect][v._function.tradew.titem]["item"],v._function.tradew.titemcount)v._function.tradew.titem=0;v._function.tradew.titemcount=1;v._function.cleanIconImageBuffer()end;if ao(af[3],af[4],v._function.tradew.twx+v._function.tradew.cWidth-2,v._function.tradew.twy,v._function.tradew.twx+v._function.tradew.cWidth-2,v._function.tradew.twy)then v._function.tradew.titem=0;v._function.tradew.titemcount=1;v._function.cleanIconImageBuffer()end end end;v._function.craftw={action={},loaded={},titem=0,titemcount=1,sect=1,tScrl=1,x=1,y=1,w=160,h=50,cWidth=50,cHeight=15,bWidth=26}v._function.craftw.twx=p(80-v._function.craftw.cWidth/2)v._function.craftw.twy=p(25-v._function.craftw.cHeight/2)function v._function.craftw.draw()local ap,aq=v._function.craftw.x,v._function.craftw.y;k.drawRectangle(ap,aq,v._function.craftw.w,v._function.craftw.h,0x9B9B9B,0," ")k.drawRectangle(ap,aq,v._function.craftw.w,1,0x525252,0," ")k.drawRectangle(ap,aq+1,v._function.craftw.w,3,0x747474,0," ")local cm="Создание предметов"k.drawText(s(80-f.len(cm)/2,0),aq,0xffffff,cm)k.drawText(ap+1,aq+3,0xC2C2C2,"Наименование")k.drawText(ap+65,aq+3,0xC2C2C2,"Шанс создания")k.drawText(ap+130,aq+3,0xC2C2C2,"Цена")k.drawText(ap+v._function.craftw.w-9,aq,0xffffff,"Закрыть")k.drawText(ap+1,aq+2,0xffffff,"Монеты "..v._player.coins)local d_,av,eh;for ae=1,2 do for a0=1,5 do av=(ae-1)*5+a0;if v._function.craftw.loaded[av]then d_=f.sub(v._function.craftw.loaded[av]["s_name"],1,v._function.craftw.bWidth-1)if v._function.craftw.sect==a0 then eh=0x525252 else eh=0x606060 end;k.drawRectangle(ap+1+a0*v._function.craftw.bWidth-v._function.craftw.bWidth,aq+ae,v._function.craftw.bWidth-1,1,eh,0," ")k.drawText(ap+1+a0*v._function.craftw.bWidth-v._function.craftw.bWidth,aq+ae,0xCCCCCC,d_)end end end;for a0=1,r(#v._function.craftw.loaded[v._function.craftw.sect],24)do if a0+4*v._function.craftw.tScrl-4==v._function.craftw.titem then k.drawRectangle(ap+1,aq+4+a0*2-2,160,3,0x818181,0," ")end end;for a0=1,r(#v._function.craftw.loaded[v._function.craftw.sect]+1,24)do k.drawText(ap+1,aq+4+a0*2-2,0xffffff,"═")k.drawText(ap+2,aq+4+a0*2-2,0xffffff,string.rep("─",157))end;for a0=1,r(#v._function.craftw.loaded[v._function.craftw.sect],24)do k.drawText(ap+1,aq+4+a0*2-1,0xffffff,G[v._function.craftw.loaded[v._function.craftw.sect][a0+4*v._function.craftw.tScrl-4]["item"]]["name"])k.drawText(ap+65,aq+4+a0*2-1,0xffffff,tostring(v._function.craftw.loaded[v._function.craftw.sect][a0+4*v._function.craftw.tScrl-4]["chance"]).."%")k.drawText(ap+130,aq+4+a0*2-1,0xffffff,tostring(v._function.craftw.loaded[v._function.craftw.sect][a0+4*v._function.craftw.tScrl-4]["cost"])..v._function.genitiveWordEnding(" монет",v._function.craftw.loaded[v._function.craftw.sect][a0+4*v._function.craftw.tScrl-4]["cost"]))end;if v._function.craftw.titem~=0 then local ej,ek,el=0xCCCCCC,v._function.craftw.twx,v._function.craftw.twy;k.drawRectangle(ek,el,v._function.craftw.cWidth,v._function.craftw.cHeight,0x828282,0," ")v._function.unicodeFrame(ek,el,v._function.craftw.cWidth,v._function.craftw.cHeight,0x4c4c4c)k.drawRectangle(ek-23,el,22,12,0x828282,0," ")k.drawImage(ek-22,el+1,P[1])k.drawText(ek+v._function.craftw.cWidth-2,el,0x4c4c4c,"X")k.drawText(ek+p(v._function.craftw.cWidth/2-f.len(G[v._function.craftw.loaded[v._function.craftw.sect][v._function.craftw.titem]["item"]]["name"])/2),el+1,ej,G[v._function.craftw.loaded[v._function.craftw.sect][v._function.craftw.titem]["item"]]["name"])k.drawText(ek+1,el+2,ej,"Создание предмета")k.drawText(ek+1,el+3,ej,"Количество:")k.drawRectangle(ek+13,el+3,#tostring(v._function.craftw.titemcount)+4,1,0x616161,0," ")k.drawText(ek+13,el+3,ej,"+ "..v._function.craftw.titemcount.." -")local em;if v._function.craftw.titemcount*v._function.craftw.loaded[v._function.craftw.sect][v._function.craftw.titem]["cost"]<=v._player.coins then em=ej else em=0xb71202 end;k.drawText(ek+1,el+4,em,"Стоимость: "..tostring(v._function.craftw.titemcount*v._function.craftw.loaded[v._function.craftw.sect][v._function.craftw.titem]["cost"])..v._function.genitiveWordEnding(" монет",v._function.craftw.titemcount*v._function.craftw.loaded[v._function.craftw.sect][v._function.craftw.titem]["cost"]))k.drawText(ek+1,el+5,ej,"Шанс создания: "..v._function.craftw.loaded[v._function.craftw.sect][v._function.craftw.titem]["chance"].."%")k.drawText(ek+1,el+6,ej,"Шанс улучшения: "..tostring(v._function.craftw.loaded[v._function.craftw.sect][v._function.craftw.titem]["achance"]).."%")k.drawText(ek+1,el+7,ej,"Требуются предметы:")local eo,ep=nil,0;for ae=1,r(#v._function.craftw.loaded[v._function.craftw.sect][v._function.craftw.titem]["recipe"],5)do if v._function.checkItemInBag(v._function.craftw.loaded[v._function.craftw.sect][v._function.craftw.titem]["recipe"][ae][1])>=v._function.craftw.loaded[v._function.craftw.sect][v._function.craftw.titem]["recipe"][ae][2]*v._function.craftw.titemcount then eo=0xdcdcdc;ep=ep+1 else eo=0x575757 end;k.drawText(ek+1,el+7+ae,eo,"▸"..G[v._function.craftw.loaded[v._function.craftw.sect][v._function.craftw.titem]["recipe"][ae][1]]["name"].." ("..v._function.craftw.loaded[v._function.craftw.sect][v._function.craftw.titem]["recipe"][ae][2]*v._function.craftw.titemcount..")")end;eo=0x0054cb5;if#v._function.craftw.loaded[v._function.craftw.sect][v._function.craftw.titem]["recipe"]>ep or em==0xb71202 then eo=0x7B7B7B end;k.drawRectangle(ek,el+v._function.craftw.cHeight,v._function.craftw.cWidth,3,eo,0," ")k.drawText(ek+18,el+v._function.craftw.cHeight+1,ej,"Создать предмет")v._function.drawItemDescription(ek+v._function.craftw.cWidth+2,el+1)end end;v._function.craftw.action["touch"]=function(af)local eq,er;if af[5]==0 and ao(af[3],af[4],v._function.craftw.x+v._function.craftw.w-8,v._function.craftw.y,v._function.craftw.x+v._function.craftw.w-1,v._function.craftw.y)then v._function.craftw.titem=0;v._function.craftw.titemcount=1;v._function.craftw.sect=1;v._function.craftw.tScrl=1;v._data.windowThread=nil;v._gui.NPCDialog.currentDialog=nil;v._data.paused=false;v._data.itemInfo=nil end;if v._function.craftw.titem==0 then for ae=1,2 do for a0=1,5 do if v._function.craftw.loaded[(ae-1)*5+a0]then if af[5]==0 and ao(af[3],af[4],v._function.craftw.x+1+a0*v._function.craftw.bWidth-v._function.craftw.bWidth,v._function.craftw.y+ae,v._function.craftw.x+1+a0*(v._function.craftw.bWidth-1),v._function.craftw.y+ae)then v._function.craftw.sect=(ae-1)*5+a0 end end end end;for aG=1,r(#v._function.craftw.loaded[v._function.craftw.sect],24)do if ao(af[3],af[4],2,5+aG*2-2,160,5+aG*2)then v._function.craftw.titem=aG+4*v._function.tradew.tScrl-4;v._function.getItemInfo(v._function.craftw.loaded[v._function.craftw.sect][v._function.craftw.titem]["item"])P[1]=c.load(v._data.text.directory.."itempic/"..v._data.itemIcons[G[v._function.craftw.loaded[v._function.craftw.sect][v._function.craftw.titem]["item"]]["icon"]]..".pic")break end end else if af[5]==0 and G[v._function.craftw.loaded[v._function.craftw.sect][v._function.craftw.titem]["item"]]["stack"]and v._function.craftw.titemcount<100 and ao(af[3],af[4],v._function.craftw.twx+13,v._function.craftw.twy+3,v._function.craftw.twx+13,v._function.craftw.twy+3)then v._function.craftw.titemcount=v._function.craftw.titemcount+1 elseif af[5]==0 and v._function.craftw.titemcount>1 and ao(af[3],af[4],v._function.craftw.twx+16+#tostring(v._function.craftw.titemcount),v._function.craftw.twy+3,v._function.craftw.twx+16+#tostring(v._function.craftw.titemcount),v._function.craftw.twy+3)then v._function.craftw.titemcount=v._function.craftw.titemcount-1 end;if ao(af[3],af[4],v._function.craftw.twx,v._function.craftw.twy+v._function.craftw.cHeight,v._function.craftw.twx+v._function.craftw.cWidth,v._function.craftw.twy+v._function.craftw.cHeight+3)and v._player.coins>=v._function.craftw.titemcount*v._function.craftw.loaded[v._function.craftw.sect][v._function.craftw.titem]["cost"]then eq=true;for ae=1,#v._function.craftw.loaded[v._function.craftw.sect][v._function.craftw.titem]["recipe"]do if v._function.checkItemInBag(v._function.craftw.loaded[v._function.craftw.sect][v._function.craftw.titem]["recipe"][ae][1])<v._function.craftw.loaded[v._function.craftw.sect][v._function.craftw.titem]["recipe"][ae][2]*v._function.craftw.titemcount then eq=false end end;if v._function.craftw.loaded[v._function.craftw.sect][v._function.craftw.titem]["cost"]>v._player.coins then eq=false end;if eq then for ch=1,#v._function.craftw.loaded[v._function.craftw.sect][v._function.craftw.titem]["recipe"]do for ae=1,#v._player.inventory["bag"]do if v._player.inventory["bag"][ae][1]==v._function.craftw.loaded[v._function.craftw.sect][v._function.craftw.titem]["recipe"][ch][1]then v._player.inventory["bag"][ae][2]=v._player.inventory["bag"][ae][2]-v._function.craftw.loaded[v._function.craftw.sect][v._function.craftw.titem]["recipe"][ch][2]*v._function.craftw.titemcount;if v._player.inventory["bag"][ae][2]==0 then v._player.inventory["bag"][ae][1]=0 end;break end end end;for ch=1,v._function.craftw.titemcount do er=v._function.craftw.loaded[v._function.craftw.sect][v._function.craftw.titem]["item"]v._player.coins=v._player.coins-v._function.craftw.loaded[v._function.craftw.sect][v._function.craftw.titem]["cost"]if er~=nil and 10^10-v._function.craftw.loaded[v._function.craftw.sect][v._function.craftw.titem]["chance"]*10^10<=v._function.random(1,10^10)then if 10^10-(v._function.craftw.loaded[v._function.craftw.sect][v._function.craftw.titem]["achance"]or 0)*10^10<=v._function.random(1,10^10)then er=bX(er)end;v._function.addItem(er,1,true)end;er=nil end;v._function.craftw.titem=0;v._function.craftw.titemcount=1;v._function.cleanIconImageBuffer()end end;if ao(af[3],af[4],v._function.craftw.twx+v._function.craftw.cWidth-2,v._function.craftw.twy,v._function.craftw.twx+v._function.craftw.cWidth-2,v._function.craftw.twy)then v._function.craftw.titem=0;v._function.craftw.titemcount=1;v._function.cleanIconImageBuffer()end end end;v._function.ydw={w=40,h=24,x=1,y=1,action={},[1]={"Продолжить",f=function()local es=p(Q[v._player.id]["mxp"]*v._function.random(2*10/math.sqrt(Q[v._player.id]["lvl"])*100,5*10/math.sqrt(Q[v._player.id]["lvl"])*100)*0.0001)for a0=1,#v._player.inventory["bag"]do if v._function.random(0,100)<=1 then v._player.inventory["bag"][a0][2]=v._player.inventory["bag"][a0][2]-1 end end;Q[v._player.id]["targ"]=nil;v._function.loadWorld(N[N.current].drespawn)v._function.teleport(N[N.current].drx)v._function.UpdatePlayerStats()Q[v._player.id]["chp"]=Q[v._player.id]["mhp"]Q[v._player.id]["cmp"]=Q[v._player.id]["mmp"]if Q[v._player.id]["cxp"]>es then Q[v._player.id]["cxp"]=Q[v._player.id]["cxp"]-es end;v._player.moving=false;C=0;b4(0)Q[v._player.id]["effects"]={}Q[v._player.id]["living"]=true;v._data.windowThread=nil;v._data.paused=false end},[2]={"Загрузить игру",f=function()v._gui.mainMenu.open(2)end},[3]={"Выйти в меню",f=function()v._gui.mainMenu.open(0)end}}function v._function.ydw.draw()v._data.paused=true;Q[v._player.id]["target"]=nil;v._data.windowThread="died"k.drawRectangle(1,1,t,u,0x6B6B6B,0," ",40)local ap,aq=p(t/2-v._function.ydw.w/2),p(u/2-v._function.ydw.h/2)v._function.ydw.x,v._function.ydw.y=ap,aq;k.drawRectangle(ap,aq,v._function.ydw.w,v._function.ydw.h,0x7B7B7B,0," ")k.drawRectangle(ap-1,aq+1,1,v._function.ydw.h-2,0x7B7B7B,0," ")k.drawRectangle(ap+v._function.ydw.w,aq+1,1,v._function.ydw.h-2,0x7B7B7B,0," ")local et="Слишком низкое здоровье"k.drawText(p(ap+v._function.ydw.w/2-f.len(et)/2),aq+1,0xFCFCFC,et)for a0=1,#v._function.ydw do k.drawText(p(ap+v._function.ydw.w/2-f.len(v._function.ydw[a0][1])/2),aq+4+a0*3-3,0xCCCCCC,v._function.ydw[a0][1])end end;v._function.ydw.action["touch"]=function(af)for e=1,#v._function.ydw do if ao(af[3],af[4],v._function.ydw.x,v._function.ydw.y+4+e*3-3,v._function.ydw.x+v._function.ydw.w-1,v._function.ydw.y+4+e*3-3)then pcall(v._function.ydw[e].f)end end end;local eu=1;v._function.gameConsole={x=50,y=10,w=60,h=35,action={}}function v._function.gameConsole.draw()local ap,aq,aF,ag=v._function.gameConsole.x,v._function.gameConsole.y,v._function.gameConsole.w,v._function.gameConsole.h;k.drawRectangle(ap,aq,aF,ag,0xABABAB,0," ")k.drawRectangle(ap,aq,aF,1,0x525252,0," ")k.drawRectangle(ap+1,aq+1,aF-2,ag-4,0x1A1A1A,0," ")k.drawRectangle(ap+1,aq+33,aF-2,1,0x1A1A1A,0," ")local ev,ew;local ex="debug"k.drawText(ap+s(p(aF/2-f.len(ex)/2),0),aq,0xffffff,ex)k.drawText(ap+59,aq,0xffffff,"X")for a0=1,r(#bt,ag-7)do if bt[a0+eu*4-4]then if f.sub(bt[a0+eu*4-4],1,2)=="!/"then ev=0xFF0000;ew=3 else ev=0xffffff;ew=1 end;k.drawText(ap+2,aq+2+a0,ev,f.sub(bt[a0+eu*4-4],ew,aF-4))end end end;v._function.gameConsole.action["touch"]=function(af)if af[5]==0 and ao(af[3],af[4],v._function.gameConsole.x+v._function.gameConsole.w-1,v._function.gameConsole.y,v._function.gameConsole.x+v._function.gameConsole.w-1,v._function.gameConsole.y)then v._data.windowThread=nil;v._data.paused=false end end;v._function.gameConsole.action["scroll"]=function(af)local ap,aq,aF,ag=v._function.gameConsole.x,v._function.gameConsole.y,v._function.gameConsole.w,v._function.gameConsole.h;if ao(af[3],af[4],ap,aq,ap+aF-1,aq+ag-3)and af[5]==1 and eu>1 then eu=eu-1 elseif ao(af[3],af[4],ap,aq,ap+aF-1,aq+ag-3)and af[5]==-1 and q(eu*4)<#bt then eu=eu+1 end end;v._function.gameConsole.action["key_down"]=function(af)if not v._data.paused and af[4]==46 then v._data.paused=true;eu=p(#bt/4)v._data.windowThread="console"end end;function v._gui.questsList.draw()local ap,aq=v._gui.questsList.window.x,v._gui.questsList.window.y;v._gui.blank.draw(v._gui.questsList.window)k.drawRectangle(ap+2,aq+2,29,27,0x7A7A7A,0," ")k.drawRectangle(ap+32,aq+2,66,27,0x7A7A7A,0," ")for a0=1,r(#v._player.quests,25)do if v._player.quests[a0][3]then k.drawText(ap+2,aq+2+a0,0x00C222,"→")end;k.drawText(ap+3,aq+2+a0,0xDDDDDD,f.sub(H[v._player.quests[a0][1]]["name"],1,28))end;if v._gui.questsList.targetQuest>0 and v._player.quests[v._gui.questsList.targetQuest]~=nil then local ey={}local ez=v._function.textWrap(H[v._player.quests[v._gui.questsList.targetQuest][1]]["descr"],63)for ae=1,#ez do n(ey,ez[ae])end;local eA={}if H[v._player.quests[v._gui.questsList.targetQuest][1]]["qreward"]then eA={"Награда:","Монеты "..tostring(H[v._player.quests[v._gui.questsList.targetQuest][1]]["qreward"]["coins"]),"Опыт "..tostring(H[v._player.quests[v._gui.questsList.targetQuest][1]]["qreward"]["xp"])}end;n(eA,1,"Описание:")for ae=1,#ey do if ey[ae]~=nil and ey[ae]~=""then n(eA,ae+1,ey[ae])end end;if H[v._player.quests[v._gui.questsList.targetQuest][1]]["type"]==1 then if type(H[v._player.quests[v._gui.questsList.targetQuest][1]]["targ"])=="number"then n(eA,1,"► "..F[H[v._player.quests[v._gui.questsList.targetQuest][1]]["targ"]]["name"].." ("..v._player.quests[v._gui.questsList.targetQuest][2].."/"..H[v._player.quests[v._gui.questsList.targetQuest][1]]["num"]..")")else for c9=1,#H[v._player.quests[v._gui.questsList.targetQuest][1]]["targ"]do n(eA,1,"► "..F[H[v._player.quests[v._gui.questsList.targetQuest][1]]["targ"][c9]]["name"].." ("..v._player.quests[v._gui.questsList.targetQuest][2][c9].."/"..H[v._player.quests[v._gui.questsList.targetQuest][1]]["num"][c9]..")")end end;n(eA,1,"Уничтожить: ")elseif H[v._player.quests[v._gui.questsList.targetQuest][1]]["type"]==2 then if type(H[v._player.quests[v._gui.questsList.targetQuest][1]]["targ"][1])=="number"then n(eA,1,"► "..G[H[v._player.quests[v._gui.questsList.targetQuest][1]]["targ"]]["name"].." ("..v._player.quests[v._gui.questsList.targetQuest][2].."/"..H[v._player.quests[v._gui.questsList.targetQuest][1]]["num"]..")")else for c9=1,#H[v._player.quests[v._gui.questsList.targetQuest][1]]["targ"]do n(eA,1,"► "..G[H[v._player.quests[v._gui.questsList.targetQuest][1]]["targ"][c9][1]]["name"].." ("..v._player.quests[v._gui.questsList.targetQuest][2][c9].."/"..H[v._player.quests[v._gui.questsList.targetQuest][1]]["targ"][c9][2]..")")end end;n(eA,1,"Найти предметы: ")end;if H[v._player.quests[v._gui.questsList.targetQuest][1]]["qr"]>0 then n(eA,1,"Задание закончено: "..F[H[v._player.quests[v._gui.questsList.targetQuest][1]]["qr"]]["name"])else n(eA,1,"Задание закончено: автоматически")end;if H[v._gui.questsList.targetQuest]["givingQuest"]then n(eA,1,"Задание выдано: "..F[H[v._player.quests[v._gui.questsList.targetQuest][1]]["givingQuest"]]["name"])end;if H[v._player.quests[v._gui.questsList.targetQuest][1]]["qreward"]and H[v._player.quests[v._gui.questsList.targetQuest][1]]["qreward"]["item"]~=nil then n(eA,"Предмет:")for cR=1,#H[v._player.quests[v._gui.questsList.targetQuest][1]]["qreward"]["item"]do if type(H[v._player.quests[v._gui.questsList.targetQuest][1]]["qreward"]["item"][cR][1])=="table"then n(eA,"??? (?)")else n(eA,f.sub(G[H[v._player.quests[v._gui.questsList.targetQuest][1]]["qreward"]["item"][cR][1]]["name"].." ("..tostring(H[v._player.quests[v._gui.questsList.targetQuest][1]]["qreward"]["item"][cR][2])..")",1,45))end end end;local eB=""if H[v._player.quests[v._gui.questsList.targetQuest][1]]["repeat"]then eB=" (Повторяемое)"end;k.drawText(ap+33,aq+3,0xffffff,f.sub(H[v._player.quests[v._gui.questsList.targetQuest][1]]["name"]..eB,1,60))for a0=1,#eA do k.drawText(ap+33,aq+3+a0,0xffffff,eA[a0])end end end;v._gui.questsList.action["touch"]=function(af)local ap,aq,aF=v._gui.questsList.window.x,v._gui.questsList.window.y,v._gui.questsList.window.w;local eC;if af[5]==0 and ao(af[3],af[4],ap+aF-8,aq,ap+aF-1,aq)then v._data.windowThread="pause"end;for a0=1,#v._player.quests do if v._player.quests[a0]~=nil and ao(af[3],af[4],ap+3,aq+2+a0,ap+30,aq+2+a0)then eC=false;v._gui.questsList.targetQuest=a0;break end;if not eC then v._gui.questsList.targetQuest=0 end end end;function v._gui.playerStats.updateContent()v._gui.playerStats.info={"Имя персонажа: "..F[Q[v._player.id]["id"]]["name"],"Уровень: "..Q[v._player.id]["lvl"],"Здоровье: "..p(Q[v._player.id]["chp"]).."/"..p(Q[v._player.id]["mhp"]),"Мана: "..p(Q[v._player.id]["cmp"]).."/"..p(Q[v._player.id]["mmp"]),"Опыт: "..Q[v._player.id]["cxp"].."/"..Q[v._player.id]["mxp"].." ("..tostring(p(Q[v._player.id]["cxp"]*100/Q[v._player.id]["mxp"]*10)/10).."%)","Физическая атака: "..Q[v._player.id]["ptk"][1].."-"..Q[v._player.id]["ptk"][2].." ("..q((v._player.statsPoints.vPdm1+v._player.statsPoints.vPdm2)/2).." от снаряжения)","Магическая атака: "..Q[v._player.id]["mtk"][1].."-"..Q[v._player.id]["mtk"][2].." ("..q((v._player.statsPoints.vMdm1+v._player.statsPoints.vMdm2)/2).." от снаряжения)","Физическая защита: "..Q[v._player.id]["pdef"].." ("..Q[v._player.id]["armorpdef"].." от снаряжения)","Магическая защита: "..Q[v._player.id]["mdef"].." ("..Q[v._player.id]["armormdef"].." от снаряжения)","Скорость атаки: "..tostring(q(1/I[1]["reloading"]*10)/10),"Вероятность нанесения критического удара: "..v._player.critChance.."%"}end;function v._gui.playerStats.draw()local ap,aq=v._gui.playerStats.window.x,v._gui.playerStats.window.y;local ar,as=v._gui.playerStats.x1,v._gui.playerStats.y1;v._gui.blank.draw(v._gui.playerStats.window)for a0=1,#v._gui.playerStats.info do k.drawText(ap+3,aq+1+a0,0xffffff,v._gui.playerStats.info[a0])end;k.drawRectangle(ar,as,37,5,0x898989,0," ")k.drawText(ar+1,as,0xffffff,"Очков для распределения "..Q[v._player.id]["levelpoints"])k.drawText(ar+1,as+1,0xEEEEEE,"Магия")k.drawText(ar+14,as+1,0xCECECE,tostring(Q[v._player.id]["int"]+v._gui.playerStats.selectedPoints[1]+v._player.statsPoints.vInt))k.drawText(ar+1,as+2,0xEEEEEE,"Сила")k.drawText(ar+14,as+2,0xCECECE,tostring(Q[v._player.id]["strg"]+v._gui.playerStats.selectedPoints[2]+v._player.statsPoints.vStr))k.drawText(ar+1,as+3,0xEEEEEE,"Ловкость")k.drawText(ar+14,as+3,0xCECECE,tostring(Q[v._player.id]["agi"]+v._gui.playerStats.selectedPoints[3]+v._player.statsPoints.vAgi))k.drawText(ar+1,as+4,0xEEEEEE,"Выносливость")k.drawText(ar+14,as+4,0xCECECE,tostring(Q[v._player.id]["surv"]+v._gui.playerStats.selectedPoints[4]+v._player.statsPoints.vSur))for a0=1,4 do k.drawRectangle(ap+20,aq+14+a0,3,1,0x727272,0," ")k.drawText(ap+21,aq+14+a0,0xEEEEEE,"+")k.drawRectangle(ap+24,aq+14+a0,3,1,0x727272,0," ")k.drawText(ap+25,aq+14+a0,0xEEEEEE,"-")end;k.drawRectangle(ap+28,aq+16,9,1,0x737373,0," ")k.drawText(ap+28,aq+16,0xEEEEEE,"→Принять")k.drawRectangle(ap+28,aq+18,9,1,0x737373,0," ")k.drawText(ap+28,aq+18,0xEEEEEE,"×отменить")end;v._gui.playerStats.action["touch"]=function(af)local ap,aq=v._gui.playerStats.window.x,v._gui.playerStats.window.y;local ar,as=v._gui.playerStats.x1,v._gui.playerStats.y1;if af[5]==0 and ao(af[3],af[4],ap+v._gui.playerStats.window.w-8,aq,ap+v._gui.playerStats.window.w-1,aq)then v._data.windowThread="pause"return end;for cm=1,4 do if af[5]==0 and ao(af[3],af[4],ar+17,as+cm,ar+20,as+cm)and Q[v._player.id]["levelpoints"]>0 then v._gui.playerStats.selectedPoints[cm]=v._gui.playerStats.selectedPoints[cm]+1;Q[v._player.id]["levelpoints"]=Q[v._player.id]["levelpoints"]-1;v._gui.playerStats.selectedPoints[5]=v._gui.playerStats.selectedPoints[5]+1 elseif af[5]==0 and ao(af[3],af[4],ar+22,as+cm,ar+25,as+cm)and v._gui.playerStats.selectedPoints[cm]>0 then v._gui.playerStats.selectedPoints[cm]=v._gui.playerStats.selectedPoints[cm]-1;Q[v._player.id]["levelpoints"]=Q[v._player.id]["levelpoints"]+1;v._gui.playerStats.selectedPoints[5]=v._gui.playerStats.selectedPoints[5]-1 end end;if af[5]==0 and ao(af[3],af[4],ar+28,as+2,ar+34,as+2)then Q[v._player.id]["int"]=Q[v._player.id]["int"]+v._gui.playerStats.selectedPoints[1]Q[v._player.id]["strg"]=Q[v._player.id]["strg"]+v._gui.playerStats.selectedPoints[2]Q[v._player.id]["agi"]=Q[v._player.id]["agi"]+v._gui.playerStats.selectedPoints[3]Q[v._player.id]["surv"]=Q[v._player.id]["surv"]+v._gui.playerStats.selectedPoints[4]v._gui.playerStats.selectedPoints={0,0,0,0,0}v._function.UpdatePlayerStats()v._gui.playerStats.updateContent()elseif af[5]==0 and v._gui.playerStats.selectedPoints[5]>0 and ao(af[3],af[4],ar+28,as+4,ar+34,as+4)then Q[v._player.id]["levelpoints"]=Q[v._player.id]["levelpoints"]+v._gui.playerStats.selectedPoints[5]v._gui.playerStats.selectedPoints={0,0,0,0,0}v._function.UpdatePlayerStats()v._gui.playerStats.updateContent()end end;function v._function.pSkillsPbar(ap,aq,ed)k.drawRectangle(ap,aq,46,4,0x8c8c8c,0," ")local aG;for a0=1,7 do aG=0x00CA85;if a0>ed+1 then aG=0xAAAAAA elseif a0==ed+1 then aG=0x0085CA end;k.drawRectangle(ap+2+a0*6-6,aq+1,5,2,aG,0," ")end end;function v._gui.playerSkills.draw()local ap,aq=v._gui.playerSkills.window.x,v._gui.playerSkills.window.y;v._gui.blank.draw(v._gui.playerSkills.window)k.drawRectangle(ap+1,aq+2,50,v._gui.playerSkills.window.h-3,0x919191,0," ")v._function.UpdatePlayerStats()local eD,eE,reqItem;local eF=""k.drawRectangle(ap+53,aq+2,50,37,0x919191,0," ")for a0=1,#v._player.skills do if a0==v._gui.playerSkills.targ then k.drawRectangle(ap+1,aq+2+a0*3-3,50,3,0xABABAB,0," ")k.drawRectangle(ap+51,aq+3+a0*3-3,1,1,0x919191,0," ")k.drawRectangle(ap+52,aq+2+a0*3-3,1,3,0x919191,0," ")end;eF=I[v._player.skills[a0][1]]["name"].." ("..v._player.skills[a0][3].." ур.)"k.drawText(ap+p(25-f.len(eF)/2),aq+3+a0*3-3,0xffffff,eF)end;if v._gui.playerSkills.targ~=0 then local eG=s(v._player.skills[v._gui.playerSkills.targ][3],0)eD=I[v._player.skills[v._gui.playerSkills.targ][1]]if eD["type"]==2 and eG<v._config.maxSkillLevel or eD["type"]~=2 and eG<#eD["manacost"]then k.drawRectangle(ap+55,aq+30,46,8,0xA3A3A3,0," ")v._function.pSkillsPbar(ap+55,aq+25,eG)for a0=1,#v._gui.playerSkills.text3 do k.drawText(ap+57,aq+30+a0,v._gui.playerSkills.text3[a0][2],tostring(v._gui.playerSkills.text3[a0][1]))end;eE="Изучить умение"k.drawRectangle(ap+70,aq+35,f.len(eE)+2,3,0x077DAC,0," ")k.drawText(ap+71,aq+36,0xCECECE,eE)end;for ae=1,#v._gui.playerSkills.text1 do k.drawText(ap+54,aq+2+ae,0xffffff,v._gui.playerSkills.text1[ae])end;for a0=1,#v._gui.playerSkills.text2 do k.drawText(ap+54,aq+9+a0,0xffffff,tostring(v._gui.playerSkills.text2[a0]))end;k.drawText(ap+105,aq+3,0xffffff,"Установить")k.drawText(ap+105,aq+4,0xffffff,"на клавишу…")local ev;for eH=1,#v._gui.skillsTopPanel.t do ev=v._gui.skillsTopPanel.t[eH].c;for an=1,#v._player.actSkills do if v._player.actSkills[eH+1]==v._gui.playerSkills.targ then ev=0xBBBBBB;break end end;k.drawRectangle(ap+105,6+aq+4*eH-4,10,3,ev,0," ")k.drawText(ap+109,6+aq+4*eH-3,0xffffff,tostring(eH+1))end end end;v._gui.playerSkills.action["touch"]=function(af)local ap,aq=v._gui.playerSkills.window.x,v._gui.playerSkills.window.y;local eI,eJ,rv,ntt;local eD,eG;if ao(af[3],af[4],ap+v._gui.playerSkills.window.w-8,aq,ap+v._gui.playerSkills.window.w-1,aq)then v._gui.playerSkills.text1={}v._gui.playerSkills.text2={}v._data.windowThread="pause"end;for e=1,#v._player.skills do if af[5]==0 and ao(af[3],af[4],ap+1,aq+2+e*3-3,ap+50,aq+2+e*3)then v._gui.playerSkills.targ=e;v._gui.playerSkills.updateDescription()end end;if v._gui.playerSkills.targ>0 then eG=v._player.skills[v._gui.playerSkills.targ][3]eD=I[v._player.skills[v._gui.playerSkills.targ][1]]if af[5]==0 and ao(af[3],af[4],ap+70,v._gui.playerSkills.window.y+35,ap+84,aq+37)and(eD["type"]==2 and eG<v._config.maxSkillLevel)or eD["type"]~=2 and eG<#eD["manacost"]then eI,eJ=true,{}if eD["reqlvl"]then if eD["reqlvl"][eG+1]>Q[v._player.id]["lvl"]then eI=false end end;if eD["reqcn"]then if eD["reqcn"][eG+1]>v._player.coins then eI=false else eJ.c=true end end;if eD["reqitem"]and eD["reqitem"][eG+1]then if v._function.checkItemInBag(eD["reqitem"][eG+1][1])<eD["reqitem"][eG+1][2]then eI=false else eJ.o,eJ.i=v._function.checkItemInBag(eD["reqitem"][eG+1][1])end end;if eI==true then if eJ.c then v._player.coins=v._player.coins-eD["reqcn"][eG+1]end;if eJ.i then v._function.removeItem(eD["reqitem"][eG+1][1],eD["reqitem"][eG+1][2])end;v._player.skills[v._gui.playerSkills.targ][3]=eG+1;v._gui.playerSkills.updateDescription()end end;for eH=1,#v._player.actSkills do if af[5]==0 and ao(af[3],af[4],ap+105,aq+6+4*eH-4,ap+115,aq+6+4*eH-1)and v._player.skills[v._gui.playerSkills.targ][1]>1 and eG>0 and I[v._player.skills[v._gui.playerSkills.targ][1]]["type"]~=2 then for an=1,#v._player.actSkills do if v._player.actSkills[an]==v._gui.playerSkills.targ then v._player.actSkills[an]=0 end end;v._player.actSkills[eH+1]=v._gui.playerSkills.targ;break end end end end;function v._gui.playerSkills.updateDescription()local eD,eG;if v._gui.playerSkills.targ~=0 then eD=I[v._player.skills[v._gui.playerSkills.targ][1]]v._gui.playerSkills.text1={}v._gui.playerSkills.text2={}eG=s(v._player.skills[v._gui.playerSkills.targ][3],1)local eK={[0]="физического",[1]="магического"}rv={}if eD["value"]then rv[1]=eD["value"][eG]else rv[1]=""end;if eD["bseatckinc"]then rv[2]=eD["bseatckinc"][eG]else rv[2]=""end;if type(eD["basedmgmlt"])=="table"then rv[3]=eD["basedmgmlt"][eG]elseif type(eD["basedmgmlt"])=="number"then rv[3]=eD["basedmgmlt"]else rv[3]=""end;if eD["weapondmgmlt"]then rv[4]=eD["weapondmgmlt"][eG]else rv[4]=""end;if eD["eff"]and K[eD["eff"]]["dur"]then rv[5]=K[eD["eff"]]["dur"][eG]else rv[5]=""end;if eD["eff"]and K[eD["eff"]]["val"]then rv[6]=math.abs(K[eD["eff"]]["val"][eG])else rv[6]=""end;eG=v._player.skills[v._gui.playerSkills.targ][3]ntt={["a"]=eK[eD["typedm"]],["b"]=rv[1],["c"]=rv[2],["i"]=rv[3],["e"]=rv[4],["d"]=rv[5],["v"]=rv[6]}n(v._gui.playerSkills.text1,"•"..eD["name"])n(v._gui.playerSkills.text1,"Тип: "..v._data.skillType[eD["type"]])if eG>0 and eD["type"]~=2 then n(v._gui.playerSkills.text1,"Уровень умения: "..eG.." / "..#eD["manacost"])n(v._gui.playerSkills.text1,"Использует маны: "..eD["manacost"][eG].." ед.")n(v._gui.playerSkills.text1,"Перезарядка: "..eD["reloading"].." сек.")if eD["type"]==1 then n(v._gui.playerSkills.text1,"Дальность: "..eD["distance"]+(E or 8))end elseif eG>0 and eD["type"]==2 then n(v._gui.playerSkills.text1,"Уровень умения: "..eG.." / "..#eD["value"])else n(v._gui.playerSkills.text1,"Умение ещё не изучено")end;local eL=""rv=1;for de=1,f.len(eD["descr"])do if f.sub(eD["descr"],rv,rv)~="$"then eL=eL..f.sub(eD["descr"],rv,rv)rv=rv+1 else eL=eL..tostring(ntt[f.sub(eD["descr"],rv+1,rv+1)])rv=rv+2 end end;v._gui.playerSkills.text2=v._function.textWrap(eL,42)if eD["type"]==2 and eG<v._config.maxSkillLevel or eD["type"]~=2 and eG<#eD["manacost"]then v._gui.playerSkills.text3={{"Улучшение умения • следующий уровень "..eG+1,0xEFEFEF}}if eD["reqlvl"]then n(v._gui.playerSkills.text3,{"Требуемый уровень: "..eD["reqlvl"][eG+1],0xEFEFEF})if eD["reqlvl"][eG+1]>Q[v._player.id]["lvl"]then v._gui.playerSkills.text3[#v._gui.playerSkills.text3][2]=0xEE1414 end end;if eD["reqcn"]then n(v._gui.playerSkills.text3,{"Стоимость улучшения: "..eD["reqcn"][eG+1].." монет",0xEFEFEF})if eD["reqcn"][eG+1]>v._player.coins then v._gui.playerSkills.text3[#v._gui.playerSkills.text3][2]=0xEE1414 end end;if eD["reqitem"]and eD["reqitem"][eG+1]then reqItem=eD["reqitem"][eG+1]n(v._gui.playerSkills.text3,{"Требуемый предмет: "..G[reqItem[1]]["name"].."("..v._function.checkItemInBag(reqItem[1]).."/"..reqItem[2]..")",0xEFEFEF})if v._function.checkItemInBag(reqItem[1])<reqItem[2]then v._gui.playerSkills.text3[#v._gui.playerSkills.text3][2]=0xEE1414 end end end end end;function v._function.spawnSingleUnit(b2,ap,aq)local eM=v._function.addUnit(b2,ap,aq)return eM end;function v._function.removeUnit(b2)for a0=1,#Q do if Q[a0]and Q[a0]["target"]==b2 then Q[a0]["target"]=nil end end;if Q[b2]then o(Q,b2)return true end;return false end;function v._function.addFollower(eN)local b2;if eN then if Q[v._player.id]["petcage"]and Q[v._player.id]["petcage"][eN]then b2=Q[v._player.id]["petcage"][eN]["id"]local eO=v._function.spawnSingleUnit(b2,Q[v._player.id]["x"]+math.random(-10,10),1)n(Q[v._player.id]["followers"],{b2,eO})Q[eO]["summoner"]=v._player.id;Q[eO]["lvl"]=Q[v._player.id]["petcage"][eN]["lvl"]or 1;Q[eO]["mxp"]=v._function.getUnitMaxXP(eO)Q[eO]["cxp"]=Q[v._player.id]["petcage"][eN]["cxp"]or 0;Q[eO]["chp"]=Q[v._player.id]["petcage"][eN]["chp"]or 1;v._function.updateUnitStats(eO)Q[eO]["fid"]=eN end end end;function v._function.keepFollower(b2)if Q[b2]and Q[v._player.id]["petcage"]then for a0=1,#Q[v._player.id]["followers"]do if Q[Q[v._player.id]["followers"][a0][2]]["fid"]then if Q[v._player.id]["petcage"][Q[Q[v._player.id]["followers"][a0][2]]["fid"]]then Q[v._player.id]["petcage"][Q[Q[v._player.id]["followers"][a0][2]]["fid"]]["lvl"]=Q[b2]["lvl"]Q[v._player.id]["petcage"][Q[Q[v._player.id]["followers"][a0][2]]["fid"]]["cxp"]=Q[b2]["cxp"]Q[v._player.id]["petcage"][Q[Q[v._player.id]["followers"][a0][2]]["fid"]]["chp"]=Q[b2]["chp"]end end end end end;function v._function.removeFollowers()for ae=1,#Q do if Q[ae]then for a0=1,#Q[v._player.id]["followers"]do if ae==Q[v._player.id]["followers"][a0][2]then v._function.keepFollower(ae)v._function.removeUnit(ae)Q[v._player.id]["followers"]={}end end end end end;local function eP(ch,ap)for a0=1,#ch do if ch[a0]=="np"then v._function.addUnit(v._data.potralUnitId,ap+10,2)elseif type(ch[a0])=="table"and ch[a0][1]=="sp"and F[ch[a0][2]]["nres"]then v._function.spawnSingleUnit(ch[a0][2],ap+v._function.random(-10,10),1)elseif type(ch[a0])=="table"and ch[a0][1]=="cq"then for ae=1,#ch[a0]-1 do H[ch[a0][ae+1]]["comp"]=2;for e=1,#v._player.quests do if v._player.quests[#v._player.quests-e+1][1]==ch[a0][ae+1]then o(v._player.quests,#v._player.quests-e+1)end end end end end end;function v._function.getLootItems(eQ)local eR={}if Q[eQ]then if F[Q[eQ]["id"]]["loot"]["drop"]then for a0=1,#F[Q[eQ]["id"]]["loot"]["drop"]do eR[#eR+1]=F[Q[eQ]["id"]]["loot"]["drop"][a0]end end;for a0=1,#M[F[Q[eQ]["id"]]["loot"]["items"]]do eR[#eR+1]=M[F[Q[eQ]["id"]]["loot"]["items"]][a0]end;eR=bT(eR)local eS=F[Q[eQ]["id"]]["tcdrop"]or 1;for dN=1,eS do for a0=1,#eR do if eR[a0][1]~=nil and v._function.random(1,100000)<=eR[a0][2]*1000 then if v._function.random(1,100)>=v._parameter.lootItemImprovedChance then eR[a0][1]=bX(eR[a0][1])end;v._function.addItem(eR[a0][1],1,true)break end end end else v._function.logtxt("getLootItems: ID не существует")end end;function v._function.getLootExperience(eQ)if Q[eQ]and F[Q[eQ]["id"]]["loot"]then return F[Q[eQ]["id"]]["loot"]["exp"]+q(v._function.random(-F[Q[eQ]["id"]]["loot"]["exp"]*0.1,F[Q[eQ]["id"]]["loot"]["exp"]*0.1))else v._function.logtxt("getLootExperience: ID не существует")return 0 end end;function v._function.getUnitMaxXP(b2)local cv=0;for e=1,Q[b2]["lvl"]do if e<=10 then cv=p(cv+cv*2/e+24*e^(1/e))elseif e>20 and e<30 then cv=p(cv+cv*3/e+28*e^(1/e))elseif e>=30 then cv=p(cv+cv*4/e+32*e^(1/e))end end;return s(cv,1)end;local function eT(b2,c8)local cx,aH,ae=c8 or 0,50,0;if b2 then while ae<=aH do Q[b2]["mxp"]=v._function.getUnitMaxXP(b2)if cx<=Q[b2]["mxp"]-Q[b2]["cxp"]then Q[b2]["cxp"]=Q[b2]["cxp"]+cx;break else if Q[b2]["summoner"]and Q[Q[b2]["summoner"]]["lvl"]>Q[b2]["lvl"]then cx=cx-(Q[b2]["mxp"]-Q[b2]["cxp"])Q[b2]["cxp"]=0;Q[b2]["lvl"]=Q[b2]["lvl"]+1;v._function.updateUnitStats(b2)Q[b2]["chp"]=Q[b2]["mhp"]ae=ae+1 else Q[b2]["cxp"]=Q[b2]["mxp"]break end end end else v._function.logtxt("addUnitXP: ID не существует")end end;function v._function.huntingQuestProcessing(b2)local ce;if Q[b2]then for a0=1,#v._player.quests do if H[v._player.quests[a0][1]]["type"]==1 and type(v._player.quests[a0][2])=="number"then if Q[b2]["id"]==H[v._player.quests[a0][1]]["targ"]and v._player.quests[a0][3]==false then if v._player.quests[a0][2]+1<H[v._player.quests[a0][1]]["num"]then v._player.quests[a0][2]=v._player.quests[a0][2]+1 else H[v._player.quests[a0][1]]["comp"]=2;v._player.quests[a0][2]=H[v._player.quests[a0][1]]["num"]v._player.quests[a0][3]=true;v._function.showMessage1('Задание "'..H[v._player.quests[a0][1]]["name"]..'" выполнено!')end;v._gui.qPanel.update()end elseif H[v._player.quests[a0][1]]["type"]==1 and type(v._player.quests[a0][2])=="table"then for c9=1,#H[v._player.quests[a0][1]]["targ"]do if Q[b2]["id"]==H[v._player.quests[a0][1]]["targ"][c9]and v._player.quests[a0][3]==false then if v._player.quests[a0][2][c9]<H[v._player.quests[a0][1]]["num"][c9]then v._player.quests[a0][2][c9]=v._player.quests[a0][2][c9]+1 end end end;ce=0;for c9=1,#H[v._player.quests[a0][1]]["targ"]do if v._player.quests[a0][2][c9]==H[v._player.quests[a0][1]]["num"][c9]then ce=ce+1 end end;if ce==#H[v._player.quests[a0][1]]["targ"]then if H[v._player.quests[a0][1]]["comp"]==1 then v._function.showMessage1('Задание "'..H[v._player.quests[a0][1]]["name"]..'" выполнено!')end;H[v._player.quests[a0][1]]["comp"]=2;for c9=1,#H[v._player.quests[a0][1]]["targ"]do v._player.quests[a0][2][c9]=H[v._player.quests[a0][1]]["num"][c9]end;v._player.quests[a0][3]=true end end end end end;function v._function.killUnit(b2)Q[b2]["living"]=false;Q[b2]["resptime"]=F[Q[b2]["id"]]["vresp"]Q[b2]["mx"]=Q[b2]["x"]Q[b2]["target"]=nil;Q[b2]["effects"]={}Q[b2]["chp"]=Q[b2]["mhp"]v._gui.qPanel.update()v._function.effect[2](b2)end;local function eU(eV,eW,eX)if eX then v._function.addUnitHitInfo(eV,"Критический урон "..q(eW))else v._function.addUnitHitInfo(eV,"Урон "..q(eW))end end;function v._function.healUnit(b2,c8)if Q[b2]["chp"]+c8<Q[b2]["mhp"]then Q[b2]["chp"]=Q[b2]["chp"]+c8 else Q[b2]["chp"]=Q[b2]["mhp"]end end;local function eY()v._player.pckTarget=nil;v._player.pickingUp=false;v._player.pckTime,v._player.maxPckTime=0,0;Q[v._player.id]["cmove"]=true;Q[v._player.id]["image"]=0 end;function v._function.makeDamage(eZ,b2,eW,e_,f0)local f1;if Q[eZ]and Q[b2]and eW then eW=v._function.roundUpNumber(eW)eU(b2,eW,f0 or false)if Q[b2]["chp"]>eW then Q[b2]["chp"]=Q[b2]["chp"]-eW;if b2==v._player.id then Q[b2]["rage"]=10;if v._player.pickingUp then if Q[b2]["target"]==v._player.pckTarget then Q[b2]["target"]=nil end;eY()end;if Q[b2]["target"]==nil and e_~=true then Q[b2]["target"]=eZ end else if e_~=true then Q[b2]["target"]=eZ end end elseif Q[b2]["chp"]<=eW then v._function.killUnit(b2)if b2==v._player.id then else v._function.getLootItems(b2)v._function.huntingQuestProcessing(b2)f1=v._function.getLootExperience(b2)cw(f1)if Q[eZ]["followers"]then for a0=1,#Q[eZ]["followers"]do eT(Q[eZ]["followers"][a0][2],p(f1/#Q[eZ]["followers"]))end end;if Q[eZ]["summoner"]and Q[eZ]["summoner"]==v._player.id then eT(eZ,f1)end;local f2=F[Q[b2]["id"]]["loot"]["coins"]local f3=f2+q(f2*v._function.random(-(50+1.11^r(Q[b2]["lvl"],35)),50+1.11^r(Q[b2]["lvl"],35))/100)v._function.addCoins(f3)if F[Q[b2]["id"]]["nres"]==true then F[Q[b2]["id"]]["nres"]=false else Q[b2]["resptime"]=F[Q[b2]["id"]]["vresp"]end;if Q[eZ]["target"]==b2 then Q[eZ]["target"]=nil end;if F[Q[b2]["id"]]["ifDied"]then eP(F[Q[b2]["id"]]["ifDied"],Q[b2]["x"])end;v._gui.targetInfoPanel.showTargetInfo=false end end else v._function.logtxt("game._function.makeDamage: ошибка данных")end end;function v._function.drawParticles()local ap,aq,d6,f4;for ae=1,#R do ap,aq=R[ae].x,R[ae].y;d6=ap+75-A;k.drawText(p(d6),u-p(aq),R[ae].color,"▪")if not v._data.paused then if R[ae].my<0 and aq<3 then R[ae].my=R[ae].my*-0.5;R[ae].color=0x000000 end;R[ae].x=ap+R[ae].mx;R[ae].y=aq+R[ae].my;f4=R[ae].gravity;if f4~=0 then R[ae].my=R[ae].my-f4 end end end end;local function f5(ap,aq,f6,f7,f8,f9,fa)local fb={x=ap,y=aq,mx=f6,my=f7,life=f8,color=f9,gravity=fa}table.insert(R,fb)end;local function fc(ap,aq,f6,f7,fd,f8,fa)for ae=1,fd do f5(ap,aq,f6,f7,f8,0xff8080,fa)end end;v._function.effect={[1]=function(fe,ff)local ap,aq=Q[fe]["x"],10;local fd=1;local f6;if ff==1 then f6=-1 else f6=1 end;local f7,f8=0.1+math.random(-1,1),math.random(0,2)fc(ap,aq,f6,f7,fd,f8,0.05)end,[2]=function(fe)local ap,aq=Q[fe]["x"],10;for ae=1,10 do f5(ap,aq,math.random(-10,10)/10,0,2,0xff8080,0.05)end end,[3]=function(fe)local ap,aq=Q[fe]["x"]+Q[fe]["width"]/2,5;local f9;for ae=1,12 do if math.random(0,1)==0 then f9=0xffff00 else f9=0xff0000 end;f5(ap,aq,math.random(-10,10)/10,math.random(0,10)/10,1,f9,0)end end,[4]=function(fe)local ap,aq=Q[fe]["x"]+Q[fe]["width"]/2,10;local f9;for ae=1,10 do if math.random(0,1)==0 then f9=0xffff00 else f9=0xff0000 end;f5(ap,aq,math.random(-5,5)/10,math.random(0,5)/10,2,f9,-0.01)end end,[5]=function(fe)local ap,aq=Q[fe]["x"]+Q[fe]["width"]/2,10;local f9;for ae=1,10 do f5(ap,aq,math.random(-5,5)/10,math.random(0,5)/10,2,0x0080ff,-0.01)end end,[6]=function(fe)local ap,aq=Q[fe]["x"]+Q[fe]["width"]/2,10;for ae=1,10 do f5(ap,aq,math.random(-5,5)/10,0,2,0x800040,0.01)end end,[7]=function(fe)local ap,aq=Q[fe]["x"]+Q[fe]["width"]/2,20;for ae=1,16 do f5(ap+math.random(-10,10)/10,aq+math.random(-20,20)/10,0,math.random(0,5)/10,2,0xaaaaff,0.01)end end}function v._function.enemySkill(b2,fe,fg,bA)local eW,fh,fi=0;local cC=false;if Q[fe]["rtype"]==1 or Q[fe]["rtype"]==4 then cC=true end;if not(Q[b2]["target"]and Q[fe]and Q[b2]["living"])then cC=false end;if Q[b2]["rtype"]==1 and Q[b2]["summoner"]and Q[b2]["summoner"]==fe then cC=false end;if cC and J[fg]["type"]==1 and Q[b2]["ctck"]then local aP=F[Q[b2]["id"]]["atds"]+J[fg]["distance"]if v._function.getDistanceToId(fe,b2)>aP then if Q[b2]["x"]>Q[fe]["x"]then b1(b2,1)Q[b2]["mx"]=Q[fe]["x"]+Q[fe]["width"]+aP else b1(b2,2)Q[b2]["mx"]=Q[fe]["x"]-aP end else if Q[b2]["x"]>Q[fe]["x"]then b1(b2,1)else b1(b2,2)end;Q[b2]["mx"]=Q[b2]["x"]if J[fg]["typedm"]==1 then fh=v._function.random(Q[b2]["mtk"][1]*10,Q[b2]["mtk"][2]*10)/10;fi=Q[fe]["mdef"]/(Q[fe]["mdef"]+Q[b2]["lvl"]*v._parameter.magicalDamageReductionMul)elseif J[fg]["typedm"]==0 then fh=v._function.random(Q[b2]["ptk"][1]*10,Q[b2]["ptk"][2]*10)/10;fi=Q[fe]["pdef"]/(Q[fe]["pdef"]+Q[b2]["lvl"]*v._parameter.physicalDamageReductionMul)end;fh=fh+v._function.random(J[fg]["damageinc"][bA][1],J[fg]["damageinc"][bA][2])*(1+Q[b2]["lvl"]*0.1)eW=s(p(fh*(1-fi)),1)v._function.makeDamage(b2,fe,eW)if J[fg]["visual"]then v._function.effect[J[fg]["visual"]](fe)else v._function.effect[1](fe,Q[b2]["spos"])end;if not Q[fe]["target"]then Q[fe]["target"]=b2 end;if J[fg]["eff"]then v._function.addUnitEffect(fe,J[fg]["eff"][1],J[fg]["eff"][2],b2)end end elseif J[fg]["type"]==2 then v._function.addUnitEffect(b2,J[fg]["eff"][1],J[fg]["eff"][2])if J[fg]["visual"]then v._function.effect[J[fg]["visual"]](b2)end end end;function v._function.useSkill(bb)local fj=v._player.skills[v._player.actSkills[bb]][1]local bA=v._player.skills[v._player.actSkills[bb]][3]local fk=Q[v._player.id]["target"]or 0;local fl,fm=false,false;if v._player.inventory["weared"]["weapon"][1]~=0 then if I[fj]["weaponreq"]then for a0=1,#I[fj]["weaponreq"]do if G[v._player.inventory["weared"]["weapon"][1]]["subtype"]==I[fj]["weaponreq"][a0]then fl=true;break end end else fl=true end end;if Q[v._player.id]["targ"]then fk=Q[v._player.id]["targ"][2]end;local fn=function(ae)local fo={1,2,5,3}for a0=1,#fo do if ae==fo[a0]then return true end end end;local fp=function(eV)local fq=0;local eW=0;if I[fj]["typedm"]==0 then eW=eW+v._function.random(Q[v._player.id]["ptk"][1]*10,Q[v._player.id]["ptk"][2]*10)/10;fq=v._function.random(v._player.statsPoints.vPdm1,v._player.statsPoints.vPdm2)elseif I[fj]["typedm"]==1 then eW=eW+v._function.random(Q[v._player.id]["mtk"][1]*10,Q[v._player.id]["mtk"][2]*10)/10;fq=v._function.random(v._player.statsPoints.vMdm1,v._player.statsPoints.vMdm2)end;if type(I[fj]["basedmgmlt"])=="table"then eW=eW+eW*I[fj]["basedmgmlt"][bA]*0.01 elseif type(I[fj]["basedmgmlt"])=="number"then eW=eW+eW*I[fj]["basedmgmlt"]*0.01 end;if I[fj]["weapondmgmlt"]and v._player.inventory["weared"]["weapon"][1]>0 then eW=eW+fq*I[fj]["weapondmgmlt"][bA]*0.01 end;if I[fj]["bseatckinc"]then eW=eW+eW*I[fj]["bseatckinc"][bA]*0.01 end;if I[fj]["value"]then eW=eW+I[fj]["value"][bA]end;if I[fj]["typedm"]==0 then eW=s(eW*(1-Q[fk]["pdef"]/(Q[fk]["pdef"]+Q[v._player.id]["lvl"]*30)),0.1)elseif I[fj]["typedm"]==1 then eW=s(eW*(1-Q[fk]["mdef"]/(Q[fk]["mdef"]+Q[v._player.id]["lvl"]*30)),0.1)end;if eW>0 then v._function.effect[1](fk,Q[v._player.id]["spos"])end;return s(eW,1)end;if Q[v._player.id]["ctck"]==true and Q[v._player.id]["cmp"]>=I[fj]["manacost"][bA]and v._player.skills[v._player.actSkills[bb]][2]==0 then fl=true else fl=false end;if fk~=0 then if fn(Q[fk]["rtype"])and I[fj]["type"]~=4 then fl=false end end;local fr,eX=false;if fl then if I[fj]["type"]==1 then if fk~=0 and Q[fk]["living"]and v._function.getDistanceToId(v._player.id,fk)<=E+I[fj]["distance"]then if Q[fk]["x"]>Q[v._player.id]["x"]then b1(v._player.id,2)else b1(v._player.id,1)end;if I[fj]["action"]and I[fj]["action"]["type"]==1 then for a0=1,#Q do if Q[a0]and Q[a0]["living"]and v._function.getDistanceToId(fk,a0)<=I[fj]["action"]["dist"]and not fn(Q[a0]["rtype"])then fr=fp(a0)if v._function.random(1,100)<=v._player.critChance then fr=fr*2;eX=true end;v._function.makeDamage(v._player.id,a0,fr,false,eX)if I[fj]["visual"]then v._function.effect[I[fj]["visual"]](a0,Q[v._player.id]["spos"])end;if I[fj]["eff"]~=nil then v._function.addUnitEffect(a0,I[fj]["eff"],v._player.skills[v._player.actSkills[bb]][3])end end end else fr=fp(fk)if v._function.random(1,100)<=v._player.critChance then fr=fr*2;eX=true end;v._function.makeDamage(v._player.id,fk,fr,false,eX)if I[fj]["visual"]then v._function.effect[I[fj]["visual"]](fk,Q[v._player.id]["spos"])end;if fk~=0 and I[fj]["eff"]~=nil then v._function.addUnitEffect(fk,I[fj]["eff"],v._player.skills[v._player.actSkills[bb]][3])end end;if Q[v._player.id]["followers"]then for a0=1,#Q[v._player.id]["followers"]do if not Q[Q[v._player.id]["followers"][a0][2]]["target"]then Q[Q[v._player.id]["followers"][a0][2]]["target"]=Q[v._player.id]["target"]end end end;fm=true end elseif I[fj]["type"]==3 then if I[fj]["eff"]~=nil then v._function.addUnitEffect(v._player.id,I[fj]["eff"],bA)end;dF[1]=I[fj]["name"]fm=true elseif I[fj]["type"]==4 then for a0=1,#Q[v._player.id]["followers"]do if fk==Q[v._player.id]["followers"][a0][2]then if Q[fk]["x"]>Q[v._player.id]["x"]then b1(v._player.id,2)else b1(v._player.id,1)end;v._function.healUnit(fk,Q[fk]["mhp"]/100*I[fj]["value"][bA])if I[fj]["visual"]then v._function.effect[I[fj]["visual"]](v._player.id)v._function.effect[I[fj]["visual"]](fk)end;fm=true;break end end end;if fm then Q[v._player.id]["cmp"]=Q[v._player.id]["cmp"]-I[fj]["manacost"][bA]v._player.skills[v._player.actSkills[bb]][2]=I[fj]["reloading"]*10;b4(-4)pimg4t=0;dE=3;dF[1]=I[fj]["name"]Q[v._player.id]["rage"]=10 end end end;function v._function.usePlayerSkill(bb)local fs,eV;if v._player.actSkills[bb]>0 and v._player.skills[v._player.actSkills[bb]]and v._player.skills[v._player.actSkills[bb]][3]>0 and not v._player.pickingUp then fs=I[v._player.skills[v._player.actSkills[bb]][1]]["type"]if fs==1 or fs==4 then if Q[v._player.id]["target"]~=nil then E=E or 8;if v._function.getDistanceToId(v._player.id,Q[v._player.id]["target"])>v._function.getPlayerAtdsBySkill(bb)then Q[v._player.id]["targ"]={2,Q[v._player.id]["target"],v._function.getPlayerAtdsBySkill(bb),bb}else v._function.useSkill(bb)Q[v._player.id]["targ"]={2,Q[v._player.id]["target"],v._function.getPlayerAtdsBySkill(bb),bb}v._player.moving=false;C=0;Q[v._player.id]["mx"]=Q[v._player.id]["x"]end end elseif fs==3 then v._function.useSkill(bb)Q[v._player.id]["targ"]=nil;C=0 end end end;function v._function.pickUpResource(b2)local fl=true;if Q[b2]then if Q[b2]["reqquest"]then fl=false;for a0=1,#v._player.quests do if v._player.quests[a0][1]==Q[b2]["reqquest"]then if v._player.quests[a0][3]==true then break else fl=true;break end end end end;if fl then v._player.pckTarget=b2;v._player.pickingUp=true;local ft=v._function.random(F[Q[b2]["id"]]["mnprs"]*10,F[Q[b2]["id"]]["mxprs"]*10)v._player.pckTime,v._player.maxPckTime=ft,ft;Q[v._player.id]["cmove"]=false;b4(-1)Q[v._player.id]["mx"]=Q[v._player.id]["x"]end end end;function v._function.getQuestReward(b2)if H[b2]then cw(H[b2]["qreward"]["xp"])v._player.coins=v._player.coins+H[b2]["qreward"]["coins"]if H[b2]["qreward"]["item"]then for cg=1,#H[b2]["qreward"]["item"]do if type(H[b2]["qreward"]["item"][cg][1])=="table"then for an=1,#H[b2]["qreward"]["item"][cg]do v._gui.rewardChoice.buffer.items[an]={}v._gui.rewardChoice.buffer.items[an][1]=H[b2]["qreward"]["item"][cg][an][1]v._gui.rewardChoice.buffer.items[an][2]=H[b2]["qreward"]["item"][cg][an][2]v._gui.rewardChoice.buffer.images[an]=c.load(v._data.text.directory.."itempic/"..v._data.itemIcons[G[H[b2]["qreward"]["item"][cg][an][1]]["icon"]]..".pic")end;v._data.windowThread="rewardChoice"else v._function.addItem(H[b2]["qreward"]["item"][cg][1],H[b2]["qreward"]["item"][cg][2],true)end end end else v._function.logtxt("game._function.getQuestReward: ID не существует")end end;function v._function.gatheringAction(b2)C=0;moving=false;if not F[Q[b2]["id"]]["reqlvl"]or F[Q[b2]["id"]]["reqlvl"]and F[Q[b2]["id"]]["reqlvl"]<=Q[v._player.id]["lvl"]then if F[Q[b2]["id"]]["reqquest"]then for de=1,#v._player.quests do if v._player.quests[de][1]==F[Q[b2]["id"]]["reqquest"]and v._player.quests[de][3]==false then v._function.pickUpResource(b2)end end else v._function.pickUpResource(b2)end elseif not F[Q[b2]["id"]]["reqquest"]then v._function.showMessage1("Недостаточно опыта")end end;function v._function.gathering()if not v._player.pickingUp then if v._function.getDistanceToId(v._player.id,Q[v._player.id]["target"])<=11 then v._function.gatheringAction(Q[v._player.id]["target"])else Q[v._player.id]["targ"]={1,Q[v._player.id]["target"],5}v._function.getClose(v._player.id,Q[v._player.id]["target"],5)v._player.moving=true end end end;function v._function.getClose(b2,d2,fu)if Q[b2]["x"]>p(Q[d2]["x"])+Q[d2]["width"]then Q[b2]["mx"]=p(Q[d2]["x"])+Q[d2]["width"]+v._function.roundUpNumber(fu)elseif Q[b2]["x"]+Q[b2]["width"]<p(Q[d2]["x"])then Q[b2]["mx"]=q(Q[d2]["x"])-Q[b2]["width"]-v._function.roundUpNumber(fu)end end;function v._function.getRawCount(aa)local bR=0;for a0,ci in pairs(aa)do bR=bR+1 end;return bR end;function v._function.debugText()local text={"#savedUnits = "..tostring(cA()),"#CGD = "..#Q,"#gid = "..#G}for a0=1,#text do k.drawText(2,49-#text+a0,0xffffff,text[a0])end end;v._gui.qPanel={x=160,y=8,cx=0,w=0,h=0,cscroll=1,minimized=false,list={},action={}}function v._gui.qPanel.update()v._gui.qPanel.list={}for a0=v._gui.qPanel.cscroll,r(#v._player.quests,10)+v._gui.qPanel.cscroll do if v._player.quests[a0]then if v._player.quests[a0][3]==true then cl=0x00C222 else cl=0xEFEFEF end;v._gui.qPanel.list[#v._gui.qPanel.list+1]={"→"..H[v._player.quests[a0][1]]["name"],cl}if H[v._player.quests[a0][1]]["type"]==1 and type(H[v._player.quests[a0][1]]["num"])=="number"then v._gui.qPanel.list[#v._gui.qPanel.list+1]={" "..F[H[v._player.quests[a0][1]]["targ"]]["name"].."("..v._player.quests[a0][2].."/"..H[v._player.quests[a0][1]]["num"]..")",cl}end end end end;function v._gui.qPanel.draw()local ap,aq=v._gui.qPanel.x,v._gui.qPanel.y;local cl=nil;local aF=0;local d4;if#v._gui.qPanel.list>0 then for a0=1,#v._gui.qPanel.list do if f.len(v._gui.qPanel.list[a0][1])+1>aF then aF=f.len(v._gui.qPanel.list[a0][1])+1 end end;v._gui.qPanel.w=r(aF,45)d4=r(ap,t-v._gui.qPanel.w-1)k.drawRectangle(d4,aq,s(v._gui.qPanel.w,8),1,0x525252,0," ")if v._gui.qPanel.minimized==false then k.drawRectangle(d4,aq+1,s(v._gui.qPanel.w,8),#v._gui.qPanel.list,0x828282,0," ",cl)for a0=1,#v._gui.qPanel.list do k.drawText(d4,aq+a0,v._gui.qPanel.list[a0][2],v._gui.qPanel.list[a0][1])end end;k.drawText(d4,aq,0xEFEFEF,"Задания")if v._gui.qPanel.minimized==false then k.drawText(d4+aF-1,aq,0xEFEFEF,"^")else k.drawText(d4+aF-1,aq,0xEFEFEF,"V")end;v._gui.qPanel.cx=d4 end end;v._gui.qPanel.action["touch"]=function(af)local ap,aq,aF=v._gui.qPanel.cx,v._gui.qPanel.y,v._gui.qPanel.w;if af[5]==0 and ao(af[3],af[4],ap+aF-1,aq,ap+aF-1,aq)then v._gui.qPanel.minimized=not v._gui.qPanel.minimized end end;local function fv()if Q[v._player.id]["spos"]==2 then k.drawImage(v._player.screenPosition,49-Q[v._player.id]["height"]-v._function.roundUpNumber(Q[v._player.id]["y"]),O[Q[v._player.id]["image"]])else k.drawImage(v._player.screenPosition,49-Q[v._player.id]["height"]-v._function.roundUpNumber(Q[v._player.id]["y"]),c.flipHorizontally(O[Q[v._player.id]["image"]]))end end;local fw,fx,fy,fz=0,0,0,{{5,0xFF6D00},{9,0xFFB640},{15,0xFFFF40},{50,0x40FF40}}local fA=0;local function fB()if v._data.windowThread~="inventory"and v._data.windowThread~="tradeWindow"and v._data.windowThread~="craftWindow"and v._data.windowThread~="menu"then N[N.current].draw()fv()v._function.drawAllCGDUnits()v._function.drawParticles()if v._data.windowThread~="screen_save"then if Q[v._player.id]["living"]then if v._data.windowThread~="pause"then v._gui.playerInfoPanel.draw()end;if Q[v._player.id]["target"]then v._gui.targetInfoPanel.draw()end;v._gui.skillsTopPanel.draw()v._gui.followerInfo.draw()v._gui.qPanel.draw()end;if v._data.messageTable1timer>0 then k.drawText(9,49,0x929292,">"..(v._data.messageTable1[#v._data.messageTable1-1]or""))k.drawText(9,50,0xC7C7C7,">"..(v._data.messageTable1[#v._data.messageTable1]or""))end;if bn>0 then k.drawText(80-f.len(bm[#bm])/2,12,0xD3D3D3,bm[#bm])end;if bq>0 then k.drawText(2,13,0x9C9C9C,bp[#bp-2])k.drawText(2,14,0xACACAC,bp[#bp-1])k.drawText(2,15,0xBCBCBC,bp[#bp])end;if#br>0 then for an=1,3 do if br[an]then k.drawText(v._player.screenPosition,47-Q[v._player.id]["height"]-2-an,0xBCBCBC,br[an])end end;bs=bs-1;if bs<=0 then table.remove(br,1)end end end end;if v._data.windowThread==nil then k.drawText(156,2,0xffffff,"█ █")k.drawText(156,3,0xffffff,"█ █")elseif v._data.windowThread=="pause"then v._gui.pauseMenu.draw()elseif v._data.windowThread=="inventory"then v._gui.inventory.draw()elseif v._data.windowThread=="dialog"then v._gui.NPCDialog.draw()elseif v._data.windowThread=="spdialog"then v._function.specialDialog.draw()elseif v._data.windowThread=="quests"then v._gui.questsList.draw()elseif v._data.windowThread=="console"then v._function.gameConsole.draw()elseif v._data.windowThread=="pstats"then v._gui.playerStats.draw()elseif v._data.windowThread=="tradeWindow"then v._function.tradew.draw()elseif v._data.windowThread=="craftWindow"then v._function.craftw.draw()elseif v._data.windowThread=="died"then v._function.ydw.draw()elseif v._data.windowThread=="skillsWindow"then v._gui.playerSkills.draw()elseif v._data.windowThread=="menu"then v._gui.mainMenu.draw()elseif v._data.windowThread=="rewardChoice"then v._gui.rewardChoice.draw()end;if v._config.debugMode==true then v._function.debugText()end;for a0=1,#fz do if fz[a0][1]>=X then fy=fz[a0][2]break end end;k.drawText(1,u,fy,tostring(X))Y=v._function.RAMInfo()k.drawText(t-#Y,50,0xC7C7C7,Y)k.drawChanges()end;function v._function.mCheck()if g.totalMemory()>=2*1024^2 then return true end;if g.freeMemory()<2^14 then return false end end;function v._function.codeToSymbol(fC)local fD;if fC~=0 and fC~=13 and fC~=8 and fC~=9 and fC~=200 and fC~=208 and fC~=203 and fC~=205 and not h.isControlDown()then fD=f.char(fC)if h.isShiftPressed then fD=f.upper(fD)end end;return fD end;function v._function.getFileList(a8)local fE=i.list(a8)local aa={}for a9 in fE do table.insert(aa,a9)end;fE=nil;return aa end;function v._function.textInput(af,fF,aH)local text=fF or""if f.len(text)<=aH then if af[1]=="key_down"then if af[4]==28 then return text elseif af[4]==14 and text~=""then return f.sub(text,1,-2)else return text..(v._function.codeToSymbol(af[3])or"")end elseif e[1]=="clipboard"then if e[3]then return text..af[3]end end else return text end end;function v._function.initGame()v._player.quests={}v._player.pickingUp=false;v._gui.targetInfoPanel.showTargetInfo=false;Q={}S={}for a0=1,#N do S[a0]={}end;N.current=1;v._function.addUnit(v._player.id,1,1)v._player.inventory={["weared"]={["helmet"]={0,0,{}},["pendant"]={0,0,{}},["armor"]={0,0,{}},["robe"]={0,0,{}},["pants"]={0,0,{}},["weapon"]={v._config.startWeapon[v._player.class],1,{}},["footwear"]={0,0,{}},["ring"]={0,0,{}}},["bag"]={}}for a0=1,v._parameter.inventorySize do v._player.inventory["bag"][a0]={0,0,{}}end;F[Q[v._player.id]["id"]]["name"]=v._player.name;Q[v._player.id]["levelpoints"]=F[v._player.gudId]["lvl"]*2-2;Q[v._player.id]["surv"]=F[v._player.gudId]["surv"]Q[v._player.id]["strg"]=F[v._player.gudId]["strg"]Q[v._player.id]["int"]=F[v._player.gudId]["int"]Q[v._player.id]["agi"]=F[v._player.gudId]["agi"]Q[v._player.id]["followers"]={}Q[v._player.id]["target"]=nil;Q[v._player.id]["rage"]=0;Q[v._player.id]["cmp"]=0;Q[v._player.id]["mmp"]=0;Q[v._player.id]["cxp"]=0;Q[v._player.id]["mxp"]=0;v._player.coins=0;Q[v._player.id]["targ"]=nil;Q[v._player.id]["vx"]=0;Q[v._player.id]["vy"]=0;Q[v._player.id]["spos"]=2;Q[v._player.id]["petcage"]={}v._player.skills={}for a0=1,#T[v._player.class]["skills"]do v._player.skills[a0]={}for an=1,#T[v._player.class]["skills"][a0]do v._player.skills[a0][an]=T[v._player.class]["skills"][a0][an]end end;v._function.loadWorld(N.current)v._function.UpdatePlayerStats()v._function.maxXP()Q[v._player.id]["chp"]=Q[v._player.id]["mhp"]Q[v._player.id]["cmp"]=Q[v._player.id]["mmp"]v._data.windowThread=nil;v._gui.mainMenu.obj={}v._data.stopDrawing=false;v._data.paused=false end;local fG={"Новая игра","Загрузить игру","Выйти из игры"}function v._gui.mainMenu.open(fH)v._data.paused=true;v._data.windowThread="menu"v._gui.mainMenu.obj.img=c.load(v._data.text.directory.."image/slg.pic")v._gui.mainMenu.mode=fH end;v._gui.mainMenu.MenuAction={[1]=function()v._gui.mainMenu.mode=1 end,[2]=function()v._gui.mainMenu.mode=2;v._gui.mainMenu[2].buff=v._function.getFileList(v._data.text.directory.."saves")if v._gui.mainMenu[2].buff[1]then v._gui.mainMenu[2].targ=1 end end,[3]=function()v._data.inGame=false end}function v._gui.mainMenu.draw()k.drawRectangle(1,1,t,u,0x002440,0," ")k.drawRectangle(1,44,t,6,0x222222,0," ")k.drawRectangle(1,50,t,1,0x000000,0," ")if v._gui.mainMenu.obj.img then k.drawImage(v._gui.mainMenu.imgx,v._gui.mainMenu.imgy,v._gui.mainMenu.obj.img)end;if math.random(1,5)==5 then n(v._gui.mainMenu.obj,{x=math.random(4,156),y=50,vx=0.1,vy=-0.005*math.random(1,5)})end;for an=1,#v._gui.mainMenu.obj do v._gui.mainMenu.obj[an].vx=v._gui.mainMenu.obj[an].vx+math.random(-50,50)*0,1 end;local an;for a0=1,#v._gui.mainMenu.obj do an=#v._gui.mainMenu.obj-a0+1;if v._gui.mainMenu.obj[an]then v._gui.mainMenu.obj[an].vy=v._gui.mainMenu.obj[an].vy-0.01;v._gui.mainMenu.obj[an].x=v._gui.mainMenu.obj[an].x+v._gui.mainMenu.obj[an].vx;v._gui.mainMenu.obj[an].y=v._gui.mainMenu.obj[an].y+v._gui.mainMenu.obj[an].vy;if v._gui.mainMenu.obj[an].y<=0 then o(v._gui.mainMenu.obj,an)end end end;for a0=1,#v._gui.mainMenu.obj do k.drawText(v._function.roundUpNumber(v._gui.mainMenu.obj[a0].x),u-v._function.roundUpNumber(v._gui.mainMenu.obj[a0].y),0x575757,"*")end;local function fI(ap,aq,aa)for a0=1,#aa do ccolor=aa[a0].bcolor;if aa[a0].clicked and aa[a0].clicked==1 then ccolor=aa[a0].ccolor end;k.drawRectangle(ap+aa[a0].x,aq+aa[a0].y-1,aa[a0].w,aa[a0].h,ccolor,0," ")k.drawText(ap+aa[a0].x+p(aa[a0].w/2-f.len(aa[a0].txt)/2),aq+aa[a0].y+p(aa[a0].h/2)-1,aa[a0].fcolor,aa[a0].txt)end end;if v._gui.mainMenu.mode==0 then local ap,aq=p(t/2-v._gui.mainMenu.w/2),p(u/2-v._gui.mainMenu.h/2)v._gui.mainMenu.x,v._gui.mainMenu.y=ap,aq;local dg="Главное меню"k.drawRectangle(ap,aq,v._gui.mainMenu.w,v._gui.mainMenu.h,0x9D9D9D,0," ")k.drawText(ap+p(v._gui.mainMenu.w/2-f.len(dg)/2),aq+1,0xffffff,dg)for a0=1,#fG do k.drawRectangle(ap+v._gui.mainMenu.bx,aq+a0*4,v._gui.mainMenu.w-v._gui.mainMenu.bx*2,v._gui.mainMenu.bh,0x838383,0," ")k.drawText(ap+s(p(v._gui.mainMenu.w/2-f.len(fG[a0])/2),0),aq+a0*4+1,0xffffff,fG[a0])end elseif v._gui.mainMenu.mode==1 then local ap,aq=p(t/2-v._gui.mainMenu[1].w/2),p(u/2-v._gui.mainMenu[1].h/2)local fJ;v._gui.mainMenu[1].x,v._gui.mainMenu[1].y=ap,aq;local dg="Создание персонажа"k.drawRectangle(ap,aq,v._gui.mainMenu[1].w,v._gui.mainMenu[1].h,0x9D9D9D,0," ")k.drawText(ap+p(v._gui.mainMenu[1].w/2-f.len(dg)/2),aq+1,0xffffff,dg)fI(ap,aq,v._gui.mainMenu[1].obj)elseif v._gui.mainMenu.mode==2 then local ap,aq=p(t/2-v._gui.mainMenu[2].w/2),p(u/2-v._gui.mainMenu[2].h/2)local ccolor;v._gui.mainMenu[2].x,v._gui.mainMenu[2].y=ap,aq;local dg="Загрузить игру"k.drawRectangle(ap,aq,v._gui.mainMenu[2].w,v._gui.mainMenu[2].h,0x9D9D9D,0," ")k.drawText(ap+p(v._gui.mainMenu[2].w/2-f.len(dg)/2),aq+1,0xffffff,dg)fI(ap,aq,v._gui.mainMenu[2].obj)for a0=1,#v._gui.mainMenu[2].buff do ccolor=0xffffff;if a0==v._gui.mainMenu[2].targ then ccolor=0x00aa22 end;k.drawText(ap+p(v._gui.mainMenu[2].w/2-f.len(v._gui.mainMenu[2].buff[a0])/2),aq+6+a0*2-2,ccolor,v._gui.mainMenu[2].buff[a0])end end end;v._gui.mainMenu.action["touch"]=function(af)local ap,aq,fK,ai;if v._gui.mainMenu.mode==0 then for a0=1,#fG do if af[5]==0 and ao(af[3],af[4],v._gui.mainMenu.x,v._gui.mainMenu.y+a0*4-3,v._gui.mainMenu.x+v._gui.mainMenu.w-1,v._gui.mainMenu.y+a0*4+2)then fK,ai=pcall(v._gui.mainMenu.MenuAction[a0])af[3],af[4]=0,0;break end end elseif v._gui.mainMenu.mode==1 then for a0=1,#v._gui.mainMenu[1].obj do if af[5]==0 and v._gui.mainMenu[1].obj[a0].type==1 and ao(af[3],af[4],v._gui.mainMenu[1].x+v._gui.mainMenu[1].obj[a0].x,v._gui.mainMenu[1].y+v._gui.mainMenu[1].obj[a0].y,v._gui.mainMenu[1].x+v._gui.mainMenu[1].obj[a0].x+v._gui.mainMenu[1].obj[a0].w-1,v._gui.mainMenu[1].y+v._gui.mainMenu[1].obj[a0].y+v._gui.mainMenu[1].obj[a0].h-1)then fK,ai=pcall(v._gui.mainMenu[1].obj[a0].action)end end elseif v._gui.mainMenu.mode==2 then for a0=1,#v._gui.mainMenu[2].obj do if af[5]==0 and v._gui.mainMenu[2].obj[a0].type==1 and ao(af[3],af[4],v._gui.mainMenu[2].x+v._gui.mainMenu[2].obj[a0].x,v._gui.mainMenu[2].y+v._gui.mainMenu[2].obj[a0].y,v._gui.mainMenu[2].x+v._gui.mainMenu[2].obj[a0].x+v._gui.mainMenu[2].obj[a0].w-1,v._gui.mainMenu[2].y+v._gui.mainMenu[2].obj[a0].y+v._gui.mainMenu[2].obj[a0].h-1)then fK,ai=pcall(v._gui.mainMenu[2].obj[a0].action)end end;for a0=1,#v._gui.mainMenu[2].buff do if af[5]==0 and ao(v._gui.mainMenu[2].x,v._gui.mainMenu[2].y+6+a0*2-2,v._gui.mainMenu[2].x+v._gui.mainMenu[2].w-1,v._gui.mainMenu[2].y+6+a0*2-2)then v._gui.mainMenu[2].targ=a0 end end end;if not fK then error(ai)end end;v._gui.mainMenu.action["key_down"]=function(af)if v._gui.mainMenu.mode==1 then v._gui.mainMenu[1].obj[4].txt=v._function.textInput(af,v._gui.mainMenu[1].obj[4].txt,18)elseif v._gui.mainMenu.mode==2 and v._gui.mainMenu[2].targ then if af[4]==200 and v._gui.mainMenu[2].targ>1 then v._gui.mainMenu[2].targ=v._gui.mainMenu[2].targ-1 elseif af[4]==208 and v._gui.mainMenu[2].targ<#v._gui.mainMenu[2].buff then v._gui.mainMenu[2].targ=v._gui.mainMenu[2].targ+1 end end end;local function fL()local c8,fM,fN,fO,fP,itemLootarray,fQ,fR,cl;local fS=8;local fT=0;while v._data.inGame do X=W;W=0;if not v._data.paused then v._function.UpdatePlayerStats()if Q[v._player.id]["target"]and v._function.getDistanceToId(v._player.id,Q[v._player.id]["target"])>99 then Q[v._player.id]["target"]=nil;v._gui.targetInfoPanel.showTargetInfo=false end;if fS<=0 then fS=8 end;fS=fS-1;if dE>0 then dE=dE-1 end;if Q[v._player.id]["rage"]>0 then v._player.regenMultiplier=0.1;Q[v._player.id]["rage"]=Q[v._player.id]["rage"]-1 else v._player.regenMultiplier=1 end;if Q[v._player.id]["living"]==false then v._data.windowThread="died"v._data.paused=true end;for a0=1,#v._player.quests do if H[v._player.quests[a0][1]]["type"]==3 and v._player.quests[a0][3]==false then v._player.quests[a0][3]=true end end;if Q[v._player.id]["living"]then if Q[v._player.id]["cmp"]<Q[v._player.id]["mmp"]-v._player.manaReg then Q[v._player.id]["cmp"]=Q[v._player.id]["cmp"]+v._player.manaReg else Q[v._player.id]["cmp"]=Q[v._player.id]["mmp"]end;v._function.addHealth(v._player.id,v._player.healthReg)end;for a0=1,#S do if a0~=N.current and S[a0]then for an=#S[a0],1,-1 do if S[a0][an][4]>0 then S[a0][an][4]=S[a0][an][4]-1 else o(S[a0],an)end end end end;if Q[v._player.id]["followers"]then for a0=1,#Q[v._player.id]["followers"]do if not Q[Q[v._player.id]["followers"][a0][2]]["target"]and v._function.getDistanceToId(Q[v._player.id]["followers"][a0][2],v._player.id)>10 then if v._function.getDistanceToId(Q[v._player.id]["followers"][a0][2],v._player.id)>160 then Q[Q[v._player.id]["followers"][a0][2]]["x"]=Q[v._player.id]["x"]+math.random(-10,10)Q[Q[v._player.id]["followers"][a0][2]]["mx"]=Q[Q[v._player.id]["followers"][a0][2]]["x"]else v._function.getClose(Q[v._player.id]["followers"][a0][2],v._player.id,8)end end;if not Q[Q[v._player.id]["followers"][a0][2]]["target"]then v._function.addHealth(Q[v._player.id]["followers"][a0][2],Q[Q[v._player.id]["followers"][a0][2]]["mhp"]*0.01)end end end;for a0=1,#Q do if Q[a0]then if Q[a0]["living"]then if fS==0 then if Q[a0]["rtype"]==4 and v._function.random(1,4)==4 then Q[a0]["mx"]=Q[a0]["sx"]+v._function.random(-8,8)end end;if(Q[a0]["rtype"]==4 or Q[a0]["rtype"]==1)and Q[a0]["target"]and a0~=v._player.id then if F[Q[a0]["id"]]["skill"]then fQ={F[Q[a0]["id"]]["skill"][#F[Q[a0]["id"]]["skill"]][1],F[Q[a0]["id"]]["skill"][#F[Q[a0]["id"]]["skill"]][2]}fR=bT(F[Q[a0]["id"]]["skill"])for cR=1,#fR do if v._function.random(1,100)<=fR[cR][3]then fQ={fR[cR][1],fR[cR][2]}break end end else fQ={1,1}end;v._function.enemySkill(a0,Q[a0]["target"],fQ[1],fQ[2])end;fQ=nil end;if Q[a0]["target"]and not Q[Q[a0]["target"]]["living"]then Q[a0]["target"]=nil end;if Q[a0]["rtype"]==4 then if Q[a0]["сhp"]~=Q[a0]["mhp"]and Q[a0]["living"]and not Q[a0]["target"]then if Q[a0]["chp"]+q(Q[a0]["mhp"]*0.05)<Q[a0]["mhp"]then Q[a0]["chp"]=Q[a0]["chp"]+q(Q[a0]["mhp"]*0.05)else Q[a0]["chp"]=Q[a0]["mhp"]end end;if not Q[a0]["living"]and Q[a0]["resptime"]>0 then Q[a0]["resptime"]=Q[a0]["resptime"]-1 elseif not Q[a0]["living"]and Q[a0]["resptime"]==0 then Q[a0]["chp"]=Q[a0]["mhp"]Q[a0]["x"]=Q[a0]["sx"]Q[a0]["living"]=true end;if Q[a0]["living"]and Q[a0]["target"]and v._function.getDistanceToId(v._player.id,a0)>60 then Q[a0]["target"]=nil;Q[a0]["mx"]=Q[a0]["sx"]end;if Q[a0]["rtype"]==4 and Q[a0]["living"]and F[Q[a0]["id"]]["agr"]==1 then for an=1,#Q do if Q[an]["rtype"]==1 and Q[an]["living"]and v._function.getDistanceToId(an,a0)<=25 then Q[a0]["target"]=an;break end end end end;Q[a0]["cmove"]=true;Q[a0]["ctck"]=true;if a0~=v._player.id and#Q[a0]["effects"]>0 then v._function.updateUnitStats(a0)end;for cf=#Q[a0]["effects"],1,-1 do fO=Q[a0]["effects"][cf]if Q[a0]["living"]and fO~=nil then if K[fO[1]]["visual"]then v._function.effect[K[fO[1]]["visual"]](a0)end;if K[fO[1]]["val"]then c8=K[fO[1]]["val"][fO[3]]end;fN=fO[4]or a0;fM=K[fO[1]]["dur"][fO[3]]fP=K[fO[1]]["type"]if fP=="hpi"then v._function.healUnit(a0,c8/fM)elseif fP=="mpi"then if Q[a0]["cmp"]and Q[a0]["mmp"]then Q[a0]["cmp"]=s(r(Q[a0]["cmp"]+c8/fM,Q[a0]["mmp"]),0)end elseif fP=="hpi%"then Q[a0]["chp"]=r(Q[a0]["chp"]+Q[a0]["mhp"]*c8*0.01,Q[a0]["mhp"])elseif fP=="hpd"then v._function.makeDamage(fN,a0,c8/fM,true)elseif fP=="pdfi%"then Q[a0]["pdef"]=Q[a0]["pdef"]+q(c8/100*Q[a0]["pdef"])elseif fP=="mdfi%"then Q[a0]["mdef"]=Q[a0]["mdef"]+q(c8/100*Q[a0]["mdef"])elseif fP=="stn"then Q[a0]["cmove"]=false;Q[a0]["ctck"]=false elseif fP=="ste"then Q[a0]["cmove"]=false end;if fO~=nil then fO[2]=fO[2]-1;if fO[2]==0 then if v._gui.playerInfoPanel.effectDescription==fO[1]then v._gui.playerInfoPanel.effectDescription=0 end;o(Q[a0]["effects"],cf)end end end end end;if Q[a0]["tlinfo"]and#Q[a0]["tlinfo"]>0 then if Q[a0]["tlinfo"][1]then o(Q[a0]["tlinfo"],1)end end end;if v._data.messageTable1timer>0 then v._data.messageTable1timer=v._data.messageTable1timer-1 end;if bn>0 then bn=bn-1 end;if bq>0 then bq=bq-1 end;local fU=#R;for ae=fU,1,-1 do if R[ae].life==0 then o(R,ae)else R[ae].life=R[ae].life-1 end end;if aR>0 then aR=aR-1 end;if bK and not v._function.checkInventoryisFull()then v._function.addItem(bK[1],bK[2],true)bK=nil end;if Q[v._player.id]["chp"]<Q[v._player.id]["mhp"]/2 or Q[v._player.id]["cmp"]<Q[v._player.id]["mmp"]/2 then for a0=1,#v._player.inventory["bag"]do if v._player.inventory["bag"][a0][1]>0 and v._player.inventory["bag"][a0][2]>0 and G[v._player.inventory["bag"][a0][1]]and Q[v._player.id]["living"]and G[v._player.inventory["bag"][a0][1]]["type"]==7 then if G[v._player.inventory["bag"][a0][1]]["subtype"]==1 and Q[v._player.id]["chp"]<=Q[v._player.id]["mhp"]*G[v._player.inventory["bag"][a0][1]]["props"]["r"]*0.01 then Q[v._player.id]["chp"]=r(Q[v._player.id]["chp"]+Q[v._player.id]["mhp"]*0.01*G[v._player.inventory["bag"][a0][1]]["props"]["ics"],Q[v._player.id]["mhp"])v._player.inventory["bag"][a0][2]=v._player.inventory["bag"][a0][2]-1;break elseif G[v._player.inventory["bag"][a0][1]]["subtype"]==2 and Q[v._player.id]["cmp"]<=Q[v._player.id]["mmp"]*G[v._player.inventory["bag"][a0][1]]["props"]["r"]*0.01 then Q[v._player.id]["cmp"]=r(Q[v._player.id]["cmp"]+Q[v._player.id]["mmp"]*0.01*G[v._player.inventory["bag"][a0][1]]["props"]["ics"],Q[v._player.id]["mmp"])v._player.inventory["bag"][a0][2]=v._player.inventory["bag"][a0][2]-1;break end end end end end;os.sleep(1)end end;local pimg4t=0;local function fV()local fW=0;local fT,b7;while v._data.inGame do if not v._data.paused then if fW==0 then if v._player.pickingUp then Q[v._player.id]["mx"]=Q[v._player.id]["x"]v._player.pckTime=v._player.pckTime-1;if Q[v._player.id]["image"]~=-1 then b4(-1)end end;if v._player.pickingUp and v._player.pckTime==0 and v._player.pckTarget then b4(0)v._player.pickingUp=false;itemLootarray=bT(F[Q[v._player.pckTarget]["id"]]["items"])for fX=1,#itemLootarray do if itemLootarray[fX][1]~=nil and 1000-itemLootarray[fX][2]*10<=v._function.random(1,1000)then if v._function.random(1,15)==5 then itemLootarray[fX][1]=bX(itemLootarray[fX][1])end;v._function.addItem(itemLootarray[fX][1],1,true)break end end;cw(F[Q[v._player.pckTarget]["id"]]["exp"])v._function.addCoins(F[Q[v._player.pckTarget]["id"]]["coins"])Q[v._player.id]["cmove"]=true;Q[v._player.pckTarget]["living"]=false;Q[v._player.pckTarget]["resptime"]=F[Q[v._player.pckTarget]["id"]]["vresp"]if v._player.pckTarget==Q[v._player.id]["target"]then Q[v._player.id]["target"]=nil end end;for a0=1,#v._player.actSkills do if v._player.actSkills[a0]>0 and v._player.skills[v._player.actSkills[a0]][1]>0 and v._player.skills[v._player.actSkills[a0]][2]>0 then v._player.skills[v._player.actSkills[a0]][2]=s(v._player.skills[v._player.actSkills[a0]][2]-1,0)end end;if Q[v._player.id]["targ"]and Q[v._player.id]["targ"][2]~=0 then if Q[v._player.id]["targ"][1]==1 and v._function.getDistanceToId(v._player.id,Q[v._player.id]["targ"][2])<=Q[v._player.id]["targ"][3]then v._function.gatheringAction(Q[v._player.id]["targ"][2])Q[v._player.id]["targ"]=nil elseif Q[v._player.id]["targ"][1]==2 then if v._player.skills[v._player.actSkills[1]]and not v._player.pickingUp and Q[Q[v._player.id]["targ"][2]]and Q[Q[v._player.id]["targ"][2]]["living"]then if Q[v._player.id]["targ"]and v._function.getDistanceToId(v._player.id,Q[v._player.id]["targ"][2])<=Q[v._player.id]["targ"][3]then C=0;v._player.moving=false;v._function.useSkill(Q[v._player.id]["targ"][4]or 1)if Q[v._player.id]["targ"]then Q[v._player.id]["targ"][4]=1 end else v._function.getClose(v._player.id,Q[v._player.id]["targ"][2],Q[v._player.id]["targ"][3])v._player.moving=true end else Q[v._player.id]["targ"]=nil end end end;if Q[v._player.id]["target"]and not Q[Q[v._player.id]["target"]]["living"]then Q[v._player.id]["target"]=nil end;if Q[v._player.id]["image"]==-4 then if pimg4t>=2 then b4(0)pimg4t=0 end;pimg4t=pimg4t+1 end end;if fW>-1 then if v._player.moving and Q[v._player.id]["x"]~=Q[v._player.id]["mx"]then v._function.playerAutoMove(p(Q[v._player.id]["mx"]),9999,3)else v._player.moving=false end;v._player.moveLock=false;if Q[v._player.id]["x"]<=N[N.current].limitL and C<0 then v._player.moveLock=true;b4(0)elseif Q[v._player.id]["x"]>=N[N.current].limitR and C>0 then v._player.moveLock=true;b4(0)end;if not v._player.pickingUp and not v._player.moveLock and C~=0 and Q[v._player.id]["cmove"]then if v._player.moving and Q[v._player.id]["x"]==Q[v._player.id]["mx"]then C=0;Q[v._player.id]["mx"]=math.huge end;Q[v._player.id]["x"]=Q[v._player.id]["x"]+C;A=A+C;B=B+C;if v._function.cim<=3 then b4(-3)elseif v._function.cim>3 and v._function.cim<=6 then b4(0)else b4(-2)end;if v._function.cim>9 then v._function.cim=1 end;v._function.cim=v._function.cim+1 end;if Q[v._player.id]["y"]>=1 then Q[v._player.id]["vy"]=Q[v._player.id]["vy"]-0.15 else Q[v._player.id]["vy"]=0;Q[v._player.id]["y"]=1 end;if Q[v._player.id]["vy"]~=0 then Q[v._player.id]["y"]=Q[v._player.id]["y"]+Q[v._player.id]["vy"]end;for a0=1,#Q do if Q[a0]then if Q[a0]["rtype"]==4 and Q[a0]["living"]and Q[a0]["x"]~=Q[a0]["mx"]and v._function.getDistanceToId(v._player.id,a0)<=256 and not F[Q[a0]["id"]]["cmve"]and Q[a0]["cmove"]then b7=0.25;if Q[a0]["target"]then b7=0.5 end;v._function.moveToward(a0,Q[a0]["mx"],160,b7)end;if Q[a0]["rtype"]==1 and a0~=v._player.id and Q[a0]["living"]and v._function.getDistanceToId(v._player.id,a0)<=256 and Q[a0]["x"]~=Q[a0]["mx"]and not F[Q[a0]["id"]]["cmve"]and Q[a0]["cmove"]then b7=1;v._function.moveToward(a0,Q[a0]["mx"],nil,b7)end end end end end;os.sleep(0.05)if fW==0 then fW=1 else fW=0 end end end;v._function.cim=1;v._player.moveLock=false;local function fY()local fZ=0;while v._data.inGame do if not v._data.stopDrawing then fB()W=W+1 end;os.sleep(0.0000001)end end;local function f_()local af;while v._data.inGame do::g0::af=table.pack(b.pull())if af[1]=="key_down"then if v._data.windowThread=="console"then v._function.gameConsole.action["key_down"](af)elseif v._data.windowThread=="menu"then v._gui.mainMenu.action["key_down"](af)end;if v._data.windowThread==nil and af[4]==v._parameter.keys.openInventory then v._data.paused=true;v._gui.inventory.open()elseif v._data.windowThread=="inventory"and af[4]==v._parameter.keys.closeInventory then v._data.paused=false;v._data.windowThread=nil;v._function.cleanIconImageBuffer()dT=false end;if v._data.windowThread==nil and not v._data.paused then if Q[v._player.id]["cmove"]then if(af[4]==v._parameter.keys.right1 or af[4]==v._parameter.keys.right2)and Q[v._player.id]["x"]<=N[N.current].limitR then Q[v._player.id]["targ"]=nil;v._player.moving=false;if h.isAltDown()then Q[v._player.id]["mx"]=N[N.current].limitR;v._player.moving=true else C=3;b1(v._player.id,2)v._function.keyactionmove=true end;goto g0 elseif(af[4]==v._parameter.keys.left1 or af[4]==v._parameter.keys.left2)and Q[v._player.id]["x"]>=N[N.current].limitL then Q[v._player.id]["targ"]=nil;v._player.moving=false;if h.isAltDown()then Q[v._player.id]["mx"]=N[N.current].limitL;v._player.moving=true else C=-3;b1(v._player.id,1)v._function.keyactionmove=true end;goto g0 end end;if af[4]>=2 and af[4]<=9 then for a0=1,8 do if af[4]==a0+1 then v._function.usePlayerSkill(a0)end end end;if af[4]==v._parameter.keys.interact and Q[v._player.id]["target"]then if Q[Q[v._player.id]["target"]]["rtype"]==2 then if v._function.getDistanceToId(v._player.id,Q[v._player.id]["target"])<=30 then v._gui.NPCDialog.start(Q[v._player.id]["target"])else v._function.getClose(v._player.id,Q[v._player.id]["target"],25)end elseif Q[Q[v._player.id]["target"]]["rtype"]==5 then v._function.gathering()elseif Q[Q[v._player.id]["target"]]["rtype"]==3 and not v._player.pickingUp and v._function.getDistanceToId(v._player.id,Q[v._player.id]["target"])<=10 then if F[Q[Q[v._player.id]["target"]]["id"]]["tlp"]=="r"then v._function.loadWorld(N[N.current].drespawn)elseif type(F[Q[Q[v._player.id]["target"]]["id"]]["tlp"])=="table"then v._function.teleport(F[Q[Q[v._player.id]["target"]]["id"]]["tlp"][2],F[Q[Q[v._player.id]["target"]]["id"]]["tlp"][1])end end end;if af[4]==v._parameter.keys.jump then if Q[v._player.id]["y"]<=1 and not v._player.pickingUp then Q[v._player.id]["vy"]=1.5 end end;if af[4]==v._parameter.keys.spawn then if#Q[v._player.id]["followers"]>0 then v._function.removeFollowers()else v._function.addFollower(1)end end;if af[4]==v._parameter.keys.followerAction then for a0=1,#Q[v._player.id]["followers"]do Q[Q[v._player.id]["followers"][a0][2]]["target"]=Q[v._player.id]["target"]end end;if af[4]==v._parameter.keys.hp then for a0=1,#v._player.inventory["bag"]do if v._player.inventory["bag"][a0][1]>0 and v._player.inventory["bag"][a0][2]>0 and G[v._player.inventory["bag"][a0][1]]["type"]==4 and G[v._player.inventory["bag"][a0][1]]["subtype"]==1 and Q[v._player.id]["lvl"]>=G[v._player.inventory["bag"][a0][1]]["required"]["lvl"]then v._function.addUnitEffect(v._player.id,v._parameter.healthPotionEffectID,G[v._player.inventory["bag"][a0][1]]["lvl"])v._player.inventory["bag"][a0][2]=v._player.inventory["bag"][a0][2]-1;break end end elseif af[4]==v._parameter.keys.mp then for a0=1,#v._player.inventory["bag"]do if v._player.inventory["bag"][a0][1]>0 and v._player.inventory["bag"][a0][2]>0 and G[v._player.inventory["bag"][a0][1]]["type"]==4 and G[v._player.inventory["bag"][a0][1]]["subtype"]==2 and Q[v._player.id]["lvl"]>=G[v._player.inventory["bag"][a0][1]]["required"]["lvl"]then v._function.addUnitEffect(v._player.id,v._parameter.manaPotionEffectID,G[v._player.inventory["bag"][a0][1]]["lvl"])v._player.inventory["bag"][a0][2]=v._player.inventory["bag"][a0][2]-1;break end end end end elseif af[1]=="key_up"then if v._data.windowThread==nil then if(af[4]==v._parameter.keys.right1 or af[4]==v._parameter.keys.right2 or af[4]==v._parameter.keys.left1 or af[4]==v._parameter.keys.left2)and not h.isAltDown()then if not v._player.pickingUp then b4(0)end;v._player.moving=false;C=0 end end elseif af[1]=="touch"then if v._data.windowThread==nil and af[5]==0 and ao(af[3],af[4],v._gui.pauseMenu.buttonX,v._gui.pauseMenu.buttonY,v._gui.pauseMenu.buttonX+2,v._gui.pauseMenu.buttonY+1)then v._data.windowThread="pause"v._data.paused=true elseif af[5]==0 and v._data.windowThread=="pause"and ao(af[3],af[4],v._gui.pauseMenu.buttonX,v._gui.pauseMenu.buttonY,v._gui.pauseMenu.buttonX+2,v._gui.pauseMenu.buttonY+1)then v._data.windowThread=nil;v._data.paused=false end;if v._data.windowThread==nil then if not v._data.paused then if ao(af[3],af[4],v._gui.playerInfoPanel.x,v._gui.playerInfoPanel.y+3,v._gui.playerInfoPanel.x+v._gui.playerInfoPanel.w-1,v._gui.playerInfoPanel.y+3)then di=true else di=false end end;if not v._data.paused then v._gui.playerInfoPanel.action["touch"](af)v._gui.targetInfoPanel.action["touch"](af)v._gui.followerInfo.action["touch"](af)v._gui.qPanel.action["touch"](af)if af[5]==0 then if not ao(af[3],af[4],1,1,t,8)then local g1=false;for a0=1,#Q do if Q[a0]and a0~=v._player.id and Q[a0]["living"]and ao(af[3],af[4],p(Q[a0]["x"])+75-A,49-p(Q[a0]["y"])-2-Q[a0]["height"],p(Q[a0]["x"])+75-A+Q[a0]["width"],49-p(Q[a0]["y"]))then if Q[v._player.id]["target"]==a0 then if d1(Q[v._player.id]["target"],4)then v._function.usePlayerSkill(1)elseif d1(Q[v._player.id]["target"],5)then v._function.gathering()end else Q[v._player.id]["target"]=a0 end;g1=true end end;if not g1 and Q[v._player.id]["target"]~=1 and not v._gui.targetInfoPanel.showTargetInfo then Q[v._player.id]["target"]=nil end end;if ao(af[3],af[4],v._gui.playerInfoPanel.x,v._gui.playerInfoPanel.y,v._gui.playerInfoPanel.x+v._gui.playerInfoPanel.w-1,v._gui.playerInfoPanel.y+v._gui.playerInfoPanel.h-1)then Q[v._player.id]["target"]=v._player.id end end end end;if v._data.windowThread=="pause"then v._gui.pauseMenu.action["touch"](af)elseif v._data.windowThread=="inventory"then v._gui.inventory.action["touch"](af)elseif v._data.windowThread=="dialog"then v._gui.NPCDialog.action["touch"](af)elseif v._data.windowThread=="quests"then v._gui.questsList.action["touch"](af)elseif v._data.windowThread=="console"then v._function.gameConsole.action["touch"](af)elseif v._data.windowThread=="pstats"then v._gui.playerStats.action["touch"](af)elseif v._data.windowThread=="tradeWindow"then v._function.tradew.action["touch"](af)elseif v._data.windowThread=="craftWindow"then v._function.craftw.action["touch"](af)elseif v._data.windowThread=="died"then v._function.ydw.action["touch"](af)elseif v._data.windowThread=="skillsWindow"then v._gui.playerSkills.action["touch"](af)elseif v._data.windowThread=="menu"then v._gui.mainMenu.action["touch"](af)elseif v._data.windowThread=="rewardChoice"then v._gui.rewardChoice.action["touch"](af)end elseif af[1]=="scroll"then if v._data.windowThread=="console"then v._function.gameConsole.action["scroll"](af)end end end end;d.init()k.setResolution(t,u)a1()v._function.initResources()v._gui.mainMenu.open(0)d.create(f_)d.create(fY)d.create(fL)d.create(fV)d.waitForAll()m.setBackground(0x000000)m.setForeground(0xffffff)a.clear()a.setCursor(1,1)io.write("Wirthe16 — Onslaught of the wraiths "..v._function.getVersion())
